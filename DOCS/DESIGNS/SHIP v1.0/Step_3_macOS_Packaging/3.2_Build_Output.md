# Implementation Step 3.2: Build Output Structure

## Implementation Overview
**What We're Building**: A comprehensive specification for the macOS build output structure, including the app bundle architecture, DMG distribution format, file organization, resource management, and all components required for a professional macOS application distribution. This document defines the exact structure, layout, and organization of all build artifacts.

## Implementation Tasks

### Task 3.2.1: Define App Bundle Structure

**What to Build**
- Complete app bundle directory structure
- File organization and hierarchy
- Resource file placement
- Executable structure
- Framework and library organization
- Metadata file placement

**Implementation Details**

**3.2.1.1 App Bundle Directory Hierarchy**
- **Root Structure**: `CuePoint.app/`
  - **Purpose**: Main application bundle container
  - **Type**: Directory (appears as single file in Finder)
  - **Permissions**: 755 (drwxr-xr-x)
  - **Contents**: Contents/ directory, optional Resources/ (legacy)
- **Contents Directory**: `CuePoint.app/Contents/`
  - **Purpose**: Standard macOS app bundle contents location
  - **Type**: Directory
  - **Required**: Yes (mandatory for macOS app bundles)
  - **Contents**: MacOS/, Resources/, Frameworks/, Info.plist, PkgInfo (optional)
- **Executable Directory**: `CuePoint.app/Contents/MacOS/`
  - **Purpose**: Contains the main executable
  - **Type**: Directory
  - **Required**: Yes
  - **Contents**: CuePoint (main executable), optional helper executables
  - **Executable Name**: Must match CFBundleExecutable in Info.plist
- **Resources Directory**: `CuePoint.app/Contents/Resources/`
  - **Purpose**: Contains app resources (icons, data files, etc.)
  - **Type**: Directory
  - **Required**: Yes (even if empty)
  - **Contents**: icon.icns, data files, configuration files, embedded resources
  - **Organization**: Subdirectories for different resource types
- **Frameworks Directory**: `CuePoint.app/Contents/Frameworks/`
  - **Purpose**: Contains embedded frameworks and dynamic libraries
  - **Type**: Directory
  - **Required**: Only if frameworks are embedded
  - **Contents**: Qt frameworks, Python libraries, third-party frameworks
  - **Signing**: All frameworks must be signed individually
- **PlugIns Directory**: `CuePoint.app/Contents/PlugIns/` (optional)
  - **Purpose**: Contains app plugins or extensions
  - **Type**: Directory
  - **Required**: No (only if plugins are used)
  - **Contents**: Plugin bundles, extension bundles
  - **Signing**: All plugins must be signed

**3.2.1.2 Executable Structure**
- **Main Executable**: `CuePoint.app/Contents/MacOS/CuePoint`
  - **Purpose**: Primary application entry point
  - **Type**: Mach-O binary (executable)
  - **Architecture**: Universal2 (arm64 + x86_64) or platform-specific
  - **Permissions**: 755 (executable)
  - **Size**: Varies (typically 5-50 MB for PyInstaller bundles)
  - **Dependencies**: Linked against system frameworks and embedded frameworks
  - **Entry Point**: Main function or PyInstaller bootloader
- **Executable Characteristics**:
  - **Format**: Mach-O universal binary (preferred) or single architecture
  - **Linking**: Dynamic linking to frameworks
  - **Code Signing**: Must be signed with Developer ID
  - **Hardened Runtime**: Should be enabled for notarization
  - **Entitlements**: Minimal, only as required
- **Helper Executables** (if any):
  - **Location**: `CuePoint.app/Contents/MacOS/` or `CuePoint.app/Contents/Helpers/`
  - **Purpose**: Background processes, helper tools, command-line utilities
  - **Signing**: Each helper must be signed individually
  - **Examples**: Update checker, background service, CLI tool

**3.2.1.3 Resource File Organization**
- **Icon Files**: `CuePoint.app/Contents/Resources/icon.icns`
  - **Purpose**: Application icon displayed in Finder, Dock, About dialog
  - **Format**: .icns (macOS icon format)
  - **Sizes**: Multiple resolutions (16x16 to 1024x1024)
  - **Requirements**: High-quality, recognizable, brand-consistent
  - **Alternative Locations**: Legacy Resources/ directory (not recommended)
- **Data Files**: `CuePoint.app/Contents/Resources/data/`
  - **Purpose**: Application data files, templates, default configurations
  - **Organization**: Subdirectories by type (templates/, defaults/, etc.)
  - **Examples**: Default configuration files, template files, sample data
  - **Access**: Read-only from app bundle, writable data in Application Support
- **Configuration Files**: `CuePoint.app/Contents/Resources/config/`
  - **Purpose**: Embedded configuration files, logging configuration
  - **Examples**: logging.yaml, default settings
  - **Access**: Read-only, user settings in Application Support
- **Localization Files**: `CuePoint.app/Contents/Resources/*.lproj/`
  - **Purpose**: Localized strings and resources
  - **Format**: .lproj bundles (directories)
  - **Languages**: en.lproj (English), es.lproj (Spanish), etc.
  - **Contents**: Localized strings, images, nib files
  - **Note**: For v1.0, may be minimal or English-only

**3.2.1.4 Framework Organization**
- **Qt Frameworks**: `CuePoint.app/Contents/Frameworks/Qt*.framework/`
  - **Purpose**: PySide6/Qt runtime frameworks
  - **Structure**: Standard framework bundle structure
  - **Frameworks**: QtCore, QtGui, QtWidgets, QtNetwork (as needed)
  - **Signing**: Each framework must be signed
  - **Architecture**: Must match app architecture (Universal2 preferred)
- **Python Libraries**: `CuePoint.app/Contents/Frameworks/` or embedded in executable
  - **Purpose**: Python standard library and dependencies
  - **Organization**: PyInstaller manages this automatically
  - **Location**: May be in Frameworks/ or embedded in executable (one-file mode)
  - **Signing**: All Python libraries must be signed if separate
- **Third-Party Frameworks**: `CuePoint.app/Contents/Frameworks/`
  - **Purpose**: External frameworks required by the app
  - **Examples**: System frameworks (usually linked, not embedded)
  - **Signing**: Must be signed if embedded
  - **Note**: Prefer system frameworks over embedding when possible

**3.2.1.5 Metadata Files**
- **Info.plist**: `CuePoint.app/Contents/Info.plist`
  - **Purpose**: Application metadata and configuration
  - **Format**: XML property list
  - **Required**: Yes (mandatory)
  - **Contents**: Bundle identifier, version, display name, system requirements, etc.
  - **Generation**: From template with version injection
  - **Validation**: Must be valid XML, all required keys present
- **PkgInfo**: `CuePoint.app/Contents/PkgInfo` (optional)
  - **Purpose**: Legacy package type identifier
  - **Format**: 8-character string (e.g., "APPL????")
  - **Required**: No (legacy, but some tools expect it)
  - **Content**: "APPL" + 4-character creator code
- **CodeResources**: `CuePoint.app/Contents/_CodeSignature/CodeResources`
  - **Purpose**: Code signing resource manifest
  - **Format**: XML property list
  - **Required**: Yes (created automatically during signing)
  - **Contents**: Hashes of all files in bundle
  - **Generation**: Automatic by codesign tool
  - **Validation**: Verified during code signing

**3.2.1.6 File Permissions and Ownership**
- **Directory Permissions**: 755 (drwxr-xr-x)
  - **Rationale**: Owner can read/write/execute, others can read/execute
  - **Application**: All directories in app bundle
  - **Exceptions**: None (standard macOS permissions)
- **Executable Permissions**: 755 (-rwxr-xr-x)
  - **Rationale**: Executable by owner and others
  - **Application**: All executable files
  - **Verification**: `chmod +x` if needed
- **Resource Permissions**: 644 (-rw-r--r--)
  - **Rationale**: Readable by all, writable only by owner
  - **Application**: Data files, configuration files, resources
  - **Exceptions**: Executable resources (755)
- **Ownership**: Should match build user
  - **Rationale**: Consistent ownership for signing
  - **Application**: All files in bundle
  - **CI/CD**: Usually root or build user

### Task 3.2.2: Define DMG Distribution Format

**What to Build**
- DMG file structure and format
- DMG layout and visual design
- DMG compression and optimization
- DMG metadata and properties
- DMG creation automation

**Implementation Details**

**3.2.2.1 DMG File Format**
- **Format**: UDZO (Universal Disk Image, compressed)
  - **Purpose**: Compressed read-only disk image
  - **Advantages**: Smaller file size, faster download, read-only (prevents modification)
  - **Alternatives**: UDRW (read-write, larger), UDBZ (better compression, slower)
  - **Recommendation**: UDZO for distribution (best balance)
- **File Extension**: `.dmg`
- **File Naming**: `CuePoint-vX.Y.Z-macos-universal.dmg`
  - **Format**: Product-Version-Platform-Architecture.dmg
  - **Example**: `CuePoint-v1.0.0-macos-universal.dmg`
  - **Rationale**: Clear identification, version tracking, platform indication
- **File Size**: Typically 50-200 MB (depends on app size and compression)
- **Compression Level**: Maximum (zlib level 9)
  - **Rationale**: Minimize download size
  - **Trade-off**: Slightly slower creation, much smaller file
  - **Command**: `hdiutil convert -format UDZO -imagekey zlib-level=9`

**3.2.2.2 DMG Volume Structure**
- **Volume Name**: "CuePoint"
  - **Purpose**: Name displayed when DMG is mounted
  - **Format**: Simple, brand-consistent name
  - **Display**: Shown in Finder sidebar and window title
- **Volume Contents**:
  - **CuePoint.app**: Main application bundle (required)
  - **Applications**: Symlink to /Applications folder (required)
  - **README.txt** or **README.rtf**: Installation instructions (optional but recommended)
  - **Background Image**: Custom background (optional, for polish)
- **Volume Layout**:
  - **Window Size**: Typically 600x400 to 800x500 pixels
  - **Icon Size**: 72x72 or 128x128 pixels (standard)
  - **Grid Spacing**: Standard macOS grid
  - **View Options**: Icon view (standard), optional list view
- **Volume Properties**:
  - **Read-Only**: Yes (prevents accidental modification)
  - **Case-Sensitive**: No (standard macOS)
  - **Journaled**: Yes (HFS+ journaling enabled)

**3.2.2.3 DMG Visual Layout**
- **Layout Design Principles**:
  - **Clarity**: Clear indication of what to do
  - **Simplicity**: Minimal, uncluttered interface
  - **Branding**: Consistent with app branding
  - **Accessibility**: Works with screen readers, keyboard navigation
- **Icon Positioning**:
  - **App Icon**: Left side, centered vertically
  - **Applications Link**: Right side, centered vertically
  - **Visual Flow**: Left-to-right (drag app to Applications)
  - **Spacing**: Adequate space between icons (prevents accidental drops)
- **Background Image** (Optional):
  - **Purpose**: Branding, visual polish, installation guidance
  - **Format**: PNG or PDF (vector preferred)
  - **Size**: Match window size (600x400 to 800x500)
  - **Content**: Brand colors, installation instructions, app logo
  - **Placement**: Behind icons, non-intrusive
  - **Accessibility**: Ensure sufficient contrast for text
- **Window Configuration**:
  - **Position**: Centered on screen (default)
  - **Size**: Appropriate for content (not too large, not too small)
  - **Toolbar**: Hidden (cleaner appearance)
  - **Status Bar**: Hidden (cleaner appearance)
  - **View Options**: Icon view, standard icon size

**3.2.2.4 DMG Contents Specification**
- **Application Bundle**: `CuePoint.app`
  - **Location**: Root of DMG volume
  - **State**: Signed and notarized (ready for distribution)
  - **Size**: Full app bundle size (typically 50-150 MB)
  - **Verification**: Must be signed and notarized before DMG creation
- **Applications Symlink**: `Applications -> /Applications`
  - **Purpose**: Easy drag-to-install target
  - **Type**: Symbolic link
  - **Target**: `/Applications` (system Applications folder)
  - **Creation**: `ln -s /Applications Applications`
  - **Positioning**: Right side of DMG window
- **README File**: `README.txt` or `README.rtf`
  - **Purpose**: Installation instructions, system requirements, support information
  - **Format**: Plain text (.txt) or Rich Text Format (.rtf)
  - **Content**: Installation steps, system requirements, support links, license information
  - **Positioning**: Bottom of DMG window or separate area
  - **Visibility**: Should be easily readable
- **License File** (Optional): `LICENSE.txt`
  - **Purpose**: Software license information
  - **Format**: Plain text
  - **Content**: Full license text
  - **Positioning**: Bottom of DMG window

**3.2.2.5 DMG Creation Process**
- **Step 1: Prepare Contents**
  - Verify app bundle is signed and notarized
  - Create temporary directory for DMG contents
  - Copy app bundle to temporary directory
  - Create Applications symlink
  - Add README and other files
- **Step 2: Create Initial DMG**
  - Create read-write DMG (UDRW format)
  - Mount DMG
  - Copy contents to mounted volume
  - Configure layout (icon positions, background, window size)
  - Unmount DMG
- **Step 3: Convert to Final Format**
  - Convert UDRW DMG to UDZO (compressed, read-only)
  - Apply maximum compression
  - Verify DMG integrity
  - Set appropriate file permissions
- **Step 4: Sign and Notarize DMG**
  - Sign DMG (if not already signed)
  - Submit DMG for notarization
  - Wait for approval
  - Staple notarization ticket
  - Verify notarization

**3.2.2.6 DMG Optimization**
- **Compression Optimization**:
  - Use maximum compression (zlib level 9)
  - Remove unnecessary files before DMG creation
  - Optimize app bundle size (exclude unused resources)
  - Consider UPX compression for executables (if compatible)
- **Size Optimization**:
  - Remove debug symbols (if not needed)
  - Strip unused code and resources
  - Use efficient resource formats
  - Minimize embedded frameworks
- **Performance Optimization**:
  - Optimize DMG structure for fast mounting
  - Minimize file fragmentation
  - Use efficient file system layout
  - Test DMG mounting speed

### Task 3.2.3: Define File Organization Standards

**What to Build**
- File naming conventions
- Directory structure standards
- Resource organization patterns
- Configuration file placement
- Data file management

**Implementation Details**

**3.2.3.1 File Naming Conventions**
- **Application Bundle**: `CuePoint.app`
  - **Format**: ProductName.app
  - **Case**: PascalCase (first letter uppercase)
  - **Spaces**: No spaces (use CamelCase)
  - **Special Characters**: Avoid special characters
- **Executable**: `CuePoint`
  - **Format**: ProductName (no extension)
  - **Case**: PascalCase
  - **Must Match**: CFBundleExecutable in Info.plist
- **Resources**: Lowercase with underscores or hyphens
  - **Examples**: `icon.icns`, `default_config.yaml`, `app_background.png`
  - **Rationale**: Cross-platform compatibility, case-insensitive file systems
- **Frameworks**: Standard framework naming
  - **Format**: `FrameworkName.framework`
  - **Examples**: `QtCore.framework`, `QtGui.framework`
  - **Case**: PascalCase for framework name

**3.2.3.2 Directory Structure Standards**
- **Standard macOS App Bundle Structure**:
  ```
  CuePoint.app/
  ├── Contents/
  │   ├── MacOS/
  │   │   └── CuePoint
  │   ├── Resources/
  │   │   ├── icon.icns
  │   │   ├── config/
  │   │   │   └── logging.yaml
  │   │   └── data/
  │   ├── Frameworks/
  │   │   └── (Qt frameworks, etc.)
  │   ├── Info.plist
  │   └── _CodeSignature/
  │       └── CodeResources
  └── (optional legacy Resources/)
  ```
- **Resource Organization**:
  - **Icons**: `Resources/icon.icns`
  - **Configuration**: `Resources/config/`
  - **Data Files**: `Resources/data/`
  - **Templates**: `Resources/templates/`
  - **Localization**: `Resources/*.lproj/`
- **Framework Organization**:
  - **Qt Frameworks**: `Frameworks/Qt*.framework/`
  - **Python Libraries**: Embedded or `Frameworks/`
  - **Third-Party**: `Frameworks/` with clear naming

**3.2.3.3 Configuration File Management**
- **Embedded Configuration**: `Resources/config/`
  - **Purpose**: Default configurations, read-only
  - **Examples**: `logging.yaml`, `default_settings.yaml`
  - **Access**: Read from bundle, never write to bundle
- **User Configuration**: `~/Library/Application Support/CuePoint/`
  - **Purpose**: User-specific settings, writable
  - **Location**: Application Support directory
  - **Access**: Read/write by application
  - **Separation**: Clear separation from embedded config
- **Runtime Configuration**: Environment-based
  - **Purpose**: Development vs. production settings
  - **Location**: Environment variables or config files
  - **Access**: Application reads at startup

**3.2.3.4 Data File Management**
- **Embedded Data**: `Resources/data/`
  - **Purpose**: Default data, templates, samples
  - **Access**: Read-only from bundle
  - **Examples**: Sample files, template files, default data
- **User Data**: `~/Library/Application Support/CuePoint/`
  - **Purpose**: User-generated data, application data
  - **Access**: Read/write by application
  - **Organization**: Subdirectories by data type
- **Cache Data**: `~/Library/Caches/CuePoint/`
  - **Purpose**: Temporary cache, can be deleted
  - **Access**: Read/write by application
  - **Cleanup**: Application manages cache size
- **Log Files**: `~/Library/Logs/CuePoint/`
  - **Purpose**: Application logs
  - **Access**: Write by application, read by user/admin
  - **Rotation**: Automatic log rotation

### Task 3.2.4: Define Build Output Validation

**What to Build**
- App bundle validation procedures
- DMG validation procedures
- File integrity checks
- Structure verification
- Automated validation scripts

**Implementation Details**

**3.2.4.1 App Bundle Validation**
- **Structure Validation**:
  - Verify Contents/ directory exists
  - Verify MacOS/ directory exists
  - Verify Resources/ directory exists
  - Verify Info.plist exists
  - Verify executable exists and matches Info.plist
- **File Validation**:
  - Verify all required files present
  - Verify file permissions correct
  - Verify file sizes reasonable
  - Verify no broken symlinks
- **Metadata Validation**:
  - Verify Info.plist is valid XML
  - Verify all required keys present
  - Verify version information correct
  - Verify bundle identifier correct
- **Signing Validation**:
  - Verify app bundle is signed
  - Verify all nested items signed
  - Verify signing identity correct
  - Verify code signature valid

**3.2.4.2 DMG Validation**
- **File Validation**:
  - Verify DMG file exists
  - Verify DMG file size reasonable
  - Verify DMG format correct (UDZO)
  - Verify DMG can be mounted
- **Contents Validation**:
  - Verify app bundle present in DMG
  - Verify Applications symlink present
  - Verify README present (if included)
  - Verify no extra files
- **Layout Validation**:
  - Verify icon positions correct
  - Verify window size appropriate
  - Verify background image present (if used)
  - Verify visual layout correct
- **Notarization Validation**:
  - Verify DMG is notarized
  - Verify notarization ticket stapled
  - Verify Gatekeeper assessment passes

**3.2.4.3 Automated Validation Scripts**
- **Script**: `scripts/validate_artifacts.py`
  - **Purpose**: Comprehensive artifact validation
  - **Checks**: Structure, files, metadata, signing, notarization
  - **Output**: Detailed validation report
  - **Integration**: Called in CI/CD pipeline
- **Script**: `scripts/validate_bundle_structure.py`
  - **Purpose**: App bundle structure validation
  - **Checks**: Directory structure, file presence, permissions
  - **Output**: Structure validation report
- **Script**: `scripts/validate_dmg.py`
  - **Purpose**: DMG validation
  - **Checks**: DMG format, contents, layout, notarization
  - **Output**: DMG validation report

### Task 3.2.5: Define Build Output Optimization

**What to Build**
- Size optimization strategies
- Performance optimization strategies
- Resource optimization techniques
- Build time optimization
- Distribution optimization

**Implementation Details**

**3.2.5.1 Size Optimization**
- **App Bundle Size Reduction**:
  - Exclude unused dependencies
  - Remove debug symbols (strip)
  - Compress resources where possible
  - Use efficient resource formats
  - Minimize embedded frameworks
- **DMG Size Reduction**:
  - Maximum compression (UDZO level 9)
  - Remove unnecessary files
  - Optimize app bundle before DMG creation
  - Consider UPX compression (if compatible)
- **Target Sizes**:
  - App Bundle: < 150 MB (reasonable for Qt app)
  - DMG: < 100 MB (compressed, download-friendly)
  - Total: Minimize while maintaining functionality

**3.2.5.2 Performance Optimization**
- **Startup Performance**:
  - Minimize embedded resources loaded at startup
  - Optimize Python import paths
  - Lazy load heavy dependencies
  - Cache compiled Python bytecode
- **Runtime Performance**:
  - Optimize resource access patterns
  - Minimize file system operations
  - Cache frequently accessed data
  - Use efficient data structures
- **DMG Performance**:
  - Optimize DMG structure for fast mounting
  - Minimize file fragmentation
  - Use efficient file system layout

**3.2.5.3 Resource Optimization**
- **Icon Optimization**:
  - Use efficient .icns format
  - Include only necessary sizes
  - Optimize image compression
  - Remove unused icon variants
- **Image Optimization**:
  - Use appropriate formats (PNG, JPEG, PDF)
  - Compress images appropriately
  - Remove unused images
  - Optimize for display size
- **Data File Optimization**:
  - Minimize embedded data files
  - Use efficient data formats
  - Compress large data files
  - Remove unused data files

## Implementation Checklist

### App Bundle Structure
- [ ] Define complete directory structure
- [ ] Define file organization
- [ ] Define resource placement
- [ ] Define framework organization
- [ ] Create structure validation

### DMG Format
- [ ] Define DMG format and compression
- [ ] Define DMG layout and design
- [ ] Define DMG contents
- [ ] Create DMG creation automation
- [ ] Create DMG validation

### File Organization
- [ ] Define naming conventions
- [ ] Define directory standards
- [ ] Define resource organization
- [ ] Define configuration management
- [ ] Define data file management

### Validation
- [ ] Create app bundle validation
- [ ] Create DMG validation
- [ ] Create automated validation scripts
- [ ] Integrate validation in CI/CD

### Optimization
- [ ] Define size optimization strategies
- [ ] Define performance optimization
- [ ] Define resource optimization
- [ ] Implement optimizations

## Files to Create/Modify

### New Files
1. `DOCS/DESIGNS/SHIP v1.0/Step_3_macOS_Packaging/3.2_Build_Output.md` - This document
2. `scripts/validate_bundle_structure.py` - Bundle structure validation
3. `scripts/validate_dmg.py` - DMG validation

### Files to Modify
1. `build/pyinstaller.spec` - App bundle structure configuration
2. `scripts/create_dmg.sh` - DMG creation with proper layout
3. `DOCS/DESIGNS/SHIP v1.0/Step_3_macOS_Packaging/README.md` - Add reference

## Implementation Dependencies

### Prerequisites
- Step 2: Build System (provides build infrastructure)
- Step 3.1: Goals (defines requirements)
- PyInstaller configured and working

### Enables
- Step 3.3: Bundle Identity (uses app bundle structure)
- Step 3.4: Signing (signs app bundle)
- Step 3.5: Notarization (notarizes DMG)

## Success Criteria

### App Bundle
- ✅ Proper macOS app bundle structure
- ✅ All required directories present
- ✅ All required files present
- ✅ Correct file permissions
- ✅ Valid Info.plist

### DMG
- ✅ Proper DMG format (UDZO)
- ✅ Correct layout and design
- ✅ All required contents present
- ✅ Proper compression
- ✅ Professional appearance

### Validation
- ✅ Automated validation scripts
- ✅ Validation integrated in CI/CD
- ✅ All validations pass
- ✅ Clear validation reports

### Optimization
- ✅ Reasonable file sizes
- ✅ Good performance
- ✅ Efficient resource usage
- ✅ Fast build times

## Next Implementation Steps

After completing Step 3.2:
1. **Step 3.3**: Bundle Identity (configures metadata in app bundle)
2. **Step 3.4**: Signing (signs the app bundle)
3. **Step 3.5**: Notarization (notarizes the DMG)

## Detailed Implementation Guidance

### App Bundle Structure Example

**Complete Structure**:
```
CuePoint.app/
├── Contents/
│   ├── MacOS/
│   │   └── CuePoint                    # Main executable
│   ├── Resources/
│   │   ├── icon.icns                  # App icon
│   │   ├── config/
│   │   │   └── logging.yaml           # Logging config
│   │   └── data/                      # Embedded data (if any)
│   ├── Frameworks/
│   │   ├── QtCore.framework/          # Qt frameworks
│   │   ├── QtGui.framework/
│   │   └── QtWidgets.framework/
│   ├── Info.plist                     # Bundle metadata
│   └── _CodeSignature/
│       └── CodeResources              # Code signing manifest
```

### DMG Layout Example

**Visual Layout**:
```
┌─────────────────────────────────────┐
│  CuePoint                           │  ← Window title
├─────────────────────────────────────┤
│                                     │
│  [CuePoint.app]    [Applications]  │  ← Icons
│                                     │
│                                     │
│  README.txt                         │  ← Instructions
└─────────────────────────────────────┘
```

**Icon Positions**:
- CuePoint.app: (120, 205) pixels from top-left
- Applications: (380, 205) pixels from top-left
- Window size: 600x400 pixels

### Validation Script Example

```python
#!/usr/bin/env python3
"""Validate app bundle structure"""

import sys
from pathlib import Path

def validate_bundle_structure(app_path):
    """Validate app bundle structure"""
    app = Path(app_path)
    
    # Check required directories
    required_dirs = [
        'Contents',
        'Contents/MacOS',
        'Contents/Resources',
    ]
    
    for dir_path in required_dirs:
        if not (app / dir_path).exists():
            print(f"ERROR: Missing directory: {dir_path}")
            return False
    
    # Check required files
    required_files = [
        'Contents/Info.plist',
        'Contents/MacOS/CuePoint',
    ]
    
    for file_path in required_files:
        if not (app / file_path).exists():
            print(f"ERROR: Missing file: {file_path}")
            return False
    
    print("Bundle structure validation passed")
    return True

if __name__ == '__main__':
    app_path = sys.argv[1] if len(sys.argv) > 1 else 'dist/CuePoint.app'
    if not validate_bundle_structure(app_path):
        sys.exit(1)
```

## Advanced Implementation Details

### App Bundle Structure Deep Dive

**Complete Directory Analysis**:
- **Contents/**: Required root directory for all macOS app bundles
  - **Purpose**: Standard location for all app bundle contents
  - **History**: Introduced in macOS for better organization
  - **Alternatives**: Legacy Resources/ at root (deprecated)
  - **Validation**: Must exist, must be directory
- **MacOS/**: Executable directory
  - **Naming**: "MacOS" (capital OS) is correct, not "macOS"
  - **Purpose**: Contains executable files
  - **Contents**: Main executable, helper executables
  - **Permissions**: Executables must have execute permission (755)
- **Resources/**: Resource files directory
  - **Purpose**: Contains app resources (icons, data, configs)
  - **Organization**: Can have subdirectories for organization
  - **Access**: Read-only from app bundle
  - **Size**: Keep resources minimal (affects app size)
- **Frameworks/**: Embedded frameworks directory
  - **Purpose**: Contains dynamic frameworks
  - **Structure**: Each framework is a .framework bundle
  - **Signing**: Each framework must be signed
  - **Architecture**: Must match app architecture

**File Permission Analysis**:
- **Directory Permissions**: 755 (drwxr-xr-x)
  - **Owner**: Read, write, execute (rwx)
  - **Group**: Read, execute (r-x)
  - **Others**: Read, execute (r-x)
  - **Rationale**: Owner can modify, others can read/execute
- **Executable Permissions**: 755 (-rwxr-xr-x)
  - **Owner**: Read, write, execute (rwx)
  - **Group**: Read, execute (r-x)
  - **Others**: Read, execute (r-x)
  - **Rationale**: Executable by all, writable only by owner
- **Resource Permissions**: 644 (-rw-r--r--)
  - **Owner**: Read, write (rw-)
  - **Group**: Read (r--)
  - **Others**: Read (r--)
  - **Rationale**: Readable by all, writable only by owner

### DMG Creation Deep Dive

**DMG Creation Process Detailed**:
1. **Preparation Phase**:
   - Verify app bundle is complete and signed
   - Create temporary directory for DMG contents
   - Copy app bundle to temporary directory
   - Create Applications symlink
   - Add README and other files
   - Prepare background image (if used)
2. **Initial DMG Creation**:
   - Create read-write DMG (UDRW format)
   - Size: Slightly larger than contents (for layout)
   - Format: HFS+ file system
   - Volume name: "CuePoint"
3. **Layout Configuration**:
   - Mount DMG
   - Configure window size and position
   - Position icons (app and Applications)
   - Set background image (if used)
   - Configure view options (icon view, size, etc.)
   - Unmount DMG
4. **Final DMG Creation**:
   - Convert UDRW to UDZO (compressed, read-only)
   - Apply maximum compression
   - Set volume properties
   - Verify DMG integrity

**DMG Layout Configuration Script**:
```bash
#!/bin/bash
# Configure DMG layout with AppleScript

DMG_PATH="$1"
VOLUME_NAME="CuePoint"

# Mount DMG
MOUNT_POINT="/Volumes/$VOLUME_NAME"
hdiutil attach "$DMG_PATH" -mountpoint "$MOUNT_POINT"

# Configure layout with AppleScript
osascript <<EOF
tell application "Finder"
    tell disk "$VOLUME_NAME"
        open
        set current view of container window to icon view
        set toolbar visible of container window to false
        set statusbar visible of container window to false
        set bounds of container window to {400, 100, 900, 420}
        
        set view options of container window to icon view options
        set icon size of view options to 72
        
        -- Position CuePoint.app
        set position of item "CuePoint.app" to {120, 205}
        
        -- Position Applications symlink
        set position of item "Applications" to {380, 205}
        
        -- Update
        close
        open
        update without registering applications
        delay 1
    end tell
end tell
EOF

# Unmount
hdiutil detach "$MOUNT_POINT"
```

**DMG Optimization Techniques**:
- **Compression**: Use maximum compression (zlib level 9)
  - **Trade-off**: Slower creation, much smaller file
  - **Benefit**: Faster downloads, less storage
  - **Command**: `hdiutil convert -format UDZO -imagekey zlib-level=9`
- **File System**: Use HFS+ (standard for DMG)
  - **Alternative**: APFS (newer, but less compatible)
  - **Recommendation**: HFS+ for maximum compatibility
- **Size Optimization**: Minimize app bundle before DMG
  - Remove debug symbols
  - Strip unused code
  - Compress resources
  - Exclude unnecessary files

### Resource Management Deep Dive

**Resource File Organization**:
- **Icons**: `Resources/icon.icns`
  - **Format**: .icns (macOS icon format)
  - **Sizes**: Multiple resolutions embedded
  - **Generation**: From high-resolution source (1024x1024 PNG)
  - **Tool**: `iconutil` or online converters
- **Configuration Files**: `Resources/config/`
  - **Purpose**: Default configurations, read-only
  - **Examples**: logging.yaml, default settings
  - **Access**: Read from bundle, never write
  - **User Override**: User settings in Application Support
- **Data Files**: `Resources/data/`
  - **Purpose**: Embedded data, templates, samples
  - **Examples**: Sample files, template files
  - **Access**: Read-only from bundle
  - **User Data**: Separate location (Application Support)

**Resource Access Patterns**:
```python
# Access embedded resources
import sys
from pathlib import Path

def get_resource_path(relative_path):
    """Get path to embedded resource"""
    if getattr(sys, 'frozen', False):
        # Running as bundled app
        base_path = Path(sys._MEIPASS)
    else:
        # Running as script
        base_path = Path(__file__).parent.parent
    
    return base_path / 'Resources' / relative_path

# Usage
icon_path = get_resource_path('icon.icns')
config_path = get_resource_path('config/logging.yaml')
```

### Build Output Validation Deep Dive

**Comprehensive Validation Script**:
```python
#!/usr/bin/env python3
"""Comprehensive app bundle and DMG validation"""

import plistlib
import subprocess
import sys
from pathlib import Path

def validate_app_bundle(app_path):
    """Comprehensive app bundle validation"""
    app = Path(app_path)
    errors = []
    warnings = []
    
    # Structure validation
    required_dirs = ['Contents', 'Contents/MacOS', 'Contents/Resources']
    for dir_path in required_dirs:
        if not (app / dir_path).exists():
            errors.append(f"Missing directory: {dir_path}")
    
    # File validation
    required_files = [
        'Contents/Info.plist',
        'Contents/MacOS/CuePoint',
    ]
    for file_path in required_files:
        if not (app / file_path).exists():
            errors.append(f"Missing file: {file_path}")
    
    # Info.plist validation
    info_plist = app / 'Contents/Info.plist'
    if info_plist.exists():
        with open(info_plist, 'rb') as f:
            plist = plistlib.load(f)
        
        # Check required keys
        required_keys = [
            'CFBundleIdentifier',
            'CFBundleName',
            'CFBundleExecutable',
            'CFBundleShortVersionString',
            'CFBundleVersion',
        ]
        for key in required_keys:
            if key not in plist:
                errors.append(f"Missing Info.plist key: {key}")
        
        # Check executable matches
        executable_name = plist.get('CFBundleExecutable')
        executable_path = app / 'Contents/MacOS' / executable_name
        if not executable_path.exists():
            errors.append(f"Executable not found: {executable_path}")
    
    # Permission validation
    exe = app / 'Contents/MacOS/CuePoint'
    if exe.exists():
        stat = exe.stat()
        if not (stat.st_mode & 0o111):  # Check execute bit
            errors.append("Executable does not have execute permission")
    
    return len(errors) == 0, errors, warnings

def validate_dmg(dmg_path):
    """Comprehensive DMG validation"""
    dmg = Path(dmg_path)
    errors = []
    
    if not dmg.exists():
        errors.append(f"DMG not found: {dmg_path}")
        return False, errors
    
    # Try to mount DMG
    try:
        result = subprocess.run(
            ['hdiutil', 'attach', str(dmg), '-nobrowse', '-quiet'],
            capture_output=True,
            text=True,
            timeout=30
        )
        
        if result.returncode != 0:
            errors.append(f"Failed to mount DMG: {result.stderr}")
            return False, errors
        
        # Parse mount point
        mount_point = None
        for line in result.stdout.split('\n'):
            if '/Volumes/' in line:
                mount_point = line.split()[-1]
                break
        
        if mount_point:
            # Check contents
            app_in_dmg = Path(mount_point) / 'CuePoint.app'
            if not app_in_dmg.exists():
                errors.append("CuePoint.app not found in DMG")
            
            apps_link = Path(mount_point) / 'Applications'
            if not apps_link.exists():
                warnings.append("Applications symlink not found in DMG")
            
            # Unmount
            subprocess.run(['hdiutil', 'detach', mount_point, '-quiet'], check=False)
    
    except Exception as e:
        errors.append(f"DMG validation error: {e}")
    
    return len(errors) == 0, errors

if __name__ == '__main__':
    # Validate app bundle
    app_path = 'dist/CuePoint.app'
    if Path(app_path).exists():
        valid, errors, warnings = validate_app_bundle(app_path)
        if not valid:
            print("App bundle validation failed:")
            for error in errors:
                print(f"  {error}")
            sys.exit(1)
        if warnings:
            print("App bundle validation warnings:")
            for warning in warnings:
                print(f"  {warning}")
    
    # Validate DMG
    dmg_path = 'dist/CuePoint-v*.dmg'
    dmgs = list(Path('dist').glob('CuePoint-v*.dmg'))
    if dmgs:
        valid, errors = validate_dmg(dmgs[0])
        if not valid:
            print("DMG validation failed:")
            for error in errors:
                print(f"  {error}")
            sys.exit(1)
    
    print("All validations passed")
```

## References

- Main document: `../03_macOS_Packaging_Signing_Notarization.md`
- Related: Step 2 (Build System), Step 3.1 (Goals)
- Apple Bundle Programming Guide: https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/
- PyInstaller Documentation: https://pyinstaller.org/
- DMG Creation Guide: https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/
