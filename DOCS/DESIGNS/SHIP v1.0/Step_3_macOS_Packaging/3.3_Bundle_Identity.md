# Implementation Step 3.3: Bundle Identity and Metadata

## Implementation Overview
**What We're Building**: A comprehensive bundle identity and metadata management system that ensures consistent, correct, and complete bundle identification across all macOS build artifacts. This includes bundle identifiers, version information, display names, system requirements, entitlements, and all metadata required for proper app identification, signing, notarization, and distribution.

## Implementation Tasks

### Task 3.3.1: Define Bundle Identifier System

**What to Build**
- Bundle identifier definition and format
- Bundle identifier consistency enforcement
- Bundle identifier validation
- Bundle identifier usage across components
- Bundle identifier documentation

**Implementation Details**

**3.3.1.1 Bundle Identifier Format**
- **Format**: Reverse domain name notation
- **Pattern**: `com.{organization}.{product}`
- **Current Value**: `com.stuchain.cuepoint`
- **Components**:
  - **Top-level domain**: `com` (commercial)
  - **Organization**: `stuchain` (organization identifier)
  - **Product**: `cuepoint` (product identifier, lowercase)
- **Rules**:
  - Must be unique across all apps
  - Must be consistent across all builds
  - Must not change between versions
  - Must use lowercase letters, numbers, hyphens, periods
  - Must start and end with alphanumeric character
  - Maximum length: 255 characters (practical limit: ~100)
- **Validation**:
  - Pattern: `^[a-z][a-z0-9.-]*[a-z0-9]$`
  - Uniqueness: Check against existing apps
  - Consistency: Verify across all metadata files
- **Rationale**:
  - Reverse domain ensures uniqueness
  - Consistent format across platforms
  - Easy to identify organization and product
  - Standard macOS/iOS convention

**3.3.1.2 Bundle Identifier Usage**
- **Info.plist**: `CFBundleIdentifier` key
  - **Location**: `CuePoint.app/Contents/Info.plist`
  - **Key**: `CFBundleIdentifier`
  - **Value**: `com.stuchain.cuepoint`
  - **Required**: Yes (mandatory)
  - **Format**: String
- **PyInstaller Spec**: Bundle identifier configuration
  - **Location**: `build/pyinstaller.spec`
  - **Parameter**: `bundle_identifier='com.stuchain.cuepoint'`
  - **Usage**: Passed to BUNDLE() constructor
  - **Validation**: Must match Info.plist
- **Code Signing**: Signing identity includes bundle ID
  - **Location**: Embedded in code signature
  - **Usage**: Gatekeeper uses for app identification
  - **Validation**: Must match Info.plist exactly
- **Notarization**: Bundle ID in notarization submission
  - **Location**: Notarization ticket metadata
  - **Usage**: Apple uses for app tracking
  - **Validation**: Must match Info.plist exactly
- **Update System**: Bundle ID for update identification
  - **Location**: Update feed metadata
  - **Usage**: Sparkle uses to identify app
  - **Validation**: Must match installed app

**3.3.1.3 Bundle Identifier Consistency**
- **Consistency Requirements**:
  - Info.plist: `CFBundleIdentifier` = `com.stuchain.cuepoint`
  - PyInstaller spec: `bundle_identifier` = `com.stuchain.cuepoint`
  - Code signature: Embedded bundle ID = `com.stuchain.cuepoint`
  - All metadata: Bundle ID references = `com.stuchain.cuepoint`
- **Validation Script**: `scripts/validate_bundle_id.py`
  - **Purpose**: Verify bundle ID consistency
  - **Checks**: Info.plist, spec file, code signature
  - **Output**: Consistency report
  - **Integration**: Called in CI before build
- **Failure Handling**:
  - Inconsistent bundle ID → Build fails
  - Missing bundle ID → Build fails
  - Invalid format → Build fails
  - Clear error messages with location of inconsistency

**3.3.1.4 Bundle Identifier Stability**
- **Stability Requirement**: Bundle ID must never change
  - **Rationale**: Changing bundle ID creates new app identity
  - **Impact**: Updates fail, user data lost, app conflicts
  - **Rule**: Bundle ID is permanent, set once, never changed
- **Version Independence**: Bundle ID independent of version
  - **Rationale**: Version changes don't affect app identity
  - **Implementation**: Bundle ID constant, version in separate field
  - **Validation**: Bundle ID doesn't change between versions
- **Platform Consistency**: Same bundle ID across platforms (if applicable)
  - **Rationale**: Unified app identity
  - **Implementation**: Use same bundle ID format
  - **Note**: macOS and Windows may use different formats, but keep consistent

### Task 3.3.2: Define Version Metadata

**What to Build**
- Version string definition and format
- Build number definition and format
- Version metadata consistency
- Version embedding in bundle
- Version validation

**Implementation Details**

**3.3.2.1 Version String (CFBundleShortVersionString)**
- **Format**: Semantic Versioning (SemVer)
- **Pattern**: `X.Y.Z` where X=major, Y=minor, Z=patch
- **Source**: `SRC/cuepoint/version.py` → `__version__`
- **Location**: `Info.plist` → `CFBundleShortVersionString`
- **Example**: `1.0.0`
- **Rules**:
  - Must be SemVer format (X.Y.Z)
  - Must match `version.py`
  - Must match git tag (if tagged)
  - Must be human-readable
  - Must increment appropriately
- **Usage**:
  - Displayed to users in About dialog
  - Shown in Finder Get Info
  - Used in update checks
  - Referenced in release notes
- **Validation**:
  - Format validation: SemVer pattern
  - Consistency validation: Matches version.py
  - Progression validation: Newer than previous release

**3.3.2.2 Build Number (CFBundleVersion)**
- **Format**: String (typically numeric or alphanumeric)
- **Source**: CI build number or date-based
- **Location**: `Info.plist` → `CFBundleVersion`
- **Examples**: `123`, `202412131530`, `1.0.0.123`
- **Rules**:
  - Must be unique for each build
  - Must increment for each build
  - Can be numeric or alphanumeric
  - Should be readable (for debugging)
- **Generation**:
  - **CI Build**: `GITHUB_RUN_NUMBER` or `BUILD_NUMBER`
  - **Local Build**: Date-based `YYYYMMDDHHMM`
  - **Fallback**: Timestamp or sequential number
- **Usage**:
  - Internal build tracking
  - Debugging and support
  - Update system (if used)
  - Crash reporting
- **Validation**:
  - Presence validation: Must be present
  - Format validation: Valid string
  - Uniqueness validation: Different from previous build

**3.3.2.3 Version Metadata Consistency**
- **Consistency Requirements**:
  - `Info.plist` → `CFBundleShortVersionString` = `version.py` → `__version__`
  - `Info.plist` → `CFBundleVersion` = `version.py` → `__build_number__`
  - Git tag (if exists) = `version.py` → `__version__` (with 'v' prefix)
  - All version references consistent across codebase
- **Validation Script**: `scripts/validate_version.py`
  - **Purpose**: Verify version consistency
  - **Checks**: Info.plist, version.py, git tags, pyproject.toml
  - **Output**: Consistency report
  - **Integration**: Called in CI before and after build
- **Failure Handling**:
  - Version mismatch → Build fails
  - Missing version → Build fails
  - Invalid format → Build fails
  - Clear error messages with locations

**3.3.2.4 Version Embedding Process**
- **Step 1**: Read version from `version.py`
  - **Script**: `scripts/set_build_info.py`
  - **Action**: Injects build info into version.py
  - **Output**: Updated version.py with build identifiers
- **Step 2**: Process Info.plist template
  - **Script**: `scripts/process_info_plist.py`
  - **Action**: Replaces placeholders with actual values
  - **Input**: `build/Info.plist.template`
  - **Output**: `build/Info.plist` with version injected
- **Step 3**: PyInstaller uses Info.plist
  - **Location**: `build/pyinstaller.spec`
  - **Action**: PyInstaller reads Info.plist and embeds in bundle
  - **Output**: App bundle with version in Info.plist
- **Step 4**: Verify version embedding
  - **Script**: `scripts/verify_version_embedding.py`
  - **Action**: Reads version from built app bundle
  - **Validation**: Compares with source version
  - **Output**: Verification report

### Task 3.3.3: Define Display Metadata

**What to Build**
- Application display name
- Bundle name
- Copyright information
- Application description
- Category and classification

**Implementation Details**

**3.3.3.1 Application Display Name**
- **Key**: `CFBundleDisplayName`
- **Value**: `CuePoint`
- **Purpose**: Name shown to users in Finder, Dock, About dialog
- **Rules**:
  - Human-readable
  - Brand-consistent
  - No technical identifiers
  - Can include spaces
  - Maximum length: 255 characters (practical: ~50)
- **Localization**: Can be localized (for future i18n)
  - **Format**: Per-language in .lproj bundles
  - **Default**: English (`CuePoint`)
  - **Future**: Add localized versions as needed
- **Consistency**:
  - Must match branding
  - Must be consistent across all UI
  - Must match DMG volume name
  - Must match installer name

**3.3.3.2 Bundle Name**
- **Key**: `CFBundleName`
- **Value**: `CuePoint`
- **Purpose**: Internal bundle name (used by system)
- **Rules**:
  - Short, technical name
  - No spaces (preferred)
  - Alphanumeric and hyphens
  - Maximum length: 16 characters (legacy limit, but can be longer)
- **Relationship to Display Name**:
  - Usually same as display name
  - Can be shorter/technical version
  - Used when display name not available
- **Consistency**:
  - Must match executable name (typically)
  - Must be consistent across builds

**3.3.3.3 Copyright Information**
- **Key**: `NSHumanReadableCopyright`
- **Value**: `Copyright © 2024 StuChain. All rights reserved.`
- **Purpose**: Copyright notice shown in About dialog and Get Info
- **Format**: Human-readable copyright string
- **Components**:
  - Copyright symbol: ©
  - Year: Current year or range
  - Owner: Organization name
  - Rights: "All rights reserved" or license terms
- **Rules**:
  - Must include copyright symbol or word
  - Must include year
  - Must include owner
  - Should be accurate and current
- **Updates**:
  - Update year annually (or use range)
  - Update if ownership changes
  - Keep consistent with license

**3.3.3.4 Application Description**
- **Key**: `CFBundleGetInfoString` (optional)
- **Value**: `CuePoint - Rekordbox Metadata Enrichment Tool`
- **Purpose**: Short description shown in Get Info
- **Format**: Brief, descriptive text
- **Rules**:
  - Concise (1-2 sentences)
  - Descriptive of app purpose
  - User-friendly language
  - Maximum length: ~200 characters
- **Usage**:
  - Finder Get Info window
  - System information
  - Search indexing

**3.3.3.5 Category and Classification**
- **LSApplicationCategoryType** (optional):
  - **Purpose**: App Store category (if submitting)
  - **Value**: `public.app-category.utilities` (example)
  - **Usage**: App Store categorization
  - **Note**: Not required for direct distribution
- **LSApplicationCategoryType** Values:
  - `public.app-category.utilities`: Utilities
  - `public.app-category.productivity`: Productivity
  - `public.app-category.music`: Music
  - `public.app-category.developer-tools`: Developer Tools
  - Others as appropriate

### Task 3.3.4: Define System Requirements Metadata

**What to Build**
- Minimum macOS version
- Architecture requirements
- Hardware requirements
- Software dependencies
- System capability declarations

**Implementation Details**

**3.3.4.1 Minimum macOS Version**
- **Key**: `LSMinimumSystemVersion`
- **Value**: `10.15` (macOS Catalina)
- **Purpose**: Declares minimum macOS version required
- **Rationale**:
  - macOS 10.15 (Catalina) released 2019
  - Still widely supported
  - Good balance of compatibility and modern features
  - Supports both Intel and Apple Silicon (via Rosetta 2)
- **Validation**:
  - App must not use APIs from newer versions
  - Test on minimum version
  - Document system requirements
- **Future Considerations**:
  - May increase to 11.0+ for Apple Silicon native
  - Consider user base and compatibility
  - Document version requirements clearly

**3.3.4.2 Architecture Support**
- **LSArchitecturePriority** (optional):
  - **Purpose**: Preferred architecture order
  - **Value**: `['arm64', 'x86_64']` (Universal2)
  - **Usage**: System uses for architecture selection
  - **Note**: For Universal2 binaries, both architectures supported
- **Architecture Strategy**:
  - **Universal2** (recommended): Single binary supports both
  - **Separate Builds**: arm64 and x86_64 separately
  - **Intel Only**: x86_64 only (legacy, not recommended)
  - **Apple Silicon Only**: arm64 only (future consideration)
- **Implementation**:
  - PyInstaller can build Universal2
  - Qt frameworks must be Universal2
  - All embedded frameworks must match architecture
  - Test on both architectures

**3.3.4.3 Hardware Requirements**
- **LSRequiresNativeExecution** (optional):
  - **Purpose**: Requires native execution (no Rosetta)
  - **Value**: `false` (allows Rosetta translation)
  - **Usage**: For Universal2, allows Rosetta for Intel
  - **Note**: Set to `true` only if app requires native execution
- **Hardware Capabilities** (if needed):
  - **GPU Requirements**: None (standard)
  - **Memory Requirements**: Document minimum RAM
  - **Storage Requirements**: Document disk space needed
  - **Network Requirements**: Document if network required

**3.3.4.4 Software Dependencies**
- **System Frameworks**: Linked dynamically
  - **Examples**: Cocoa, Foundation, AppKit
  - **Availability**: Included in macOS
  - **Linking**: Automatic via system
- **Embedded Frameworks**: Bundled with app
  - **Examples**: Qt frameworks, Python libraries
  - **Location**: `Contents/Frameworks/`
  - **Signing**: Must be signed
  - **Architecture**: Must match app architecture
- **External Dependencies**: Document if any
  - **Examples**: Command-line tools, system services
  - **Documentation**: List in system requirements
  - **Installation**: User must install separately

### Task 3.3.5: Define Hardened Runtime and Entitlements

**What to Build**
- Hardened runtime configuration
- Entitlements definition
- Entitlements file structure
- Entitlements validation
- Security posture documentation

**Implementation Details**

**3.3.5.1 Hardened Runtime**
- **Purpose**: Security feature required for notarization
- **Requirement**: Must be enabled for notarized apps
- **Enabling**: `--options runtime` flag in codesign
- **Benefits**:
  - Prevents code injection
  - Restricts runtime behavior
  - Required for notarization
  - Better security posture
- **Implementation**:
  - Enable in signing script: `codesign --options runtime`
  - Apply to all signed items (app, frameworks, helpers)
  - Verify after signing: `codesign -dvv` shows "runtime" flag
- **Compatibility**:
  - Works with most apps
  - May require entitlements for some features
  - Test thoroughly after enabling

**3.3.5.2 Entitlements File**
- **Purpose**: Declares app capabilities and permissions
- **Format**: XML property list (.entitlements)
- **Location**: `build/entitlements.plist` (template)
- **Usage**: Passed to codesign with `--entitlements` flag
- **Principle**: Minimal entitlements (security best practice)
- **Structure**:
  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
      <!-- Entitlements here -->
  </dict>
  </plist>
  ```

**3.3.5.3 Default Entitlements (Minimal)**
- **No Special Entitlements by Default**:
  - **Rationale**: Maximum security, minimum attack surface
  - **Principle**: Add only what's absolutely required
  - **Testing**: Test app functionality, add entitlements only if needed
- **Common Entitlements (Add Only If Needed)**:
  - **Network Client**: Usually implicit, no entitlement needed
  - **File Access**: User-selected files don't need entitlement
  - **Hardware Access**: Camera, microphone require entitlements
  - **JIT Compilation**: `com.apple.security.cs.allow-jit` (if needed)
  - **Unsigned Executable Memory**: `com.apple.security.cs.allow-unsigned-executable-memory` (if needed)
- **CuePoint-Specific Entitlements**:
  - **Network Access**: Implicit (no entitlement needed)
  - **File Access**: User-selected files (no entitlement needed)
  - **Browser Automation**: May require specific entitlements (review if using)
  - **Default**: No special entitlements required

**3.3.5.4 Entitlements Validation**
- **Validation Requirements**:
  - Entitlements file is valid XML
  - Entitlements are necessary (not excessive)
  - Entitlements are properly formatted
  - Entitlements match app requirements
- **Validation Script**: `scripts/validate_entitlements.py`
  - **Purpose**: Verify entitlements are minimal and correct
  - **Checks**: File format, entitlement necessity, security review
  - **Output**: Validation report
  - **Integration**: Called before signing
- **Security Review**:
  - Review all entitlements for necessity
  - Document why each entitlement is needed
  - Minimize entitlements to reduce attack surface
  - Regular review of entitlements

**3.3.5.5 Entitlements Documentation**
- **Documentation Requirements**:
  - List all entitlements used
  - Explain why each entitlement is needed
  - Document security implications
  - Provide alternatives if possible
- **Entitlements Log**:
  - **File**: `DOCS/SECURITY/Entitlements.md`
  - **Content**: Entitlements inventory, rationale, security notes
  - **Updates**: Update when entitlements change
  - **Review**: Regular security review

### Task 3.3.6: Define Info.plist Structure

**What to Build**
- Complete Info.plist specification
- Info.plist template file
- Info.plist processing script
- Info.plist validation
- Info.plist documentation

**Implementation Details**

**3.3.6.1 Info.plist Template Structure**
- **File**: `build/Info.plist.template`
- **Format**: XML property list
- **Purpose**: Template with placeholders for build-time injection
- **Placeholders**:
  - `{{VERSION}}`: Semantic version (from version.py)
  - `{{BUILD_NUMBER}}`: Build number (from CI or date)
  - `{{SHORT_COMMIT}}`: Short commit SHA (optional)
- **Processing**: `scripts/process_info_plist.py` replaces placeholders
- **Output**: `build/Info.plist` (used by PyInstaller)

**3.3.6.2 Required Info.plist Keys**
- **CFBundleIdentifier**: `com.stuchain.cuepoint`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Unique app identifier
- **CFBundleName**: `CuePoint`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Bundle name
- **CFBundleDisplayName**: `CuePoint`
  - **Type**: String
  - **Required**: Yes (recommended)
  - **Purpose**: Display name
- **CFBundleExecutable**: `CuePoint`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Executable name (must match actual executable)
- **CFBundlePackageType**: `APPL`
  - **Type**: String (4 characters)
  - **Required**: Yes
  - **Purpose**: Package type (APPL = application)
- **CFBundleShortVersionString**: `{{VERSION}}`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: User-visible version
- **CFBundleVersion**: `{{BUILD_NUMBER}}`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Build number
- **LSMinimumSystemVersion**: `10.15`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Minimum macOS version

**3.3.6.3 Recommended Info.plist Keys**
- **NSHighResolutionCapable**: `true`
  - **Type**: Boolean
  - **Purpose**: Retina display support
  - **Recommended**: Yes (for modern apps)
- **NSHumanReadableCopyright**: `Copyright © 2024 StuChain. All rights reserved.`
  - **Type**: String
  - **Purpose**: Copyright notice
  - **Recommended**: Yes
- **CFBundleIconFile**: `icon.icns`
  - **Type**: String
  - **Purpose**: Icon file name
  - **Recommended**: Yes (if using custom icon)
- **LSArchitecturePriority**: `['arm64', 'x86_64']`
  - **Type**: Array of strings
  - **Purpose**: Architecture preference
  - **Recommended**: Yes (for Universal2)

**3.3.6.4 Optional Info.plist Keys**
- **CFBundleDocumentTypes**: Document type associations
  - **Type**: Array of dictionaries
  - **Purpose**: File type associations
  - **Example**: Rekordbox XML files
- **CFBundleURLTypes**: URL scheme handlers
  - **Type**: Array of dictionaries
  - **Purpose**: Custom URL schemes
  - **Example**: `cuepoint://` URLs
- **NSPrincipalClass**: `NSApplication`
  - **Type**: String
  - **Purpose**: Principal class (Cocoa apps)
  - **Note**: Usually automatic for Qt apps
- **LSRequiresNativeExecution**: `false`
  - **Type**: Boolean
  - **Purpose**: Native execution requirement
  - **Default**: `false` (allows Rosetta)

**3.3.6.5 Info.plist Validation**
- **Validation Requirements**:
  - Valid XML format
  - All required keys present
  - All values correct type
  - Version information consistent
  - Bundle identifier correct
- **Validation Script**: `scripts/validate_info_plist.py`
  - **Purpose**: Comprehensive Info.plist validation
  - **Checks**: Format, required keys, value types, consistency
  - **Output**: Detailed validation report
  - **Integration**: Called after Info.plist processing
- **Validation in CI**:
  - Pre-build: Validate template
  - Post-build: Validate in app bundle
  - Consistency: Compare with version.py

### Task 3.3.7: Define Team ID and Signing Identity

**What to Build**
- Team ID definition and usage
- Signing identity configuration
- Certificate management
- Identity validation
- Identity documentation

**Implementation Details**

**3.3.7.1 Team ID**
- **Purpose**: Apple Developer Team identifier
- **Format**: 10-character alphanumeric string
- **Example**: `ABC123DEF4`
- **Source**: Apple Developer account → Membership
- **Usage**:
  - Notarization: Required for notarization submission
  - Code Signing: Embedded in certificate
  - App Store: Required for App Store submission
- **Storage**: GitHub Secret `APPLE_TEAM_ID`
- **Validation**: Must match Apple Developer account
- **Consistency**: Must be consistent across all builds

**3.3.7.2 Signing Identity**
- **Format**: `Developer ID Application: {Name} ({Team ID})`
- **Example**: `Developer ID Application: StuChain (ABC123DEF4)`
- **Purpose**: Code signing identity
- **Certificate Type**: Developer ID Application (for distribution outside App Store)
- **Alternative**: Apple Development (for development only, not for distribution)
- **Storage**: Certificate in GitHub Secret `MACOS_SIGNING_CERT_P12`
- **Usage**: Passed to codesign with `--sign` flag
- **Validation**: Verify identity matches expected

**3.3.7.3 Certificate Management**
- **Certificate Type**: Developer ID Application
  - **Purpose**: Sign apps for distribution outside App Store
  - **Validity**: Typically 1-3 years
  - **Renewal**: Must renew before expiry
  - **Storage**: .p12 file, base64 encoded in GitHub Secrets
- **Certificate Export**:
  - Export from Keychain Access
  - Format: .p12 (PKCS#12)
  - Password: Set strong password
  - Base64 encode for GitHub Secrets
- **Certificate Import** (CI):
  - Script: `scripts/import_macos_cert.sh`
  - Action: Import certificate to temporary keychain
  - Usage: Used during signing process
  - Cleanup: Remove after build

**3.3.7.4 Identity Validation**
- **Validation Requirements**:
  - Certificate exists and is valid
  - Certificate not expired
  - Certificate type correct (Developer ID Application)
  - Team ID matches expected
  - Identity string matches expected
- **Validation Script**: `scripts/validate_certificate.py`
  - **Purpose**: Verify certificate validity
  - **Checks**: Expiry, type, team ID, identity
  - **Output**: Validation report
  - **Integration**: Called before signing
- **Failure Handling**:
  - Expired certificate → Alert and fail
  - Wrong certificate type → Fail with clear error
  - Team ID mismatch → Fail with clear error

### Task 3.3.8: Define Metadata Consistency System

**What to Build**
- Cross-file metadata validation
- Metadata consistency enforcement
- Metadata update procedures
- Metadata documentation
- Metadata automation

**Implementation Details**

**3.3.8.1 Metadata Sources**
- **Primary Source**: `SRC/cuepoint/version.py`
  - **Version**: `__version__`
  - **Build Number**: `__build_number__`
  - **Commit SHA**: `__commit_sha__`
- **Secondary Sources**:
  - **Info.plist**: Processed from template
  - **PyInstaller Spec**: Bundle configuration
  - **Git Tags**: Version tags
  - **Release Notes**: Version references
- **Consistency Requirement**: All sources must match

**3.3.8.2 Metadata Validation**
- **Validation Script**: `scripts/validate_metadata.py`
  - **Purpose**: Comprehensive metadata consistency check
  - **Checks**:
    - Version consistency across all files
    - Bundle ID consistency
    - Display name consistency
    - Copyright consistency
    - All metadata fields
  - **Output**: Detailed consistency report
  - **Integration**: Called in CI before and after build
- **Validation Points**:
  - Pre-build: Validate source files
  - Post-build: Validate app bundle
  - Pre-release: Final validation
  - Post-release: Verify release artifacts

**3.3.8.3 Metadata Update Procedures**
- **Version Update Process**:
  1. Update `SRC/cuepoint/version.py` → `__version__`
  2. Run `scripts/validate_version.py`
  3. Commit version change
  4. Create git tag: `git tag vX.Y.Z`
  5. Push tag to trigger release
- **Metadata Update Process**:
  1. Update source files (version.py, Info.plist template)
  2. Run validation scripts
  3. Test build locally
  4. Commit changes
  5. Tag and release
- **Automation**: CI automatically processes metadata during build

**3.3.8.4 Metadata Documentation**
- **Documentation File**: `DOCS/METADATA/Bundle_Metadata.md`
  - **Purpose**: Complete metadata reference
  - **Content**: All metadata fields, values, sources, usage
  - **Updates**: Update when metadata changes
- **Metadata Inventory**:
  - List all metadata fields
  - Document source of each field
  - Document usage of each field
  - Document update procedures

## Implementation Checklist

### Bundle Identifier
- [ ] Define bundle identifier format
- [ ] Configure bundle identifier in all files
- [ ] Create bundle ID validation
- [ ] Document bundle ID usage

### Version Metadata
- [ ] Define version format
- [ ] Configure version in Info.plist
- [ ] Create version processing script
- [ ] Create version validation

### Display Metadata
- [ ] Define display names
- [ ] Configure copyright information
- [ ] Configure application description
- [ ] Document display metadata

### System Requirements
- [ ] Define minimum macOS version
- [ ] Configure architecture support
- [ ] Document hardware requirements
- [ ] Document software dependencies

### Hardened Runtime
- [ ] Define entitlements (minimal)
- [ ] Create entitlements file
- [ ] Configure hardened runtime
- [ ] Validate entitlements

### Info.plist
- [ ] Create Info.plist template
- [ ] Configure all required keys
- [ ] Create processing script
- [ ] Create validation script

### Team ID and Identity
- [ ] Configure Team ID
- [ ] Configure signing identity
- [ ] Create certificate validation
- [ ] Document identity management

### Metadata Consistency
- [ ] Create metadata validation
- [ ] Define update procedures
- [ ] Create documentation
- [ ] Automate validation

## Files to Create/Modify

### New Files
1. `DOCS/DESIGNS/SHIP v1.0/Step_3_macOS_Packaging/3.3_Bundle_Identity.md` - This document
2. `build/entitlements.plist` - Entitlements file (if needed)
3. `scripts/validate_bundle_id.py` - Bundle ID validation
4. `scripts/validate_info_plist.py` - Info.plist validation
5. `scripts/validate_metadata.py` - Metadata consistency validation
6. `scripts/validate_certificate.py` - Certificate validation
7. `DOCS/METADATA/Bundle_Metadata.md` - Metadata documentation

### Files to Modify
1. `build/Info.plist.template` - Complete template with all keys
2. `build/pyinstaller.spec` - Bundle identifier configuration
3. `scripts/process_info_plist.py` - Enhanced processing
4. `DOCS/DESIGNS/SHIP v1.0/Step_3_macOS_Packaging/README.md` - Add reference

## Implementation Dependencies

### Prerequisites
- Step 2: Build System (provides version management)
- Step 3.1: Goals (defines requirements)
- Step 3.2: Build Output (defines bundle structure)
- Apple Developer account (for Team ID and certificates)

### Enables
- Step 3.4: Signing (uses bundle identity for signing)
- Step 3.5: Notarization (uses bundle identity for notarization)

## Success Criteria

### Bundle Identity
- ✅ Bundle ID defined and consistent
- ✅ Bundle ID validated across all files
- ✅ Bundle ID never changes

### Version Metadata
- ✅ Version consistent across all files
- ✅ Version format correct (SemVer)
- ✅ Build number unique and incrementing

### Display Metadata
- ✅ Display names consistent
- ✅ Copyright information correct
- ✅ All metadata user-friendly

### System Requirements
- ✅ Minimum version defined
- ✅ Architecture support configured
- ✅ Requirements documented

### Hardened Runtime
- ✅ Hardened runtime enabled
- ✅ Entitlements minimal and documented
- ✅ Security posture strong

### Info.plist
- ✅ All required keys present
- ✅ All values correct
- ✅ Template processing works
- ✅ Validation passes

### Team ID and Identity
- ✅ Team ID configured
- ✅ Signing identity correct
- ✅ Certificate valid and not expired

### Metadata Consistency
- ✅ All metadata consistent
- ✅ Validation automated
- ✅ Update procedures documented

## Next Implementation Steps

After completing Step 3.3:
1. **Step 3.4**: Signing (signs app with configured identity)
2. **Step 3.5**: Notarization (notarizes with configured metadata)

## Detailed Implementation Guidance

### Info.plist Template Example

**Complete Template**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <!-- Bundle Identity -->
    <key>CFBundleIdentifier</key>
    <string>com.stuchain.cuepoint</string>
    
    <!-- Version Information -->
    <key>CFBundleShortVersionString</key>
    <string>{{VERSION}}</string>
    <key>CFBundleVersion</key>
    <string>{{BUILD_NUMBER}}</string>
    
    <!-- Application Information -->
    <key>CFBundleName</key>
    <string>CuePoint</string>
    <key>CFBundleDisplayName</key>
    <string>CuePoint</string>
    <key>CFBundleExecutable</key>
    <string>CuePoint</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    
    <!-- System Requirements -->
    <key>LSMinimumSystemVersion</key>
    <string>10.15</string>
    <key>LSArchitecturePriority</key>
    <array>
        <string>arm64</string>
        <string>x86_64</string>
    </array>
    
    <!-- UI Configuration -->
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>NSHumanReadableCopyright</key>
    <string>Copyright © 2024 StuChain. All rights reserved.</string>
    
    <!-- Icon -->
    <key>CFBundleIconFile</key>
    <string>icon.icns</string>
</dict>
</plist>
```

### Entitlements File Example

**Minimal Entitlements** (if needed):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <!-- No special entitlements by default -->
    <!-- Add only if absolutely required -->
</dict>
</plist>
```

### Metadata Validation Script Example

```python
#!/usr/bin/env python3
"""Validate bundle metadata consistency"""

import sys
from pathlib import Path
import plistlib

def validate_metadata():
    """Validate metadata consistency"""
    errors = []
    
    # Read version from version.py
    sys.path.insert(0, 'SRC')
    from cuepoint.version import __version__, __build_number__
    
    # Read Info.plist from app bundle
    info_plist = Path('dist/CuePoint.app/Contents/Info.plist')
    if not info_plist.exists():
        errors.append("Info.plist not found")
        return errors
    
    with open(info_plist, 'rb') as f:
        plist = plistlib.load(f)
    
    # Validate version
    if plist.get('CFBundleShortVersionString') != __version__:
        errors.append(f"Version mismatch: Info.plist has {plist.get('CFBundleShortVersionString')}, version.py has {__version__}")
    
    # Validate build number
    if plist.get('CFBundleVersion') != __build_number__:
        errors.append(f"Build number mismatch: Info.plist has {plist.get('CFBundleVersion')}, version.py has {__build_number__}")
    
    # Validate bundle ID
    if plist.get('CFBundleIdentifier') != 'com.stuchain.cuepoint':
        errors.append(f"Bundle ID mismatch: {plist.get('CFBundleIdentifier')}")
    
    return errors

if __name__ == '__main__':
    errors = validate_metadata()
    if errors:
        print("Metadata validation failed:")
        for error in errors:
            print(f"  {error}")
        sys.exit(1)
    print("Metadata validation passed")
```

## References

- Main document: `../03_macOS_Packaging_Signing_Notarization.md`
- Related: Step 2.4 (Version Management), Step 3.2 (Build Output)
- Apple Info.plist Key Reference: https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/
- Bundle Programming Guide: https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/
