# Implementation Step 4.3: App Identity and Metadata

## Implementation Overview
**What We're Building**: A comprehensive app identity and metadata management system that ensures consistent, correct, and complete application identification across all Windows build artifacts. This includes publisher identity, version information, product metadata, install scope strategy, and all metadata required for proper app identification, signing, installation, and distribution.

## Implementation Tasks

### Task 4.3.1: Define Publisher Identity System

**What to Build**
- Publisher name definition and format
- Publisher identity consistency enforcement
- Publisher identity validation
- Publisher identity usage across components
- Certificate publisher matching

**Implementation Details**

**4.3.1.1 Publisher Name Format**
- **Format**: Organization or company name
- **Current Value**: "StuChain" (example, adjust as needed)
- **Components**:
  - **Organization Name**: Full legal or display name
  - **Short Name**: Abbreviated name for technical use
  - **Display Name**: Name shown to users
- **Rules**:
  - Must be consistent across all builds
  - Must match code signing certificate subject
  - Must be human-readable
  - Should match organization branding
  - Maximum length: 255 characters (practical: ~50)
- **Validation**:
  - Consistency: Verify across all metadata files
  - Certificate match: Verify matches signing certificate
  - Format: Verify proper formatting
- **Rationale**:
  - Establishes publisher identity
  - Required for code signing
  - Shown in SmartScreen and file properties
  - Builds user trust

**4.3.1.2 Publisher Identity Usage**
- **Version Resource**: `CompanyName` field
  - **Location**: Embedded in executable version resource
  - **Key**: `CompanyName`
  - **Value**: "StuChain"
  - **Required**: Yes (recommended)
  - **Format**: String
  - **Display**: Shown in file properties
- **Code Signing Certificate**: Subject name
  - **Location**: Certificate subject field
  - **Usage**: Windows uses for publisher identification
  - **Validation**: Must match version resource
  - **Display**: Shown in SmartScreen, file properties
- **Installer Metadata**: Publisher field
  - **Location**: NSIS installer script
  - **Usage**: Shown in installer UI, "Add/Remove Programs"
  - **Validation**: Must match version resource
- **Update System**: Publisher for update identification
  - **Location**: Update feed metadata
  - **Usage**: Update system uses for publisher verification
  - **Validation**: Must match installed app

**4.3.1.3 Publisher Identity Consistency**
- **Consistency Requirements**:
  - Version resource: `CompanyName` = "StuChain"
  - Code signing certificate: Subject = "StuChain" (or matches)
  - Installer metadata: Publisher = "StuChain"
  - All metadata: Publisher references = "StuChain"
- **Validation Script**: `scripts/validate_publisher.py`
  - **Purpose**: Verify publisher identity consistency
  - **Checks**: Version resource, certificate, installer metadata
  - **Output**: Consistency report
  - **Integration**: Called in CI before build
- **Failure Handling**:
  - Inconsistent publisher → Build fails
  - Missing publisher → Build fails
  - Certificate mismatch → Build fails
  - Clear error messages with location of inconsistency

**4.3.1.4 Publisher Identity Stability**
- **Stability Requirement**: Publisher name should remain consistent
  - **Rationale**: Changing publisher creates confusion
  - **Impact**: User trust, SmartScreen reputation, update issues
  - **Rule**: Publisher name is stable, changes only with good reason
- **Version Independence**: Publisher independent of version
  - **Rationale**: Version changes don't affect publisher identity
  - **Implementation**: Publisher constant, version in separate field
  - **Validation**: Publisher doesn't change between versions
- **Certificate Consistency**: Publisher must match certificate
  - **Rationale**: SmartScreen uses certificate for publisher identification
  - **Implementation**: Ensure certificate subject matches publisher
  - **Validation**: Verify certificate matches publisher name

### Task 4.3.2: Define Version Metadata

**What to Build**
- Version string definition and format
- Build number definition and format
- Version metadata consistency
- Version embedding in executable and installer
- Version validation

**Implementation Details**

**4.3.2.1 Version String (Product Version)**
- **Format**: Semantic Versioning (SemVer)
- **Pattern**: `X.Y.Z` where X=major, Y=minor, Z=patch
- **Source**: `SRC/cuepoint/version.py` → `__version__`
- **Location**: Version resource → `ProductVersion`
- **Example**: `1.0.0`
- **Rules**:
  - Must be SemVer format (X.Y.Z)
  - Must match `version.py`
  - Must match git tag (if tagged)
  - Must be human-readable
  - Must increment appropriately
- **Usage**:
  - Displayed to users in About dialog
  - Shown in file properties
  - Used in update checks
  - Referenced in release notes
- **Validation**:
  - Format validation: SemVer pattern
  - Consistency validation: Matches version.py
  - Progression validation: Newer than previous release

**4.3.2.2 File Version (Four-Part Version)**
- **Format**: Four-part version string
- **Pattern**: `X.Y.Z.BUILD` where BUILD=build number
- **Source**: `SRC/cuepoint/version.py` → `__version__` + `__build_number__`
- **Location**: Version resource → `FileVersion`
- **Example**: `1.0.0.123`
- **Rules**:
  - Must be four-part (X.Y.Z.BUILD)
  - Must increment for each build
  - BUILD number must be unique
  - Must match version.py + build number
- **Generation**:
  - **CI Build**: `GITHUB_RUN_NUMBER` or `BUILD_NUMBER`
  - **Local Build**: Date-based `YYYYMMDDHHMM` or sequential
  - **Fallback**: Timestamp or sequential number
- **Usage**:
  - Internal build tracking
  - Windows version comparison
  - Debugging and support
  - Update system (if used)
- **Validation**:
  - Format validation: Four-part pattern
  - Consistency validation: Matches version.py + build number
  - Uniqueness validation: Different from previous build

**4.3.2.3 Version Metadata Consistency**
- **Consistency Requirements**:
  - Version resource → `ProductVersion` = `version.py` → `__version__`
  - Version resource → `FileVersion` = `version.py` → `__version__` + `__build_number__`
  - Installer version = `version.py` → `__version__`
  - Git tag (if exists) = `version.py` → `__version__` (with 'v' prefix)
  - All version references consistent across codebase
- **Validation Script**: `scripts/validate_version.py`
  - **Purpose**: Verify version consistency
  - **Checks**: Version resource, version.py, git tags, installer metadata
  - **Output**: Consistency report
  - **Integration**: Called in CI before and after build
- **Failure Handling**:
  - Version mismatch → Build fails
  - Missing version → Build fails
  - Invalid format → Build fails
  - Clear error messages with locations

**4.3.2.4 Version Embedding Process**
- **Step 1**: Read version from `version.py`
  - **Script**: `scripts/set_build_info.py`
  - **Action**: Injects build info into version.py
  - **Output**: Updated version.py with build identifiers
- **Step 2**: Process version resource template
  - **Script**: `scripts/process_version_info.py`
  - **Action**: Replaces placeholders with actual values
  - **Input**: `build/version_info.txt.template`
  - **Output**: `build/version_info.txt` with version injected
- **Step 3**: PyInstaller uses version resource
  - **Location**: `build/pyinstaller.spec`
  - **Action**: PyInstaller reads version_info.txt and embeds in executable
  - **Output**: Executable with version in version resource
- **Step 4**: Verify version embedding
  - **Script**: `scripts/verify_version_embedding.py`
  - **Action**: Reads version from built executable
  - **Validation**: Compares with source version
  - **Output**: Verification report

### Task 4.3.3: Define Product Metadata

**What to Build**
- Product name and display information
- Product description
- Copyright information
- Product classification
- Support and contact information

**Implementation Details**

**4.3.3.1 Product Name**
- **Key**: `ProductName` in version resource
- **Value**: "CuePoint"
- **Purpose**: Product name shown in file properties, installer, "Add/Remove Programs"
- **Rules**:
  - Human-readable
  - Brand-consistent
  - No technical identifiers
  - Can include spaces
  - Maximum length: 255 characters (practical: ~50)
- **Consistency**:
  - Must match branding
  - Must be consistent across all UI
  - Must match installer name
  - Must match executable name (typically)

**4.3.3.2 Product Description**
- **Key**: `FileDescription` in version resource
- **Value**: "CuePoint - Rekordbox Metadata Enrichment Tool"
- **Purpose**: Short description shown in file properties, task manager
- **Format**: Brief, descriptive text
- **Rules**:
  - Concise (1-2 sentences)
  - Descriptive of app purpose
  - User-friendly language
  - Maximum length: ~200 characters
- **Usage**:
  - File properties window
  - Task Manager
  - System information
  - Search indexing

**4.3.3.3 Copyright Information**
- **Key**: `LegalCopyright` in version resource
- **Value**: "Copyright © 2024 StuChain. All rights reserved."
- **Purpose**: Copyright notice shown in file properties
- **Format**: Human-readable copyright string
- **Components**:
  - Copyright symbol: ©
  - Year: Current year or range
  - Owner: Organization name
  - Rights: "All rights reserved" or license terms
- **Rules**:
  - Must include copyright symbol or word
  - Must include year
  - Must include owner
  - Should be accurate and current
- **Updates**:
  - Update year annually (or use range)
  - Update if ownership changes
  - Keep consistent with license

**4.3.3.4 Internal Name and Original Filename**
- **InternalName**: "CuePoint"
  - **Purpose**: Internal product identifier
  - **Format**: Short, technical name
  - **Usage**: Internal system identification
- **OriginalFilename**: "CuePoint.exe"
  - **Purpose**: Original executable filename
  - **Format**: Executable name with .exe extension
  - **Usage**: File identification, version tracking

### Task 4.3.4: Define Install Scope Strategy

**What to Build**
- Install scope decision (per-user vs per-machine)
- Install location configuration
- Registry key strategy
- Shortcut location strategy
- Data location strategy

**Implementation Details**

**4.3.4.1 Per-User Installation Strategy**
- **Decision**: Per-user installation for v1.0
- **Rationale**:
  - No admin prompts required
  - Easier updates
  - Better user experience
  - Supports standard users
  - Multiple users can install independently
- **Install Location**: `%LOCALAPPDATA%\CuePoint`
  - **Example**: `C:\Users\Username\AppData\Local\CuePoint\`
  - **Purpose**: Per-user application installation
  - **Access**: User has full control
  - **No Admin Required**: Standard users can install
- **Advantages**:
  - No UAC prompts
  - Faster installation
  - Better user experience
  - Supports standard users
  - Easier updates
- **Disadvantages**:
  - Not system-wide (each user installs separately)
  - May use more disk space (multiple installations)
  - Not suitable for enterprise deployment (if needed)

**4.3.4.2 Per-Machine Installation Alternative**
- **Decision**: Not used for v1.0, but documented for future
- **Install Location**: `Program Files\CuePoint` or `Program Files (x86)\CuePoint`
  - **Example**: `C:\Program Files\CuePoint\`
  - **Purpose**: System-wide application installation
  - **Access**: Requires admin for installation
  - **Admin Required**: Administrator privileges needed
- **Advantages**:
  - System-wide installation
  - Single installation for all users
  - Better for enterprise deployment
  - Group Policy support (with MSI)
- **Disadvantages**:
  - Requires admin privileges
  - UAC prompts during installation
  - More complex updates
  - May complicate auto-updates
- **When to Use**:
  - Enterprise deployment required
  - System-wide installation needed
  - Group Policy deployment needed
  - Future enterprise features

**4.3.4.3 Registry Key Strategy**
- **Per-User Registry Keys** (for per-user install):
  - **Location**: `HKEY_CURRENT_USER\Software\CuePoint`
  - **Purpose**: Per-user application settings
  - **Access**: User has full control
  - **Usage**: Settings, preferences, uninstaller info
- **Registry Keys Used**:
  - **Uninstaller Info**: `HKCU\Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint`
    - **Purpose**: "Add/Remove Programs" entry
    - **Contents**: Display name, uninstaller path, version, etc.
  - **Application Settings** (if needed): `HKCU\Software\CuePoint`
    - **Purpose**: Application-specific settings
    - **Contents**: User preferences, configuration
- **Registry Cleanup**: Uninstaller removes all registry entries

**4.3.4.4 Shortcut Location Strategy**
- **Start Menu Shortcut**:
  - **Location**: `%APPDATA%\Microsoft\Windows\Start Menu\Programs\CuePoint.lnk`
  - **Purpose**: Application shortcut in Start menu
  - **Creation**: Installer creates automatically
  - **Removal**: Uninstaller removes
- **Desktop Shortcut** (optional):
  - **Location**: `%USERPROFILE%\Desktop\CuePoint.lnk`
  - **Purpose**: Desktop shortcut for quick access
  - **Creation**: User choice during installation
  - **Removal**: Uninstaller removes if created
- **Quick Launch** (legacy, optional):
  - **Location**: `%APPDATA%\Microsoft\Internet Explorer\Quick Launch\CuePoint.lnk`
  - **Purpose**: Quick launch bar shortcut (Windows 7/8)
  - **Note**: Not needed for Windows 10/11

**4.3.4.5 Data Location Strategy**
- **User Data Locations** (separate from installation):
  - **Config**: `%APPDATA%\CuePoint\`
    - **Purpose**: User-specific settings and preferences
    - **Example**: `C:\Users\Username\AppData\Roaming\CuePoint\`
    - **Access**: Read/write by application
    - **Preservation**: Preserved during upgrades
  - **Cache**: `%LOCALAPPDATA%\CuePoint\Cache\`
    - **Purpose**: Temporary cache files
    - **Example**: `C:\Users\Username\AppData\Local\CuePoint\Cache\`
    - **Access**: Read/write by application
    - **Cleanup**: Can be deleted, regenerated
  - **Logs**: `%LOCALAPPDATA%\CuePoint\Logs\`
    - **Purpose**: Application log files
    - **Example**: `C:\Users\Username\AppData\Local\CuePoint\Logs\`
    - **Access**: Write by application, read by user/admin
    - **Rotation**: Automatic log rotation
  - **Exports**: `Documents\CuePoint\` (default)
    - **Purpose**: User export files
    - **Example**: `C:\Users\Username\Documents\CuePoint\`
    - **Access**: Read/write by application
    - **User Choice**: User can change export location

### Task 4.3.5: Define Version Resource Structure

**What to Build**
- Complete version resource specification
- Version resource template file
- Version resource processing script
- Version resource validation
- Version resource documentation

**Implementation Details**

**4.3.5.1 Version Resource Template Structure**
- **File**: `build/version_info.txt.template`
- **Format**: Python version resource syntax (for PyInstaller)
- **Purpose**: Template with placeholders for build-time injection
- **Placeholders**:
  - `{{VERSION}}`: Semantic version (from version.py)
  - `{{BUILD_NUMBER}}`: Build number (from CI or date)
  - `{{FILE_VERSION}}`: Four-part version (X.Y.Z.BUILD)
  - `{{COMPANY_NAME}}`: Publisher name
  - `{{PRODUCT_NAME}}`: Product name
  - `{{COPYRIGHT}}`: Copyright string
- **Processing**: `scripts/process_version_info.py` replaces placeholders
- **Output**: `build/version_info.txt` (used by PyInstaller)

**4.3.5.2 Required Version Resource Keys**
- **FileVersion**: `{{FILE_VERSION}}`
  - **Type**: Four-part version string
  - **Required**: Yes
  - **Purpose**: File versioning (Windows uses for comparison)
- **ProductVersion**: `{{VERSION}}`
  - **Type**: Three-part version string
  - **Required**: Yes
  - **Purpose**: Product versioning (shown to users)
- **CompanyName**: `{{COMPANY_NAME}}`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Publisher/organization name
- **ProductName**: `{{PRODUCT_NAME}}`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Product name
- **FileDescription**: Product description
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: File description
- **LegalCopyright**: `{{COPYRIGHT}}`
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Copyright notice
- **OriginalFilename**: "CuePoint.exe"
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Original filename
- **InternalName**: "CuePoint"
  - **Type**: String
  - **Required**: Yes
  - **Purpose**: Internal name

**4.3.5.3 Version Resource Validation**
- **Validation Requirements**:
  - Valid version resource syntax
  - All required keys present
  - All values correct type
  - Version information consistent
  - Publisher information correct
- **Validation Script**: `scripts/validate_version_resource.py`
  - **Purpose**: Comprehensive version resource validation
  - **Checks**: Format, required keys, value types, consistency
  - **Output**: Detailed validation report
  - **Integration**: Called after version resource processing
- **Validation in CI**:
  - Pre-build: Validate template
  - Post-build: Validate in executable
  - Consistency: Compare with version.py

### Task 4.3.6: Define Installer Metadata

**What to Build**
- Installer metadata specification
- Installer version information
- Installer publisher information
- Installer description
- Installer metadata validation

**Implementation Details**

**4.3.6.1 Installer Metadata Structure**
- **Installer Name**: "CuePoint"
  - **Purpose**: Installer display name
  - **Location**: NSIS script `Name` directive
  - **Usage**: Shown in installer UI, installer file properties
- **Installer Version**: Matches application version
  - **Purpose**: Installer version tracking
  - **Location**: NSIS script version variable
  - **Usage**: Version comparison, upgrade detection
- **Installer Publisher**: "StuChain"
  - **Purpose**: Publisher name in installer
  - **Location**: NSIS script metadata
  - **Usage**: Shown in installer UI, "Add/Remove Programs"
- **Installer Description**: "CuePoint Installer"
  - **Purpose**: Installer description
  - **Location**: NSIS script metadata
  - **Usage**: Installer file properties

**4.3.6.2 Installer Version Consistency**
- **Consistency Requirements**:
  - Installer version = Application version
  - Installer name = Product name
  - Installer publisher = Company name
  - All metadata consistent across installer and application
- **Validation**: Verify installer metadata matches application metadata
- **Failure Handling**: Build fails if metadata inconsistent

### Task 4.3.7: Define Metadata Consistency System

**What to Build**
- Cross-file metadata validation
- Metadata consistency enforcement
- Metadata update procedures
- Metadata documentation
- Metadata automation

**Implementation Details**

**4.3.7.1 Metadata Sources**
- **Primary Source**: `SRC/cuepoint/version.py`
  - **Version**: `__version__`
  - **Build Number**: `__build_number__`
  - **Commit SHA**: `__commit_sha__`
- **Secondary Sources**:
  - **Version Resource**: Processed from template
  - **PyInstaller Spec**: Executable configuration
  - **Installer Script**: Installer metadata
  - **Git Tags**: Version tags
  - **Release Notes**: Version references
- **Consistency Requirement**: All sources must match

**4.3.7.2 Metadata Validation**
- **Validation Script**: `scripts/validate_metadata.py`
  - **Purpose**: Comprehensive metadata consistency check
  - **Checks**:
    - Version consistency across all files
    - Publisher consistency
    - Product name consistency
    - Copyright consistency
    - All metadata fields
  - **Output**: Detailed consistency report
  - **Integration**: Called in CI before and after build
- **Validation Points**:
  - Pre-build: Validate source files
  - Post-build: Validate executable
  - Pre-release: Final validation
  - Post-release: Verify release artifacts

**4.3.7.3 Metadata Update Procedures**
- **Version Update Process**:
  1. Update `SRC/cuepoint/version.py` → `__version__`
  2. Run `scripts/validate_version.py`
  3. Commit version change
  4. Create git tag: `git tag vX.Y.Z`
  5. Push tag to trigger release
- **Metadata Update Process**:
  1. Update source files (version.py, version_info.txt.template)
  2. Run validation scripts
  3. Test build locally
  4. Commit changes
  5. Tag and release
- **Automation**: CI automatically processes metadata during build

**4.3.7.4 Metadata Documentation**
- **Documentation File**: `DOCS/METADATA/Windows_Metadata.md`
  - **Purpose**: Complete metadata reference
  - **Content**: All metadata fields, values, sources, usage
  - **Updates**: Update when metadata changes
- **Metadata Inventory**:
  - List all metadata fields
  - Document source of each field
  - Document usage of each field
  - Document update procedures

## Implementation Checklist

### Publisher Identity
- [ ] Define publisher name format
- [ ] Configure publisher in all files
- [ ] Create publisher validation
- [ ] Document publisher usage

### Version Metadata
- [ ] Define version format
- [ ] Configure version in version resource
- [ ] Create version processing script
- [ ] Create version validation

### Product Metadata
- [ ] Define product names
- [ ] Configure copyright information
- [ ] Configure product description
- [ ] Document product metadata

### Install Scope
- [ ] Define install scope strategy (per-user)
- [ ] Configure install location
- [ ] Configure registry keys
- [ ] Configure shortcut locations
- [ ] Configure data locations

### Version Resource
- [ ] Create version resource template
- [ ] Configure all required keys
- [ ] Create processing script
- [ ] Create validation script

### Installer Metadata
- [ ] Configure installer metadata
- [ ] Ensure consistency with application
- [ ] Create validation

### Metadata Consistency
- [ ] Create metadata validation
- [ ] Define update procedures
- [ ] Create documentation
- [ ] Automate validation

## Files to Create/Modify

### New Files
1. `DOCS/DESIGNS/SHIP v1.0/Step_4_Windows_Packaging/4.3_App_Identity.md` - This document
2. `build/version_info.txt.template` - Version resource template
3. `scripts/validate_publisher.py` - Publisher validation
4. `scripts/validate_version_resource.py` - Version resource validation
5. `scripts/process_version_info.py` - Version resource processing
6. `DOCS/METADATA/Windows_Metadata.md` - Metadata documentation

### Files to Modify
1. `build/version_info.txt` - Complete template with all keys
2. `build/pyinstaller.spec` - Version resource configuration
3. `scripts/installer.nsi` - Installer metadata configuration
4. `DOCS/DESIGNS/SHIP v1.0/Step_4_Windows_Packaging/README.md` - Add reference

## Implementation Dependencies

### Prerequisites
- Step 2: Build System (provides version management)
- Step 4.1: Goals (defines requirements)
- Step 4.2: Build Output (defines executable structure)
- Code signing certificate (for publisher identity)

### Enables
- Step 4.4: Signing (uses app identity for signing)
- Step 4.5: Installer Behavior (uses metadata for installer)

## Success Criteria

### Publisher Identity
- ✅ Publisher name defined and consistent
- ✅ Publisher validated across all files
- ✅ Publisher matches certificate
- ✅ Publisher stable across versions

### Version Metadata
- ✅ Version consistent across all files
- ✅ Version format correct (SemVer)
- ✅ Build number unique and incrementing
- ✅ Version embedded correctly

### Product Metadata
- ✅ Product names consistent
- ✅ Copyright information correct
- ✅ All metadata user-friendly

### Install Scope
- ✅ Per-user installation configured
- ✅ Install location correct
- ✅ Data locations configured
- ✅ Shortcuts configured

### Version Resource
- ✅ All required keys present
- ✅ All values correct
- ✅ Template processing works
- ✅ Validation passes

### Metadata Consistency
- ✅ All metadata consistent
- ✅ Validation automated
- ✅ Update procedures documented

## Next Implementation Steps

After completing Step 4.3:
1. **Step 4.4**: Signing (signs executable with configured identity)
2. **Step 4.5**: Installer Behavior (uses configured metadata)

## Detailed Implementation Guidance

### Version Resource Template Example

**Complete Template** (`build/version_info.txt.template`):
```python
# UTF-8
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=({{MAJOR}}, {{MINOR}}, {{PATCH}}, {{BUILD}}),
    prodvers=({{MAJOR}}, {{MINOR}}, {{PATCH}}, 0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo(
      [
      StringTable(
        u'040904B0',
        [StringStruct(u'CompanyName', u'{{COMPANY_NAME}}'),
        StringStruct(u'FileDescription', u'CuePoint - Rekordbox Metadata Enrichment Tool'),
        StringStruct(u'FileVersion', u'{{FILE_VERSION}}'),
        StringStruct(u'InternalName', u'CuePoint'),
        StringStruct(u'LegalCopyright', u'{{COPYRIGHT}}'),
        StringStruct(u'OriginalFilename', u'CuePoint.exe'),
        StringStruct(u'ProductName', u'CuePoint'),
        StringStruct(u'ProductVersion', u'{{VERSION}}')]
      )
      ]
    ),
    VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
  ]
)
```

### Metadata Validation Script Example

```python
#!/usr/bin/env python3
"""Validate Windows metadata consistency"""

import sys
from pathlib import Path
import win32api  # pywin32, or use alternative method

def get_version_from_exe(exe_path):
    """Get version from executable"""
    try:
        # Get version info using Windows API
        version_info = win32api.GetFileVersionInfo(str(exe_path), '\\')
        return {
            'file_version': version_info['FileVersionMS'],
            'product_version': version_info['ProductVersionMS'],
            'company_name': version_info['StringFileInfo']['040904B0']['CompanyName'],
            'product_name': version_info['StringFileInfo']['040904B0']['ProductName'],
        }
    except Exception as e:
        return None

def validate_metadata(exe_path=None):
    """Validate metadata consistency"""
    errors = []
    
    # Read version from version.py
    sys.path.insert(0, 'SRC')
    from cuepoint.version import __version__, __build_number__
    
    # Get version from executable
    if exe_path:
        exe_metadata = get_version_from_exe(exe_path)
        if exe_metadata:
            # Validate version
            if exe_metadata['product_version'] != __version__:
                errors.append(
                    f"Version mismatch: executable has {exe_metadata['product_version']}, "
                    f"version.py has {__version__}"
                )
            
            # Validate publisher
            if exe_metadata['company_name'] != 'StuChain':
                errors.append(
                    f"Publisher mismatch: executable has {exe_metadata['company_name']}, "
                    f"expected StuChain"
                )
    
    return len(errors) == 0, errors

if __name__ == '__main__':
    exe_path = sys.argv[1] if len(sys.argv) > 1 else None
    valid, errors = validate_metadata(exe_path)
    
    if not valid:
        print("Metadata validation failed:")
        for error in errors:
            print(f"  ERROR: {error}")
        sys.exit(1)
    
    print("Metadata validation passed")
    sys.exit(0)
```

## References

- Main document: `../04_Windows_Packaging_Signing.md`
- Related: Step 2.4 (Version Management), Step 4.2 (Build Output)
- Windows Version Resources: https://docs.microsoft.com/en-us/windows/win32/menurc/versioninfo-resource
- NSIS Documentation: https://nsis.sourceforge.io/Docs/
