# Implementation Step 1.6: Distribution Formats

## Implementation Overview
**What We're Building**: Distribution format creation (DMG for macOS, NSIS installer for Windows) with install/uninstall workflows.

## Implementation Tasks

### Task 1.6.1: Implement macOS DMG Distribution

**What to Build**
- DMG creation script
- DMG layout configuration
- DMG branding and polish

**Implementation Details**

**1.6.1.1 DMG Creation Script**
- **File to Create**: `scripts/create_dmg.sh`
- **Implementation**: See Step 1.4 (already created)
- **Purpose**: Create distributable DMG
- **Dependencies**: macOS build environment

**1.6.1.2 DMG Layout Configuration**
- **File to Create**: `scripts/configure_dmg_layout.sh`
- **Implementation**:
  ```bash
  #!/bin/bash
  # Configure DMG layout after mounting
  DMG_PATH="$1"
  MOUNT_POINT="$2"
  
  # Set window size and position
  osascript <<EOF
  tell application "Finder"
      tell disk "${DMG_PATH}"
          open
          set current view of container window to icon view
          set toolbar visible of container window to false
          set statusbar visible of container window to false
          set bounds of container window to {400, 100, 900, 420}
          
          set view options of container window to icon view options
          set icon size of view options to 72
          
          # Position CuePoint.app
          set position of item "CuePoint.app" to {120, 205}
          
          # Position Applications symlink
          set position of item "Applications" to {380, 205}
          
          close
      end tell
  end tell
  EOF
  ```
- **Purpose**: Professional DMG appearance
- **Usage**: Called during DMG creation

**1.6.1.3 DMG Branding**
- **File to Create**: `resources/dmg_background.png` (optional)
- **Implementation**: Background image for DMG
- **Purpose**: Branded installation experience
- **Usage**: Referenced in DMG layout script

### Task 1.6.2: Implement Windows NSIS Installer

**What to Build**
- NSIS installer script
- Installer UI customization
- Uninstaller configuration

**Implementation Details**

**1.6.2.1 NSIS Installer Script**
- **File to Create**: `scripts/installer.nsi`
- **Implementation**: See Step 1.4 (already created)
- **Purpose**: Windows installation
- **Dependencies**: NSIS compiler

**1.6.2.2 Installer UI Customization**
- **File to Modify**: `scripts/installer.nsi`
- **Implementation**:
  ```nsis
  !define MUI_ICON "resources\icon.ico"
  !define MUI_UNICON "resources\icon.ico"
  !define MUI_HEADERIMAGE
  !define MUI_HEADERIMAGE_BITMAP "resources\header.bmp"
  !define MUI_WELCOMEFINISHPAGE_BITMAP "resources\wizard.bmp"
  
  # Branding
  BrandingText "CuePoint v${VERSION}"
  ```
- **Purpose**: Branded installer
- **Dependencies**: Icon and image resources

**1.6.2.3 Uninstaller Configuration**
- **File to Modify**: `scripts/installer.nsi`
- **Implementation**:
  ```nsis
  Section "Uninstall"
      # Remove application files
      RMDir /r "$INSTDIR"
      
      # Remove shortcuts
      Delete "$SMPROGRAMS\CuePoint.lnk"
      Delete "$DESKTOP\CuePoint.lnk"
      
      # Remove registry entries (if any)
      DeleteRegKey HKCU "Software\CuePoint"
      
      # Ask about user data
      MessageBox MB_YESNO "Delete user data and settings?" IDNO skip_data
      RMDir /r "$APPDATA\CuePoint"
      RMDir /r "$LOCALAPPDATA\CuePoint"
      skip_data:
  SectionEnd
  ```
- **Purpose**: Clean uninstallation
- **Integration**: Uninstaller entry in Add/Remove Programs

### Task 1.6.3: Implement Install/Uninstall Workflows

**What to Build**
- Installation validation
- Uninstallation data preservation
- Installation testing

**Implementation Details**

**1.6.3.1 Installation Validation**
- **File to Create**: `tests/acceptance/test_installation.py`
- **Implementation**:
  ```python
  def test_macos_installation():
      """Test macOS DMG installation"""
      # Mount DMG
      # Verify app structure
      # Test launch
      # Verify no Python required
      # Verify signing/notarization
      
  def test_windows_installation():
      """Test Windows installer"""
      # Run installer
      # Verify installation
      # Test launch
      # Verify shortcuts created
      # Verify no Python required
  ```
- **Purpose**: Automated installation testing
- **Location**: `tests/acceptance/` directory

**1.6.3.2 Uninstallation Data Preservation**
- **File to Modify**: `scripts/installer.nsi`
- **Implementation**: See 1.6.2.3 above
- **Purpose**: Preserve user data by default
- **Behavior**: Ask user before deleting data

**1.6.3.3 Installation Testing Infrastructure**
- **File to Create**: `tests/acceptance/fixtures/clean_vm.py`
- **Implementation**:
  ```python
  """Test fixtures for clean VM testing"""
  # Scripts to set up clean test environments
  # Verify no Python installed
  # Verify no previous CuePoint installation
  ```
- **Purpose**: Reproducible testing
- **Usage**: CI/CD and manual testing

## Implementation Checklist

### macOS DMG
- [ ] Create DMG creation script (Step 1.4)
- [ ] Create DMG layout configuration
- [ ] Add DMG branding (optional)
- [ ] Test DMG installation

### Windows Installer
- [ ] Create NSIS installer script (Step 1.4)
- [ ] Customize installer UI
- [ ] Configure uninstaller
- [ ] Test installer

### Testing
- [ ] Create installation tests
- [ ] Create uninstallation tests
- [ ] Test on clean VMs
- [ ] Verify data preservation

## Files to Create/Modify

### New Files
1. `scripts/configure_dmg_layout.sh` - DMG layout configuration
2. `resources/dmg_background.png` - DMG background (optional)
3. `resources/icon.ico` - Windows icon
4. `resources/header.bmp` - Installer header
5. `tests/acceptance/test_installation.py` - Installation tests
6. `tests/acceptance/fixtures/clean_vm.py` - Test fixtures

### Files to Modify
1. `scripts/create_dmg.sh` - Enhance with layout config (Step 1.4)
2. `scripts/installer.nsi` - Enhance UI and uninstaller (Step 1.4)

## Implementation Dependencies

### Prerequisites
- Step 1.4: Target outcomes (defines installation requirements)
- Step 1.5: Supported platforms (defines platform requirements)

### Enables
- Step 2: Build system (uses distribution scripts)
- Step 3: macOS packaging (uses DMG script)
- Step 4: Windows packaging (uses installer script)

## Success Criteria

### Installation
- ✅ Installation success rate > 95%
- ✅ Installation time < 2 minutes
- ✅ No Python required
- ✅ All shortcuts created

### Uninstallation
- ✅ Clean removal of app files
- ✅ User data preserved by default
- ✅ Uninstaller works correctly

## Next Implementation Steps

After completing Step 1.6:
1. **Step 2**: Build system (integrates distribution)
2. **Step 3**: macOS packaging (enhances DMG)
3. **Step 4**: Windows packaging (enhances installer)

## Detailed Distribution Implementation

### macOS DMG Distribution - Complete Implementation

**1.6.1.4 Enhanced DMG Creation Script**
- **Complete DMG Creation with Layout**:
  ```bash
  #!/bin/bash
  # scripts/create_dmg.sh
  set -e
  
  APP_NAME="CuePoint"
  VERSION="${1:-1.0.0}"
  DMG_NAME="${APP_NAME}-v${VERSION}-macos-universal"
  TEMP_DIR=$(mktemp -d)
  DMG_DIR="${TEMP_DIR}/${APP_NAME}"
  MOUNT_POINT="/Volumes/${APP_NAME}"
  
  # Cleanup function
  cleanup() {
      # Unmount if mounted
      if [ -d "$MOUNT_POINT" ]; then
          hdiutil detach "$MOUNT_POINT" || true
      fi
      rm -rf "${TEMP_DIR}"
  }
  trap cleanup EXIT
  
  echo "Creating DMG for ${APP_NAME} ${VERSION}..."
  
  # Verify app bundle exists
  if [ ! -d "dist/${APP_NAME}.app" ]; then
      echo "Error: App bundle not found at dist/${APP_NAME}.app"
      exit 1
  fi
  
  # Create DMG directory structure
  mkdir -p "${DMG_DIR}"
  
  # Copy app bundle
  echo "Copying app bundle..."
  cp -R "dist/${APP_NAME}.app" "${DMG_DIR}/"
  
  # Create Applications symlink
  echo "Creating Applications symlink..."
  ln -s /Applications "${DMG_DIR}/Applications"
  
  # Create README
  cat > "${DMG_DIR}/README.txt" << EOF
  CuePoint ${VERSION}
  
  Installation:
  1. Drag CuePoint.app to the Applications folder
  2. Open Applications and launch CuePoint
  
  System Requirements:
  - macOS 10.15 or later
  - 100MB free disk space
  
  For support, visit: https://github.com/yourusername/cuepoint
  EOF
  
  # Create initial DMG
  echo "Creating DMG image..."
  hdiutil create -volname "${APP_NAME}" \
    -srcfolder "${DMG_DIR}" \
    -ov -format UDRW \
    -fs HFS+ \
    "${TEMP_DIR}/${DMG_NAME}-temp.dmg"
  
  # Mount DMG
  echo "Mounting DMG for layout configuration..."
  hdiutil attach "${TEMP_DIR}/${DMG_NAME}-temp.dmg" -mountpoint "$MOUNT_POINT" -readwrite
  
  # Configure layout
  echo "Configuring DMG layout..."
  osascript <<EOF
  tell application "Finder"
      tell disk "${APP_NAME}"
          open
          set current view of container window to icon view
          set toolbar visible of container window to false
          set statusbar visible of container window to false
          set bounds of container window to {400, 100, 900, 420}
          
          set view options of container window to icon view options
          set icon size of view options to 72
          
          -- Position CuePoint.app
          set position of item "CuePoint.app" to {120, 205}
          
          -- Position Applications symlink
          set position of item "Applications" to {380, 205}
          
          -- Update without registering positions
          close
          open
          update without registering applications
          delay 1
      end tell
  end tell
  EOF
  
  # Unmount
  echo "Unmounting DMG..."
  hdiutil detach "$MOUNT_POINT"
  
  # Convert to compressed DMG
  echo "Compressing DMG..."
  hdiutil convert "${TEMP_DIR}/${DMG_NAME}-temp.dmg" \
    -format UDZO \
    -imagekey zlib-level=9 \
    -o "dist/${DMG_NAME}.dmg"
  
  echo "DMG created: dist/${DMG_NAME}.dmg"
  ```

**1.6.1.5 DMG Branding and Polish**
- **Background Image Setup**:
  ```bash
  # Add background image to DMG
  # Place background.png in resources/
  # Reference in layout script:
  osascript <<EOF
  tell application "Finder"
      tell disk "${APP_NAME}"
          set background picture of view options to file ".background:background.png"
      end tell
  end tell
  EOF
  ```
- **DMG Icon Customization**:
  - Custom volume icon
  - Custom app icon positioning
  - Professional appearance

**1.6.1.6 DMG Testing and Validation**
- **DMG Validation Script**:
  ```python
  # scripts/validate_dmg.py
  """Validate macOS DMG"""
  import subprocess
  import tempfile
  from pathlib import Path
  
  def validate_dmg(dmg_path: Path) -> tuple[bool, list[str]]:
      """Validate DMG structure and contents"""
      errors = []
      
      # Check DMG exists
      if not dmg_path.exists():
          errors.append(f"DMG not found: {dmg_path}")
          return False, errors
      
      # Mount DMG
      with tempfile.TemporaryDirectory() as mount_point:
          result = subprocess.run(
              ["hdiutil", "attach", str(dmg_path), "-mountpoint", mount_point],
              capture_output=True,
              text=True
          )
          
          if result.returncode != 0:
              errors.append(f"Failed to mount DMG: {result.stderr}")
              return False, errors
          
          try:
              # Check app bundle exists
              app_path = Path(mount_point) / "CuePoint.app"
              if not app_path.exists():
                  errors.append("App bundle not found in DMG")
              
              # Check Applications symlink
              apps_link = Path(mount_point) / "Applications"
              if not apps_link.exists() or not apps_link.is_symlink():
                  errors.append("Applications symlink not found")
              
              # Check app bundle structure
              if app_path.exists():
                  required_paths = [
                      "Contents/MacOS/CuePoint",
                      "Contents/Info.plist",
                      "Contents/Resources"
                  ]
                  for req_path in required_paths:
                      if not (app_path / req_path).exists():
                          errors.append(f"Missing required path: {req_path}")
              
          finally:
              # Unmount
              subprocess.run(["hdiutil", "detach", mount_point], check=False)
      
      return len(errors) == 0, errors
  ```

### Windows NSIS Installer - Complete Implementation

**1.6.2.4 Enhanced NSIS Installer Script**
- **Complete Installer with All Features**:
  ```nsis
  !include "MUI2.nsh"
  !include "FileFunc.nsh"
  !include "LogicLib.nsh"
  
  # Application information
  Name "CuePoint"
  OutFile "CuePoint-v${VERSION}-windows-x64-setup.exe"
  InstallDir "$LOCALAPPDATA\CuePoint"
  RequestExecutionLevel user
  
  # Version information
  VIProductVersion "${VERSION}.0"
  VIAddVersionKey "ProductName" "CuePoint"
  VIAddVersionKey "FileDescription" "CuePoint Installer"
  VIAddVersionKey "FileVersion" "${VERSION}"
  VIAddVersionKey "ProductVersion" "${VERSION}"
  VIAddVersionKey "CompanyName" "StuChain"
  VIAddVersionKey "LegalCopyright" "Copyright © 2024 StuChain"
  
  # Interface settings
  !define MUI_ICON "resources\icon.ico"
  !define MUI_UNICON "resources\icon.ico"
  !define MUI_HEADERIMAGE
  !define MUI_HEADERIMAGE_BITMAP "resources\header.bmp"
  !define MUI_WELCOMEFINISHPAGE_BITMAP "resources\wizard.bmp"
  !define MUI_ABORTWARNING
  
  # Pages
  !insertmacro MUI_PAGE_WELCOME
  !insertmacro MUI_PAGE_LICENSE "LICENSE.txt"
  !insertmacro MUI_PAGE_DIRECTORY
  !insertmacro MUI_PAGE_INSTFILES
  !define MUI_FINISHPAGE_RUN "$INSTDIR\CuePoint.exe"
  !define MUI_FINISHPAGE_RUN_TEXT "Launch CuePoint"
  !define MUI_FINISHPAGE_SHOWREADME "$INSTDIR\README.txt"
  !define MUI_FINISHPAGE_SHOWREADME_TEXT "View README"
  !insertmacro MUI_PAGE_FINISH
  
  !insertmacro MUI_UNPAGE_CONFIRM
  !insertmacro MUI_UNPAGE_INSTFILES
  
  # Languages
  !insertmacro MUI_LANGUAGE "English"
  
  # Installation section
  Section "Install" SecMain
      SetOutPath "$INSTDIR"
      
      # Install files
      File /r "dist\CuePoint\*"
      
      # Create Start Menu shortcuts
      CreateDirectory "$SMPROGRAMS\CuePoint"
      CreateShortcut "$SMPROGRAMS\CuePoint\CuePoint.lnk" "$INSTDIR\CuePoint.exe"
      CreateShortcut "$SMPROGRAMS\CuePoint\Uninstall.lnk" "$INSTDIR\uninstall.exe"
      
      # Create Desktop shortcut (optional, commented out)
      ; CreateShortcut "$DESKTOP\CuePoint.lnk" "$INSTDIR\CuePoint.exe"
      
      # Create uninstaller
      WriteUninstaller "$INSTDIR\uninstall.exe"
      
      # Registry entries
      WriteRegStr HKCU "Software\CuePoint" "InstallPath" "$INSTDIR"
      WriteRegStr HKCU "Software\CuePoint" "Version" "${VERSION}"
      
      # Uninstaller registry
      WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "DisplayName" "CuePoint"
      WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "UninstallString" "$INSTDIR\uninstall.exe"
      WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "DisplayVersion" "${VERSION}"
      WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "Publisher" "StuChain"
      WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "NoModify" 1
      WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "NoRepair" 1
      WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
          "InstallLocation" "$INSTDIR"
      
      # File associations (optional)
      ; WriteRegStr HKCU "Software\Classes\.cuepoint" "" "CuePoint.File"
      ; WriteRegStr HKCU "Software\Classes\CuePoint.File" "" "CuePoint File"
      ; WriteRegStr HKCU "Software\Classes\CuePoint.File\DefaultIcon" "" "$INSTDIR\CuePoint.exe,0"
  SectionEnd
  
  # Uninstaller section
  Section "Uninstall"
      # Remove files
      RMDir /r "$INSTDIR"
      
      # Remove shortcuts
      RMDir /r "$SMPROGRAMS\CuePoint"
      ; Delete "$DESKTOP\CuePoint.lnk"
      
      # Remove registry entries
      DeleteRegKey HKCU "Software\CuePoint"
      DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint"
      
      # Ask about user data
      MessageBox MB_YESNO|MB_ICONQUESTION \
          "Do you want to delete user data and settings?$\n$\n" \
          "This will remove all configuration, cache, and logs." \
          IDNO skip_data
      
      # Remove user data
      RMDir /r "$APPDATA\CuePoint"
      RMDir /r "$LOCALAPPDATA\CuePoint"
      
      skip_data:
      
      # Show completion message
      MessageBox MB_OK "CuePoint has been uninstalled successfully."
  SectionEnd
  
  # Function to check if already installed
  Function .onInit
      # Check if already installed
      ReadRegStr $R0 HKCU "Software\CuePoint" "InstallPath"
      ${If} $R0 != ""
          MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION \
              "CuePoint is already installed at:$\n$R0$\n$\n" \
              "Click OK to reinstall or Cancel to exit." \
              IDOK continue_install
          Abort
          continue_install:
      ${EndIf}
  FunctionEnd
  ```

**1.6.2.5 Installer Customization Resources**
- **Required Resources**:
  - `resources/icon.ico` - Application icon (16x16, 32x32, 48x48, 256x256)
  - `resources/header.bmp` - Installer header (150x57)
  - `resources/wizard.bmp` - Welcome/Finish page (164x314)
  - `LICENSE.txt` - License text for installer

**1.6.2.6 Installer Testing**
- **Installer Validation**:
  ```python
  # scripts/validate_installer.py
  """Validate Windows installer"""
  import subprocess
  import tempfile
  from pathlib import Path
  
  def validate_installer(installer_path: Path) -> tuple[bool, list[str]]:
      """Validate NSIS installer"""
      errors = []
      
      # Check installer exists
      if not installer_path.exists():
          errors.append(f"Installer not found: {installer_path}")
          return False, errors
      
      # Check signing (if signed)
      result = subprocess.run(
          ["signtool", "verify", "/pa", "/v", str(installer_path)],
          capture_output=True,
          text=True
      )
      if result.returncode != 0:
          errors.append("Installer not signed or signature invalid")
      
      # Test silent install
      with tempfile.TemporaryDirectory() as temp_dir:
          install_dir = Path(temp_dir) / "test_install"
          result = subprocess.run(
              [str(installer_path), "/S", f"/D={install_dir}"],
              capture_output=True,
              text=True,
              timeout=300
          )
          
          if result.returncode != 0:
              errors.append(f"Silent install failed: {result.stderr}")
          else:
              # Verify installation
              exe_path = install_dir / "CuePoint.exe"
              if not exe_path.exists():
                  errors.append("CuePoint.exe not found after installation")
              
              # Test uninstall
              uninstaller = install_dir / "uninstall.exe"
              if uninstaller.exists():
                  result = subprocess.run(
                      [str(uninstaller), "/S"],
                      capture_output=True,
                      text=True,
                      timeout=60
                  )
                  if result.returncode != 0:
                      errors.append(f"Uninstall failed: {result.stderr}")
      
      return len(errors) == 0, errors
  ```

### Install/Uninstall Workflows - Complete Implementation

**1.6.3.4 Installation Validation - Complete**
- **Comprehensive Installation Tests**:
  ```python
  # tests/acceptance/test_installation.py
  """Comprehensive installation testing"""
  import pytest
  import subprocess
  import shutil
  from pathlib import Path
  import platform
  import time
  
  @pytest.fixture
  def clean_install_dir():
      """Clean installation directory"""
      if platform.system() == "Windows":
          install_dir = Path.home() / "AppData" / "Local" / "CuePoint"
      else:
          install_dir = Path.home() / "Applications" / "CuePoint.app"
      
      # Cleanup before test
      if install_dir.exists():
          if platform.system() == "Windows":
              shutil.rmtree(install_dir)
          else:
              subprocess.run(["rm", "-rf", str(install_dir)])
      
      yield install_dir
      
      # Cleanup after test
      if install_dir.exists():
          if platform.system() == "Windows":
              shutil.rmtree(install_dir)
          else:
              subprocess.run(["rm", "-rf", str(install_dir)])
  
  def test_macos_dmg_mounts():
      """Test macOS DMG can be mounted"""
      dmg_path = Path("dist/CuePoint-v1.0.0-macos-universal.dmg")
      assert dmg_path.exists(), "DMG file not found"
      
      # Mount DMG
      result = subprocess.run(
          ["hdiutil", "attach", str(dmg_path)],
          capture_output=True,
          text=True
      )
      assert result.returncode == 0, f"Failed to mount DMG: {result.stderr}"
      
      try:
          # Verify contents
          mount_point = "/Volumes/CuePoint"
          assert Path(mount_point).exists()
          assert (Path(mount_point) / "CuePoint.app").exists()
          assert (Path(mount_point) / "Applications").exists()
      finally:
          # Unmount
          subprocess.run(["hdiutil", "detach", mount_point], check=False)
  
  def test_macos_app_structure():
      """Test macOS app bundle structure"""
      app_path = Path("dist/CuePoint.app")
      assert app_path.exists(), "App bundle not found"
      
      # Check required structure
      assert (app_path / "Contents" / "MacOS" / "CuePoint").exists()
      assert (app_path / "Contents" / "Info.plist").exists()
      assert (app_path / "Contents" / "Resources").exists()
      
      # Check Info.plist
      import plistlib
      with open(app_path / "Contents" / "Info.plist", "rb") as f:
          plist = plistlib.load(f)
          assert plist["CFBundleIdentifier"] == "com.stuchain.cuepoint"
          assert "CFBundleShortVersionString" in plist
  
  def test_windows_installer_runs(clean_install_dir):
      """Test Windows installer can run"""
      installer_path = Path("dist/CuePoint-v1.0.0-windows-x64-setup.exe")
      assert installer_path.exists(), "Installer not found"
      
      # Test silent install
      install_path = clean_install_dir.parent / "test_install"
      result = subprocess.run(
          [str(installer_path), "/S", f"/D={install_path}"],
          capture_output=True,
          text=True,
          timeout=300
      )
      assert result.returncode == 0, f"Installer failed: {result.stderr}"
      
      # Verify installation
      assert (install_path / "CuePoint.exe").exists()
      assert (install_path / "uninstall.exe").exists()
      
      # Cleanup
      shutil.rmtree(install_path)
  
  def test_app_launches_without_python():
      """Test app launches without Python installed"""
      # This test requires clean VM
      # Verify app executable runs
      # Verify no Python dependency errors
      pass
  
  def test_installation_success_rate():
      """Test installation success rate on various systems"""
      # Test on:
      # - Clean macOS 10.15+
      # - Clean macOS 11+
      # - Clean macOS 12+
      # - Clean Windows 10
      # - Clean Windows 11
      # Measure success rate
      pass
  
  def test_uninstallation_preserves_data():
      """Test uninstallation preserves user data by default"""
      # Install app
      # Create user data
      # Uninstall
      # Verify user data still exists
      pass
  ```

**1.6.3.5 Uninstallation Data Preservation**
- **Data Preservation Strategy**:
  - **Preserve by Default**: User data, config, cache, logs
  - **Ask Before Delete**: Prompt user before removing data
  - **Clear Option**: Provide option to remove all data
  - **Implementation**: See NSIS script above

**1.6.3.6 Installation Testing Infrastructure**
- **Clean VM Test Setup**:
  ```python
  # tests/acceptance/fixtures/clean_vm.py
  """Test fixtures for clean VM testing"""
  import subprocess
  import platform
  from pathlib import Path
  
  def setup_clean_environment():
      """Set up clean test environment"""
      # Verify no Python installed
      result = subprocess.run(["python", "--version"], capture_output=True)
      if result.returncode == 0:
          raise RuntimeError("Python found in clean environment")
      
      # Verify no previous CuePoint installation
      if platform.system() == "Windows":
          install_path = Path.home() / "AppData" / "Local" / "CuePoint"
      else:
          install_path = Path.home() / "Applications" / "CuePoint.app"
      
      if install_path.exists():
          raise RuntimeError("Previous CuePoint installation found")
      
      return True
  
  def verify_no_python_dependency():
      """Verify app doesn't require Python"""
      # Try to launch app
      # Check for Python-related errors
      # Verify app runs successfully
      pass
  ```

## Edge Cases and Error Handling

### Installation Edge Cases
- **Case 1**: App already installed
  - **Handling**: Allow reinstall, preserve data
- **Case 2**: Insufficient disk space
  - **Handling**: Check before install, show error
- **Case 3**: Corrupted installer/DMG
  - **Handling**: Verify checksum, show error
- **Case 4**: Permission denied
  - **Handling**: Show clear error, suggest solutions

### Uninstallation Edge Cases
- **Case 1**: Files locked
  - **Handling**: Warn user, suggest closing app
- **Case 2**: Partial uninstall
  - **Handling**: Clean up what's possible, log issues
- **Case 3**: User data deletion
  - **Handling**: Confirm before deletion

## Performance Benchmarks

### Installation Performance
- **DMG Mount Time**: < 2 seconds
- **App Copy Time**: < 10 seconds
- **Installer Run Time**: < 30 seconds
- **Total Installation**: < 2 minutes

### Uninstallation Performance
- **Uninstall Time**: < 10 seconds
- **Data Cleanup**: < 5 seconds (if chosen)

## Distribution Workflow Details

### Complete Distribution Pipeline

**1.6.4 Complete Distribution Workflow**
- **Distribution Pipeline Steps**:
  1. Build application with PyInstaller
  2. Code sign application
  3. Create distribution package (DMG/Installer)
  4. Sign distribution package
  5. Notarize (macOS) or verify (Windows)
  6. Validate artifacts
  7. Upload to GitHub Releases
  8. Generate update metadata

**1.6.5 Distribution Testing Matrix**
- **Test Matrix**:
  ```
  Platform | OS Version | Architecture | Test Type
  ---------|------------|-------------|------------
  macOS    | 10.15      | x64         | Installation, Launch, Uninstall
  macOS    | 11.0       | x64         | Installation, Launch, Uninstall
  macOS    | 12.0       | x64         | Installation, Launch, Uninstall
  macOS    | 13.0       | x64         | Installation, Launch, Uninstall
  macOS    | 11.0       | arm64       | Installation, Launch, Uninstall
  macOS    | 12.0       | arm64       | Installation, Launch, Uninstall
  Windows  | 10         | x64         | Installation, Launch, Uninstall
  Windows  | 11         | x64         | Installation, Launch, Uninstall
  ```

**1.6.6 Distribution Artifact Validation**
- **Complete Validation Checklist**:
  ```python
  # scripts/validate_distribution.py
  """Validate all distribution artifacts"""
  from pathlib import Path
  import subprocess
  
  def validate_all_artifacts(artifacts_dir: Path) -> dict:
      """Validate all distribution artifacts"""
      results = {
          "macos_dmg": None,
          "windows_installer": None,
          "errors": []
      }
      
      # Find DMG
      dmgs = list(artifacts_dir.glob("*.dmg"))
      if dmgs:
          valid, errors = validate_macos_dmg(dmgs[0])
          results["macos_dmg"] = {"valid": valid, "errors": errors}
      
      # Find installer
      installers = list(artifacts_dir.glob("*-setup.exe"))
      if installers:
          valid, errors = validate_windows_installer(installers[0])
          results["windows_installer"] = {"valid": valid, "errors": errors}
      
      return results
  ```

**1.6.7 Distribution Size Optimization**
- **Size Optimization Strategies**:
  - Exclude unnecessary modules
  - Use UPX compression
  - Optimize PyInstaller spec
  - Remove debug symbols
  - Compress resources

**1.6.8 Distribution Security**
- **Security Checklist**:
  - ✅ All executables signed
  - ✅ DMG/Installer signed
  - ✅ macOS DMG notarized
  - ✅ Checksums generated
  - ✅ Signatures verified

## Installation User Experience

### macOS Installation UX
- **DMG Experience**:
  1. User downloads DMG
  2. Double-clicks to mount
  3. Sees app bundle and Applications symlink
  4. Drags app to Applications
  5. Launches from Applications
  6. First launch: Gatekeeper check passes (notarized)

### Windows Installation UX
- **Installer Experience**:
  1. User downloads installer
  2. Double-clicks to run
  3. Sees welcome screen
  4. Accepts license
  5. Chooses install location
  6. Installation completes
  7. Option to launch immediately
  8. Shortcuts created in Start Menu

## Uninstallation User Experience

### macOS Uninstallation
- **Process**:
  1. User drags app to Trash
  2. Optionally empties Trash
  3. User data preserved in Library folders
  4. Manual cleanup available if needed

### Windows Uninstallation
- **Process**:
  1. User opens Add/Remove Programs
  2. Selects CuePoint
  3. Clicks Uninstall
  4. Uninstaller runs
  5. Asks about user data
  6. Removes application files
  7. Optionally removes user data

## Distribution Troubleshooting

### Common Distribution Issues
- **Issue 1**: DMG won't mount
  - **Cause**: Corrupted download or file
  - **Solution**: Re-download, verify checksum
- **Issue 2**: Installer fails silently
  - **Cause**: Permissions or antivirus
  - **Solution**: Run as admin, check antivirus
- **Issue 3**: App won't launch after install
  - **Cause**: Missing dependencies or signing issue
  - **Solution**: Check logs, verify signing

## Distribution Metrics

### Success Metrics
- **Installation Success Rate**: > 95%
- **Average Installation Time**: < 2 minutes
- **Uninstallation Success Rate**: > 98%
- **User Data Preservation**: 100%

## Detailed Distribution Implementation Examples

### Example 1: Complete DMG Creation Workflow
```bash
#!/bin/bash
# Complete DMG creation with all features
set -e

VERSION="${1:-1.0.0}"
APP_NAME="CuePoint"
DMG_NAME="${APP_NAME}-v${VERSION}-macos-universal"

# Step 1: Verify app bundle exists and is signed
if [ ! -d "dist/${APP_NAME}.app" ]; then
    echo "Error: App bundle not found"
    exit 1
fi

# Verify signing
codesign --verify --deep --strict "dist/${APP_NAME}.app" || {
    echo "Error: App bundle not properly signed"
    exit 1
}

# Step 2: Create temporary directory
TEMP_DIR=$(mktemp -d)
DMG_DIR="${TEMP_DIR}/${APP_NAME}"

# Step 3: Copy app and create layout
mkdir -p "${DMG_DIR}"
cp -R "dist/${APP_NAME}.app" "${DMG_DIR}/"
ln -s /Applications "${DMG_DIR}/Applications"

# Step 4: Create README
cat > "${DMG_DIR}/README.txt" << 'EOF'
CuePoint - Installation Instructions

1. Drag CuePoint.app to the Applications folder
2. Open Applications and launch CuePoint
3. On first launch, macOS may ask for permission to open

System Requirements:
- macOS 10.15 or later
- 100MB free disk space

For support: https://github.com/yourusername/cuepoint
EOF

# Step 5: Create DMG with layout
hdiutil create -volname "${APP_NAME}" \
    -srcfolder "${DMG_DIR}" \
    -ov -format UDRW \
    -fs HFS+ \
    "${TEMP_DIR}/${DMG_NAME}-temp.dmg"

# Step 6: Mount and configure layout
MOUNT_POINT="/Volumes/${APP_NAME}"
hdiutil attach "${TEMP_DIR}/${DMG_NAME}-temp.dmg" -mountpoint "$MOUNT_POINT" -readwrite

# Configure layout with AppleScript
osascript <<EOF
tell application "Finder"
    tell disk "${APP_NAME}"
        open
        set current view of container window to icon view
        set toolbar visible of container window to false
        set statusbar visible of container window to false
        set bounds of container window to {400, 100, 900, 420}
        
        set view options of container window to icon view options
        set icon size of view options to 72
        
        set position of item "CuePoint.app" to {120, 205}
        set position of item "Applications" to {380, 205}
        
        close
        open
        update without registering applications
        delay 1
    end tell
end tell
EOF

# Step 7: Unmount and compress
hdiutil detach "$MOUNT_POINT"
hdiutil convert "${TEMP_DIR}/${DMG_NAME}-temp.dmg" \
    -format UDZO \
    -imagekey zlib-level=9 \
    -o "dist/${DMG_NAME}.dmg"

# Step 8: Cleanup
rm -rf "${TEMP_DIR}"

echo "DMG created: dist/${DMG_NAME}.dmg"
```

### Example 2: Complete Windows Installer Workflow
```nsis
# Complete NSIS installer with all features
!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"

# Application metadata
Name "CuePoint"
OutFile "CuePoint-v${VERSION}-windows-x64-setup.exe"
InstallDir "$LOCALAPPDATA\CuePoint"
RequestExecutionLevel user

# Version info
VIProductVersion "${VERSION}.0"
VIAddVersionKey "ProductName" "CuePoint"
VIAddVersionKey "FileDescription" "CuePoint Installer"
VIAddVersionKey "FileVersion" "${VERSION}"
VIAddVersionKey "ProductVersion" "${VERSION}"
VIAddVersionKey "CompanyName" "StuChain"
VIAddVersionKey "LegalCopyright" "Copyright © 2024 StuChain"

# UI customization
!define MUI_ICON "resources\icon.ico"
!define MUI_UNICON "resources\icon.ico"
!define MUI_HEADERIMAGE
!define MUI_HEADERIMAGE_BITMAP "resources\header.bmp"
!define MUI_WELCOMEFINISHPAGE_BITMAP "resources\wizard.bmp"
!define MUI_ABORTWARNING

# Pages
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "LICENSE.txt"
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!define MUI_FINISHPAGE_RUN "$INSTDIR\CuePoint.exe"
!define MUI_FINISHPAGE_RUN_TEXT "Launch CuePoint"
!define MUI_FINISHPAGE_SHOWREADME "$INSTDIR\README.txt"
!define MUI_FINISHPAGE_SHOWREADME_TEXT "View README"
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

!insertmacro MUI_LANGUAGE "English"

# Installation
Section "Install" SecMain
    SetOutPath "$INSTDIR"
    File /r "dist\CuePoint\*"
    
    # Shortcuts
    CreateDirectory "$SMPROGRAMS\CuePoint"
    CreateShortcut "$SMPROGRAMS\CuePoint\CuePoint.lnk" "$INSTDIR\CuePoint.exe"
    CreateShortcut "$SMPROGRAMS\CuePoint\Uninstall.lnk" "$INSTDIR\uninstall.exe"
    
    # Uninstaller
    WriteUninstaller "$INSTDIR\uninstall.exe"
    
    # Registry
    WriteRegStr HKCU "Software\CuePoint" "InstallPath" "$INSTDIR"
    WriteRegStr HKCU "Software\CuePoint" "Version" "${VERSION}"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
        "DisplayName" "CuePoint"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
        "UninstallString" "$INSTDIR\uninstall.exe"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
        "DisplayVersion" "${VERSION}"
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
        "NoModify" 1
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint" \
        "NoRepair" 1
SectionEnd

# Uninstaller
Section "Uninstall"
    RMDir /r "$INSTDIR"
    RMDir /r "$SMPROGRAMS\CuePoint"
    DeleteRegKey HKCU "Software\CuePoint"
    DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\CuePoint"
    
    MessageBox MB_YESNO|MB_ICONQUESTION \
        "Delete user data and settings?" IDNO skip_data
    RMDir /r "$APPDATA\CuePoint"
    RMDir /r "$LOCALAPPDATA\CuePoint"
    skip_data:
SectionEnd

# Check for existing installation
Function .onInit
    ReadRegStr $R0 HKCU "Software\CuePoint" "InstallPath"
    ${If} $R0 != ""
        MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION \
            "CuePoint is already installed at:$\n$R0$\n$\nClick OK to reinstall or Cancel to exit." \
            IDOK continue_install
        Abort
        continue_install:
    ${EndIf}
FunctionEnd
```

## Distribution Quality Assurance

### Pre-Release Testing Checklist
- [ ] DMG mounts on clean macOS system
- [ ] App launches from Applications folder
- [ ] Gatekeeper accepts app (notarized)
- [ ] Installer runs on clean Windows system
- [ ] App launches after installation
- [ ] Shortcuts created correctly
- [ ] Uninstaller works correctly
- [ ] User data preserved on uninstall
- [ ] No Python required
- [ ] All dependencies included

### Distribution Validation Script
```python
# scripts/validate_distribution_complete.py
"""Complete distribution validation"""
from pathlib import Path
import subprocess
import platform

def validate_complete_distribution():
    """Validate all distribution artifacts"""
    artifacts_dir = Path("dist")
    
    # Check for required artifacts
    dmgs = list(artifacts_dir.glob("*.dmg"))
    installers = list(artifacts_dir.glob("*-setup.exe"))
    
    if not dmgs:
        print("ERROR: macOS DMG not found")
        return False
    
    if not installers:
        print("ERROR: Windows installer not found")
        return False
    
    # Validate each artifact
    all_valid = True
    
    for dmg in dmgs:
        valid, errors = validate_macos_dmg_complete(dmg)
        if not valid:
            print(f"ERROR: DMG validation failed: {errors}")
            all_valid = False
    
    for installer in installers:
        valid, errors = validate_windows_installer_complete(installer)
        if not valid:
            print(f"ERROR: Installer validation failed: {errors}")
            all_valid = False
    
    return all_valid

def validate_macos_dmg_complete(dmg_path: Path) -> tuple[bool, list[str]]:
    """Complete macOS DMG validation"""
    errors = []
    
    # Basic checks
    if not dmg_path.exists():
        errors.append("DMG file not found")
        return False, errors
    
    # Mount and verify
    # ... (implementation)
    
    return len(errors) == 0, errors
```

## References

- Main document: `../01_Product_Requirements_and_Definition.md`
- Related: Step 1.4 (Outcomes), Step 1.5 (Platforms), Step 2-4 (Packaging)
- DMG Creation: `hdiutil` documentation
- NSIS: https://nsis.sourceforge.io/
- Code Signing: Apple Developer Documentation, Microsoft Documentation

