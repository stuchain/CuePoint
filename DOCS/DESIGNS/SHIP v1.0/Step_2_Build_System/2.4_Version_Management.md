# Implementation Step 2.4: Version Management

## Implementation Overview
**What We're Building**: A comprehensive version management system that provides a single source of truth for version information, automatically injects build identifiers during CI builds, validates version consistency across all artifacts, and embeds version information in all build outputs for both macOS and Windows platforms.

## Implementation Tasks

### Task 2.4.1: Create Version Definition File

**What to Build**
- Version file as single source of truth
- Version embedding in builds
- Build identifier system
- Version access API

**Implementation Details**

**2.4.1.1 Version File Structure**
- **File to Create/Verify**: `SRC/cuepoint/version.py`
- **Status**: Already exists (from Step 1.7)
- **Purpose**: Single source of truth for version
- **Current Implementation**: The file exists with comprehensive version management
- **Key Components**:
  - `__version__`: Semantic version string (MAJOR.MINOR.PATCH)
  - `__build_number__`: Build identifier (set during CI)
  - `__commit_sha__`: Git commit SHA (set during CI)
  - `__build_date__`: Build timestamp (set during CI)
  - Helper functions for version access
- **Usage**: Imported throughout app and build scripts
- **Example Usage**:
  ```python
  from cuepoint.version import __version__, get_version_string, get_build_info
  
  # Get version
  version = __version__  # "1.0.0"
  full_version = get_version_string()  # "1.0.0.123" (with build number)
  build_info = get_build_info()  # Complete build information dict
  ```

**2.4.1.2 Version File Validation**
- **Validation Requirements**:
  - Version must follow SemVer format (X.Y.Z)
  - Version must be parseable
  - Build identifiers can be None (for dev builds)
  - All helper functions must work correctly
- **Test Script**: `SRC/tests/unit/test_version.py` (should exist)
- **Validation**: Run `python -m pytest SRC/tests/unit/test_version.py`

**2.4.1.3 Version File Maintenance**
- **Update Process**:
  1. Edit `SRC/cuepoint/version.py`
  2. Update `__version__` constant
  3. Run validation: `python scripts/validate_version.py`
  4. Commit changes
  5. Tag release: `git tag vX.Y.Z`
- **Automation**: Version updates should be manual (human decision)
- **Documentation**: Version changes should be documented in CHANGELOG

### Task 2.4.2: Build Info Injection System

**What to Build**
- Build info injection script
- CI integration
- Build identifier generation
- Build info validation

**Implementation Details**

**2.4.2.1 Build Info Injection Script**
- **File to Verify/Create**: `scripts/set_build_info.py`
- **Status**: Already exists
- **Purpose**: Inject build identifiers into version.py during CI builds
- **Current Implementation**: Script exists and handles:
  - Git commit SHA extraction
  - Build number from CI environment
  - Build date generation
  - Version file modification
- **Key Features**:
  - Reads git commit SHA
  - Gets build number from CI (GITHUB_RUN_NUMBER, BUILD_NUMBER, etc.)
  - Generates build date
  - Updates version.py with build info
  - Handles errors gracefully
- **Usage**: `python scripts/set_build_info.py`
- **Integration**: Called in CI workflows before build

**2.4.2.2 Build Number Generation**
- **Priority Order**:
  1. `GITHUB_RUN_NUMBER` (GitHub Actions)
  2. `BUILD_NUMBER` (Generic CI)
  3. `GITHUB_RUN_ID` (GitHub Actions fallback)
  4. Date-based: `YYYYMMDDHHMM` (local builds)
- **Format**: String (allows CI-specific formats)
- **Storage**: In `__build_number__` in version.py

**2.4.2.3 Commit SHA Extraction**
- **Method**: `git rev-parse HEAD`
- **Format**: Full 40-character SHA
- **Fallback**: None if git unavailable (dev builds)
- **Storage**: In `__commit_sha__` in version.py
- **Short SHA**: First 8 characters available via `get_short_commit_sha()`

**2.4.2.4 Build Date Generation**
- **Format**: ISO 8601 (`YYYY-MM-DDTHH:MM:SS.microseconds`)
- **Timezone**: UTC (recommended) or local
- **Storage**: In `__build_date__` in version.py
- **Usage**: For build traceability

**2.4.2.5 CI Integration**
- **GitHub Actions Integration**:
  ```yaml
  - name: Set build info
    run: |
      python scripts/set_build_info.py
    env:
      GITHUB_RUN_NUMBER: ${{ github.run_number }}
      GITHUB_RUN_ID: ${{ github.run_id }}
  ```
- **Other CI Systems**: Script detects common environment variables
- **Local Builds**: Uses date-based build number

**2.4.2.6 Build Info Validation**
- **Validation Checks**:
  - Version file exists and is readable
  - Build info successfully injected
  - Build identifiers are valid format
  - No syntax errors in modified version.py
- **Validation Script**: Part of `scripts/validate_version.py`
- **Failure Handling**: Build fails if validation fails

### Task 2.4.3: Version Validation System

**What to Build**
- Version format validation
- Version consistency checking
- Cross-file version validation
- Git tag validation

**Implementation Details**

**2.4.3.1 Version Validation Script**
- **File to Verify/Create**: `scripts/validate_version.py`
- **Status**: Already exists
- **Purpose**: Validate version format and consistency
- **Current Implementation**: Script validates:
  - SemVer format (X.Y.Z)
  - Version component ranges
  - Consistency between version.py and git tags
  - Consistency with pyproject.toml (if exists)
- **Usage**: `python scripts/validate_version.py`
- **Integration**: Called in CI before build

**2.4.3.2 SemVer Format Validation**
- **Pattern**: `^\d+\.\d+\.\d+$`
- **Components**:
  - Major: 0-100 (reasonable limit)
  - Minor: 0-100 (reasonable limit)
  - Patch: 0-1000 (reasonable limit)
- **Validation**: Rejects non-SemVer formats
- **Error Messages**: Clear, actionable

**2.4.3.3 Version Consistency Checking**
- **Sources Checked**:
  1. `SRC/cuepoint/version.py` (primary)
  2. Git tags (latest `v*` tag)
  3. `pyproject.toml` (if exists)
  4. Build artifacts (post-build)
- **Validation Logic**:
  - All sources must match (or be absent)
  - Git tag should match version.py (if tag exists)
  - pyproject.toml should match (if exists)
- **Error Reporting**: Lists all inconsistencies

**2.4.3.4 Git Tag Validation**
- **Tag Format**: `vX.Y.Z` (matches SemVer)
- **Latest Tag**: Determined by version sorting
- **Comparison**: Latest tag should match or be less than version.py
- **New Releases**: Version should be greater than latest tag
- **Validation**: Prevents version regressions

**2.4.3.5 CI Integration**
- **Pre-Build Validation**:
  ```yaml
  - name: Validate version
    run: |
      python scripts/validate_version.py
  ```
- **Post-Build Validation**: Check version in artifacts
- **Failure Handling**: Build fails if validation fails

### Task 2.4.4: Version Integration in Build Pipeline

**What to Build**
- PyInstaller version integration
- macOS Info.plist version processing
- Windows version info file generation
- Version embedding in all artifacts

**Implementation Details**

**2.4.4.1 PyInstaller Version Integration**
- **File to Modify**: `build/pyinstaller.spec`
- **Purpose**: Embed version in PyInstaller builds
- **Implementation**:
  ```python
  # At top of pyinstaller.spec
  import sys
  from pathlib import Path
  
  # Add SRC to path
  sys.path.insert(0, str(Path('SRC').resolve()))
  
  # Import version
  from cuepoint.version import __version__, __build_number__
  
  # Use version in build
  # For macOS: version goes in Info.plist (handled separately)
  # For Windows: version goes in version_info.txt
  ```
- **macOS**: Version embedded via Info.plist (see 2.4.4.2)
- **Windows**: Version embedded via version_info.txt (see 2.4.4.3)
- **Integration**: Version read at build time, embedded in artifacts

**2.4.4.2 macOS Info.plist Processing**
- **File to Create**: `scripts/process_info_plist.py`
- **Purpose**: Process Info.plist template with version
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Process Info.plist template with version information"""
  import sys
  from pathlib import Path
  
  # Add SRC to path
  sys.path.insert(0, str(Path('SRC').resolve()))
  from cuepoint.version import __version__, __build_number__
  
  def process_info_plist():
      """Process Info.plist template"""
      template_path = Path("build/Info.plist.template")
      output_path = Path("build/Info.plist")
      
      if not template_path.exists():
          print(f"Error: Template not found: {template_path}")
          sys.exit(1)
      
      # Read template
      content = template_path.read_text()
      
      # Replace placeholders
      content = content.replace("{{VERSION}}", __version__)
      content = content.replace("{{BUILD_NUMBER}}", __build_number__ or "1")
      content = content.replace("{{SHORT_COMMIT}}", get_short_commit_sha() or "")
      
      # Write output
      output_path.write_text(content)
      print(f"Processed Info.plist: {output_path}")
  
  if __name__ == '__main__':
      process_info_plist()
  ```
- **Template File**: `build/Info.plist.template`
- **Output File**: `build/Info.plist` (used by PyInstaller)
- **Placeholders**:
  - `{{VERSION}}`: Semantic version
  - `{{BUILD_NUMBER}}`: Build number
  - `{{SHORT_COMMIT}}`: Short commit SHA (optional)
- **Integration**: Called before PyInstaller build on macOS

**2.4.4.3 Windows Version Info File**
- **File to Create**: `scripts/generate_version_info.py`
- **Purpose**: Generate Windows version_info.txt
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Generate Windows version_info.txt"""
  import sys
  from pathlib import Path
  
  # Add SRC to path
  sys.path.insert(0, str(Path('SRC').resolve()))
  from cuepoint.version import __version__, __build_number__
  
  def generate_version_info():
      """Generate version_info.txt for Windows"""
      version_parts = __version__.split('.')
      major, minor, patch = map(int, version_parts)
      build = int(__build_number__ or "0")
      
      template = f"""VSVersionInfo(
    ffi=FixedFileInfo(
      filevers=({major}, {minor}, {patch}, {build}),
      prodvers=({major}, {minor}, {patch}, {build}),
      mask=0x3f,
      flags=0x0,
      OS=0x40004,
      fileType=0x1,
      subtype=0x0,
      date=(0, 0)
    ),
    kids=[
      StringFileInfo([
        StringTable('040904B0', [
          StringStruct('CompanyName', 'CuePoint'),
          StringStruct('FileDescription', 'CuePoint - Rekordbox Metadata Enricher'),
          StringStruct('FileVersion', '{__version__}'),
          StringStruct('InternalName', 'CuePoint'),
          StringStruct('LegalCopyright', 'Copyright © 2024 CuePoint'),
          StringStruct('OriginalFilename', 'CuePoint.exe'),
          StringStruct('ProductName', 'CuePoint'),
          StringStruct('ProductVersion', '{__version__}')
        ])
      ]),
      VarFileInfo([VarStruct('Translation', [1033, 1200])])
    ]
  )
  """
      
      output_path = Path("build/version_info.txt")
      output_path.write_text(template)
      print(f"Generated version_info.txt: {output_path}")
  
  if __name__ == '__main__':
      generate_version_info()
  ```
- **Output File**: `build/version_info.txt`
- **Usage**: Referenced in pyinstaller.spec for Windows builds
- **Integration**: Called before PyInstaller build on Windows

**2.4.4.4 Version Embedding Verification**
- **File to Create**: `scripts/verify_version_embedding.py`
- **Purpose**: Verify version is embedded in artifacts
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Verify version embedding in artifacts"""
  import sys
  import subprocess
  from pathlib import Path
  
  # Add SRC to path
  sys.path.insert(0, str(Path('SRC').resolve()))
  from cuepoint.version import __version__
  
  def verify_macos_version(app_path):
      """Verify version in macOS app"""
      plist_path = Path(app_path) / "Contents" / "Info.plist"
      if not plist_path.exists():
          return False, "Info.plist not found"
      
      # Read plist
      result = subprocess.run(
          ['plutil', '-p', str(plist_path)],
          capture_output=True,
          text=True
      )
      
      if __version__ not in result.stdout:
          return False, f"Version {__version__} not found in Info.plist"
      
      return True, "Version verified"
  
  def verify_windows_version(exe_path):
      """Verify version in Windows exe"""
      # Use signtool or other tool to read version
      result = subprocess.run(
          ['signtool', 'verify', '/pa', '/v', str(exe_path)],
          capture_output=True,
          text=True
      )
      
      # Check version in output
      if __version__ not in result.stdout:
          return False, f"Version {__version__} not found in executable"
      
      return True, "Version verified"
  
  def main():
      """Main verification"""
      errors = []
      
      # Check macOS app
      app_path = Path("dist/CuePoint.app")
      if app_path.exists():
          success, message = verify_macos_version(app_path)
          if not success:
              errors.append(f"macOS: {message}")
      
      # Check Windows exe
      exe_path = Path("dist/CuePoint.exe")
      if exe_path.exists():
          success, message = verify_windows_version(exe_path)
          if not success:
              errors.append(f"Windows: {message}")
      
      if errors:
          print("Version embedding verification failed:")
          for error in errors:
              print(f"  {error}")
          sys.exit(1)
      
      print("✓ Version embedding verified")
  
  if __name__ == '__main__':
      main()
  ```

### Task 2.4.5: Version Access in Application

**What to Build**
- Version display in UI
- Version in about dialog
- Version in diagnostics
- Version API for other components

**Implementation Details**

**2.4.5.1 Version Display in UI**
- **Location**: About dialog, Help menu
- **Implementation**:
  ```python
  from cuepoint.version import get_version_display_string
  
  # In about dialog
  version_label.setText(get_version_display_string())
  # Example: "Version 1.0.0 (Build 123) - abc12345"
  ```
- **Format**: User-friendly version string
- **Components**: Version, build number, commit SHA

**2.4.5.2 Version in Diagnostics**
- **Location**: Diagnostics/support bundle
- **Implementation**:
  ```python
  from cuepoint.version import get_build_info
  
  # In diagnostics
  diagnostics = {
      "version_info": get_build_info(),
      # ... other diagnostics
  }
  ```
- **Purpose**: Help with troubleshooting
- **Format**: Complete build information dictionary

**2.4.5.3 Version API**
- **Functions Available**:
  - `get_version()`: Base version
  - `get_version_string()`: Version with build number
  - `get_build_number()`: Build number
  - `get_commit_sha()`: Full commit SHA
  - `get_short_commit_sha()`: Short commit SHA
  - `get_build_date()`: Build date
  - `get_build_info()`: Complete build info dict
  - `is_dev_build()`: Check if dev build
  - `get_version_display_string()`: User-friendly string
- **Usage**: Import from `cuepoint.version`

### Task 2.4.6: Version Release Process

**What to Build**
- Version bump process
- Release tagging
- Version validation in release
- Version documentation

**Implementation Details**

**2.4.6.1 Version Bump Process**
- **Steps**:
  1. Update `SRC/cuepoint/version.py`
  2. Update `__version__` to new version
  3. Run validation: `python scripts/validate_version.py`
  4. Commit version change
  5. Create release tag: `git tag vX.Y.Z`
  6. Push tag: `git push origin vX.Y.Z`
- **Automation**: Script can automate steps 1-3
- **Manual Steps**: Version decision and tagging are manual

**2.4.6.2 Release Tagging**
- **Tag Format**: `vX.Y.Z` (matches SemVer)
- **Tag Creation**:
  ```bash
  git tag -a v1.0.0 -m "Release version 1.0.0"
  git push origin v1.0.0
  ```
- **Validation**: Tag must match version.py
- **CI Trigger**: Tag push triggers release workflow

**2.4.6.3 Version Validation in Release**
- **Pre-Release Checks**:
  1. Version format valid
  2. Version consistent across files
  3. Version greater than previous release
  4. Tag matches version
- **Automation**: All checks in CI
- **Failure**: Release blocked if validation fails

**2.4.6.4 Version Documentation**
- **CHANGELOG**: Document version changes
- **Release Notes**: Include version in release notes
- **Version History**: Track version history
- **Breaking Changes**: Document in CHANGELOG

## Implementation Checklist

### Version System
- [x] Create version.py (Step 1.7 - already exists)
- [x] Create build info script (Step 1.7 - already exists)
- [x] Create version validation (Step 1.7 - already exists)
- [ ] Create Info.plist processing script
- [ ] Create Windows version_info generation script
- [ ] Create version embedding verification script
- [ ] Integrate in PyInstaller spec
- [ ] Integrate in CI workflows
- [ ] Test version embedding
- [ ] Document version process

### Version Integration
- [ ] Version in PyInstaller builds
- [ ] Version in macOS Info.plist
- [ ] Version in Windows executable
- [ ] Version in UI display
- [ ] Version in diagnostics

### Version Validation
- [ ] Pre-build validation
- [ ] Post-build validation
- [ ] Artifact version verification
- [ ] CI integration

## Files to Create/Modify

### New Files
1. `scripts/process_info_plist.py` - Info.plist processing
2. `scripts/generate_version_info.py` - Windows version info
3. `scripts/verify_version_embedding.py` - Version verification
4. `build/Info.plist.template` - Info.plist template

### Files to Modify
1. `build/pyinstaller.spec` - Add version reading
2. `.github/workflows/build-macos.yml` - Call version scripts
3. `.github/workflows/build-windows.yml` - Call version scripts
4. `SRC/cuepoint/ui/dialogs/about_dialog.py` - Display version (if exists)

### Existing Files (Verify)
1. `SRC/cuepoint/version.py` - Version definition (exists)
2. `scripts/set_build_info.py` - Build info injection (exists)
3. `scripts/validate_version.py` - Version validation (exists)

## Implementation Dependencies

### Prerequisites
- Step 1.7: Versioning (defines version system)
- Step 2.1: Goals and Principles (defines requirements)
- Step 2.2: Tooling Choices (uses build tools)
- Step 2.3: Repository Hygiene (clean repository)

### Enables
- Step 2.5: CI Structure (uses version)
- Step 3: macOS Packaging (uses version)
- Step 4: Windows Packaging (uses version)
- Step 5: Auto-update (uses version)

## Success Criteria

### Version Management
- ✅ Single source of truth (version.py)
- ✅ Version embedded in all artifacts
- ✅ Build identifiers set correctly
- ✅ Version validation passes
- ✅ Version consistent across files
- ✅ Version accessible in application
- ✅ Version displayed in UI

### Build Integration
- ✅ Version read during build
- ✅ Version embedded in macOS app
- ✅ Version embedded in Windows exe
- ✅ Version verification passes
- ✅ Build info injected correctly

### Release Process
- ✅ Version bump process documented
- ✅ Release tagging works
- ✅ Version validation in CI
- ✅ Version in release notes

## Next Implementation Steps

After completing Step 2.4:
1. **Step 2.5**: CI Structure (uses version in workflows)
2. **Step 3**: macOS Packaging (uses version in Info.plist)
3. **Step 4**: Windows Packaging (uses version in executable)
4. **Step 5**: Auto-update (uses version in appcast)

## Detailed Implementation Guidance

### Version File Best Practices

#### Version Format
- **SemVer**: MAJOR.MINOR.PATCH
- **Examples**: `1.0.0`, `1.1.0`, `2.0.0`
- **Pre-release**: Not used in v1.0 (can add later)
- **Build metadata**: Handled separately (build_number)

#### Version Bumping Rules
- **MAJOR**: Breaking changes
- **MINOR**: New features, backward compatible
- **PATCH**: Bug fixes, backward compatible

#### Build Identifiers
- **Build Number**: CI-generated or date-based
- **Commit SHA**: Full git commit hash
- **Build Date**: ISO 8601 timestamp
- **Optional**: All can be None for dev builds

### Build Info Injection Details

#### CI Environment Variables
- **GitHub Actions**:
  - `GITHUB_RUN_NUMBER`: Sequential build number
  - `GITHUB_RUN_ID`: Unique run ID
- **Generic CI**:
  - `BUILD_NUMBER`: Build number
- **Fallback**: Date-based (`YYYYMMDDHHMM`)

#### Error Handling
- **Git unavailable**: Commit SHA is None
- **CI vars unavailable**: Uses fallback
- **File write fails**: Script exits with error
- **Validation fails**: Build fails

### Version Validation Details

#### Validation Checks
1. **Format**: SemVer pattern match
2. **Components**: Reasonable ranges
3. **Consistency**: Matches git tags
4. **Consistency**: Matches pyproject.toml
5. **Progression**: Newer than previous release

#### Validation Failure Handling
- **Pre-build**: Build blocked
- **Post-build**: Artifact rejected
- **Error Messages**: Clear and actionable
- **CI Integration**: Fails workflow

### Version Embedding Details

#### macOS Embedding
- **Location**: `Info.plist`
- **Keys**:
  - `CFBundleShortVersionString`: Version
  - `CFBundleVersion`: Build number
- **Process**: Template → Processing → PyInstaller
- **Verification**: Read from built app

#### Windows Embedding
- **Location**: Executable metadata
- **Format**: `version_info.txt` → PyInstaller
- **Fields**: File version, product version
- **Verification**: Read from executable

### Version Access Patterns

#### In Application Code
```python
from cuepoint.version import __version__, get_build_info

# Simple version
version = __version__

# Complete info
info = get_build_info()
```

#### In UI
```python
from cuepoint.version import get_version_display_string

# User-friendly display
version_text = get_version_display_string()
```

#### In Diagnostics
```python
from cuepoint.version import get_build_info

# Include in diagnostics
diagnostics['version'] = get_build_info()
```

### Release Process Details

#### Version Bump Workflow
1. **Decision**: Choose new version
2. **Update**: Edit version.py
3. **Validate**: Run validation script
4. **Commit**: Commit version change
5. **Tag**: Create release tag
6. **Push**: Push tag to trigger release

#### Tag Naming
- **Format**: `vX.Y.Z`
- **Examples**: `v1.0.0`, `v1.1.0`, `v2.0.0`
- **Validation**: Must match version.py
- **CI Trigger**: Tag push triggers release

#### Release Validation
- **Pre-release**: Version validation
- **Post-build**: Artifact validation
- **Post-release**: Version verification
- **All must pass**: Release blocked on failure

## References

- Main document: `../02_Build_System_and_Release_Pipeline.md`
- Related: Step 1.7 (Versioning), Step 2.5 (CI Structure)
- SemVer: https://semver.org/
- Version file: `SRC/cuepoint/version.py`
- Build script: `scripts/set_build_info.py`
- Validation script: `scripts/validate_version.py`

