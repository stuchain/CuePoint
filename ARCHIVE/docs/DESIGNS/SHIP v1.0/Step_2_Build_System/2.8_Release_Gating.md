# Implementation Step 2.8: Release Gating

## Implementation Overview
**What We're Building**: A comprehensive release gating system that validates all aspects of a release before publication, including tests, build artifacts, signing, notarization, version consistency, and update feeds. This ensures only high-quality, properly signed, and validated releases are published to users.

## Implementation Tasks

### Task 2.8.1: Define Pre-Release Checks

**What to Build**
- List of required pre-release checks
- Check validation criteria
- Check automation
- Check failure handling

**Implementation Details**

**2.8.1.1 Test Validation**
- **Requirement**: All tests must pass
- **Scope**: Unit tests, integration tests, UI tests
- **Platforms**: macOS and Windows
- **Validation**:
  - Test suite runs successfully
  - All tests pass (no failures)
  - Coverage meets threshold (if set)
  - No test timeouts
- **Automation**: CI workflow runs tests automatically
- **Failure**: Release blocked if tests fail
- **Script**: `scripts/validate_tests.py`

**2.8.1.2 Build Artifact Validation**
- **Requirement**: All required artifacts created
- **Artifacts**:
  - macOS DMG
  - Windows installer
  - Optional: Portable versions, source archives
- **Validation**:
  - Artifacts exist
  - Artifacts are readable
  - Artifacts have correct size (> 0 bytes)
  - Artifacts match naming convention
- **Automation**: Post-build validation script
- **Failure**: Release blocked if artifacts missing or invalid
- **Script**: `scripts/validate_artifacts.py`

**2.8.1.3 Code Signing Validation**
- **Requirement**: All artifacts must be signed
- **macOS**:
  - App bundle signed
  - DMG signed (if applicable)
  - Signatures verified
- **Windows**:
  - Executable signed
  - Installer signed
  - Signatures verified
- **Validation**:
  - Signatures present
  - Signatures valid
  - Signatures not expired
  - Signing identity correct
- **Automation**: Post-signing validation
- **Failure**: Release blocked if signing fails
- **Script**: `scripts/validate_signing.py`

**2.8.1.4 Notarization Validation (macOS)**
- **Requirement**: macOS artifacts must be notarized
- **Scope**: DMG file
- **Validation**:
  - Notarization submitted
  - Notarization approved
  - Stapling successful
  - Validation passes
- **Automation**: Post-notarization validation
- **Failure**: Release blocked if notarization fails
- **Script**: `scripts/validate_notarization.py`

**2.8.1.5 Version Consistency Validation**
- **Requirement**: Version consistent across all files
- **Sources**:
  - `SRC/cuepoint/version.py`
  - Git tag
  - Artifact metadata
  - Update feeds
- **Validation**:
  - All sources have same version
  - Version format valid (SemVer)
  - Version greater than previous release
- **Automation**: Pre-release validation
- **Failure**: Release blocked if version inconsistent
- **Script**: `scripts/validate_version.py` (exists)

**2.8.1.6 Update Feed Validation**
- **Requirement**: Update feeds must be valid
- **Feeds**:
  - macOS appcast.xml
  - Windows appcast.json
- **Validation**:
  - Feed files exist
  - Feed format valid (XML/JSON)
  - Feed contains current release
  - Feed URLs accessible
  - Feed signatures valid (if applicable)
- **Automation**: Post-feed generation validation
- **Failure**: Release blocked if feeds invalid
- **Script**: `scripts/validate_feeds.py`

**2.8.1.7 Release Notes Validation**
- **Requirement**: Release notes must exist
- **Validation**:
  - Release notes file exists
  - Release notes contain version
  - Release notes contain date
  - Release notes are readable
- **Automation**: Pre-release validation
- **Failure**: Warning only (doesn't block release)
- **Script**: `scripts/validate_release_notes.py`

### Task 2.8.2: Implement Validation Scripts

**What to Build**
- Test validation script
- Artifact validation script
- Signing validation script
- Notarization validation script
- Feed validation script
- Release notes validation script
- Master validation script

**Implementation Details**

**2.8.2.1 Test Validation Script**
- **File to Create**: `scripts/validate_tests.py`
- **Purpose**: Validate all tests pass
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Validate all tests pass"""
  import subprocess
  import sys
  
  def validate_tests():
      """Run tests and validate they pass"""
      # Run pytest
      result = subprocess.run(
          ['pytest', 'SRC/tests/', '-v', '--tb=short'],
          capture_output=True,
          text=True
      )
      
      if result.returncode != 0:
          print("ERROR: Tests failed")
          print(result.stdout)
          print(result.stderr)
          return False
      
      # Check coverage if configured
      # ...
      
      print("✓ All tests passed")
      return True
  
  if __name__ == '__main__':
      if not validate_tests():
          sys.exit(1)
  ```

**2.8.2.2 Artifact Validation Script**
- **File to Create**: `scripts/validate_artifacts.py`
- **Purpose**: Validate build artifacts
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Validate build artifacts"""
  import sys
  from pathlib import Path
  
  REQUIRED_ARTIFACTS = {
      'macos': ['CuePoint-v*-macos-universal.dmg'],
      'windows': ['CuePoint-v*-windows-x64-setup.exe'],
  }
  
  def validate_artifacts(platform):
      """Validate artifacts for platform"""
      errors = []
      artifacts = REQUIRED_ARTIFACTS.get(platform, [])
      
      for pattern in artifacts:
          matches = list(Path('dist').glob(pattern))
          if not matches:
              errors.append(f"Missing artifact: {pattern}")
              continue
          
          for artifact in matches:
              if not artifact.exists():
                  errors.append(f"Artifact not found: {artifact}")
              elif artifact.stat().st_size == 0:
                  errors.append(f"Artifact is empty: {artifact}")
      
      if errors:
          print("ERROR: Artifact validation failed:")
          for error in errors:
              print(f"  {error}")
          return False
      
      print(f"✓ All {platform} artifacts validated")
      return True
  
  if __name__ == '__main__':
      platform = sys.argv[1] if len(sys.argv) > 1 else 'all'
      # Validate for platform
  ```

**2.8.2.3 Signing Validation Script**
- **File to Create**: `scripts/validate_signing.py`
- **Purpose**: Validate code signing
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Validate code signing"""
  import subprocess
  import sys
  from pathlib import Path
  
  def validate_macos_signing(app_path):
      """Validate macOS app signing"""
      result = subprocess.run(
          ['codesign', '--verify', '--verbose', str(app_path)],
          capture_output=True,
          text=True
      )
      
      if result.returncode != 0:
          print(f"ERROR: Signing validation failed for {app_path}")
          print(result.stderr)
          return False
      
      # Check signature details
      result = subprocess.run(
          ['codesign', '-dvv', str(app_path)],
          capture_output=True,
          text=True
      )
      
      # Verify identity
      if 'Developer ID Application' not in result.stdout:
          print(f"ERROR: Invalid signing identity")
          return False
      
      return True
  
  def validate_windows_signing(exe_path):
      """Validate Windows executable signing"""
      result = subprocess.run(
          ['signtool', 'verify', '/pa', '/v', str(exe_path)],
          capture_output=True,
          text=True
      )
      
      if result.returncode != 0:
          print(f"ERROR: Signing validation failed for {exe_path}")
          print(result.stdout)
          return False
      
      return True
  
  if __name__ == '__main__':
      # Validate based on platform
      pass
  ```

**2.8.2.4 Notarization Validation Script**
- **File to Create**: `scripts/validate_notarization.py`
- **Purpose**: Validate macOS notarization
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Validate macOS notarization"""
  import subprocess
  import sys
  from pathlib import Path
  
  def validate_notarization(dmg_path):
      """Validate DMG notarization"""
      # Check stapling
      result = subprocess.run(
          ['xcrun', 'stapler', 'validate', str(dmg_path)],
          capture_output=True,
          text=True
      )
      
      if result.returncode != 0:
          print(f"ERROR: Notarization validation failed for {dmg_path}")
          print(result.stderr)
          return False
      
      # Check notarization history
      # ...
      
      print(f"✓ Notarization validated for {dmg_path}")
      return True
  
  if __name__ == '__main__':
      dmg_path = sys.argv[1] if len(sys.argv) > 1 else 'dist/*.dmg'
      # Validate notarization
  ```

**2.8.2.5 Feed Validation Script**
- **File to Create**: `scripts/validate_feeds.py`
- **Purpose**: Validate update feeds
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Validate update feeds"""
  import json
  import xml.etree.ElementTree as ET
  import sys
  from pathlib import Path
  
  def validate_appcast(appcast_path):
      """Validate macOS appcast"""
      try:
          tree = ET.parse(appcast_path)
          root = tree.getroot()
          
          # Validate structure
          if root.tag != 'rss':
              return False, "Invalid root element"
          
          # Validate version
          # ...
          
          return True, "Appcast valid"
      except Exception as e:
          return False, str(e)
  
  def validate_update_feed(feed_path):
      """Validate Windows update feed"""
      try:
          with open(feed_path) as f:
              feed = json.load(f)
          
          # Validate structure
          if 'version' not in feed:
              return False, "Missing version"
          
          if 'downloads' not in feed:
              return False, "Missing downloads"
          
          return True, "Update feed valid"
      except Exception as e:
          return False, str(e)
  
  if __name__ == '__main__':
      # Validate feeds
      pass
  ```

**2.8.2.6 Master Validation Script**
- **File to Create**: `scripts/validate_release.py`
- **Purpose**: Run all validations
- **Implementation**:
  ```python
  #!/usr/bin/env python3
  """Master release validation script"""
  import sys
  import subprocess
  
  VALIDATIONS = [
      ('tests', 'scripts/validate_tests.py'),
      ('artifacts', 'scripts/validate_artifacts.py'),
      ('signing', 'scripts/validate_signing.py'),
      ('notarization', 'scripts/validate_notarization.py'),
      ('version', 'scripts/validate_version.py'),
      ('feeds', 'scripts/validate_feeds.py'),
  ]
  
  def validate_release():
      """Run all validations"""
      failures = []
      
      for name, script in VALIDATIONS:
          print(f"\nValidating {name}...")
          result = subprocess.run(['python', script], capture_output=True, text=True)
          
          if result.returncode != 0:
              failures.append(name)
              print(f"✗ {name} validation failed")
              print(result.stdout)
              print(result.stderr)
          else:
              print(f"✓ {name} validation passed")
      
      if failures:
          print(f"\nERROR: Release validation failed for: {', '.join(failures)}")
          return False
      
      print("\n✓ All release validations passed")
      return True
  
  if __name__ == '__main__':
      if not validate_release():
          sys.exit(1)
  ```

### Task 2.8.3: Implement CI Integration

**What to Build**
- Pre-release validation workflow
- Post-build validation steps
- Validation failure handling
- Validation reporting

**Implementation Details**

**2.8.3.1 Pre-Release Validation Workflow**
- **File to Create**: `.github/workflows/validate-release.yml`
- **Purpose**: Validate release before publishing
- **Implementation**:
  ```yaml
  name: Validate Release
  
  on:
    push:
      tags:
        - 'v*'
  
  jobs:
    validate:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'
        
        - name: Install dependencies
          run: |
            pip install -r requirements.txt
            pip install -r requirements-dev.txt
        
        - name: Validate version
          run: |
            python scripts/validate_version.py
        
        - name: Validate release notes
          run: |
            python scripts/validate_release_notes.py
  ```

**2.8.3.2 Post-Build Validation**
- **Integration**: Add to build workflows
- **macOS Build**:
  ```yaml
  - name: Validate artifacts
    run: |
      python scripts/validate_artifacts.py macos
  
  - name: Validate signing
    run: |
      python scripts/validate_signing.py macos
  
  - name: Validate notarization
    run: |
      python scripts/validate_notarization.py dist/*.dmg
  ```
- **Windows Build**:
  ```yaml
  - name: Validate artifacts
    run: |
      python scripts/validate_artifacts.py windows
  
  - name: Validate signing
    run: |
      python scripts/validate_signing.py windows
  ```

**2.8.3.3 Validation Failure Handling**
- **Fail Fast**: Stop on first validation failure
- **Clear Messages**: Provide actionable error messages
- **Logging**: Log all validation results
- **Notification**: Notify on validation failure

**2.8.3.4 Validation Reporting**
- **Summary**: Report all validation results
- **Details**: Include detailed error messages
- **Artifacts**: Save validation reports as artifacts
- **Dashboard**: Track validation history

### Task 2.8.4: Implement Rollback Procedures

**What to Build**
- Rollback procedures
- Rollback automation
- Rollback validation
- Rollback documentation

**Implementation Details**

**2.8.4.1 Rollback Procedures**
- **Step 1**: Remove from appcast (most important)
  - Edit `updates/macos/appcast.xml`
  - Remove release entry
  - Commit and push
- **Step 2**: Mark GitHub Release as draft/pre-release
  - Edit release in GitHub
  - Mark as draft or pre-release
- **Step 3**: Publish hotfix (if needed)
  - Create hotfix branch
  - Fix issues
  - Tag and release new version
  - Update appcast with new version

**2.8.4.2 Rollback Automation**
- **Script**: `scripts/rollback_release.py`
- **Functionality**:
  - Remove from appcast
  - Mark release as draft
  - Generate rollback report
- **Usage**: Manual execution (not automatic)

**2.8.4.3 Rollback Validation**
- **Verify**: Appcast updated
- **Verify**: Release marked correctly
- **Verify**: Users won't get bad version
- **Test**: Verify rollback works

**2.8.4.4 Rollback Documentation**
- **Document**: Rollback procedures
- **Document**: When to rollback
- **Document**: How to rollback
- **Document**: Rollback checklist

## Implementation Checklist

### Pre-Release Checks
- [ ] Define all required checks
- [ ] Document validation criteria
- [ ] Create validation scripts
- [ ] Test validation scripts

### Validation Scripts
- [ ] Test validation script
- [ ] Artifact validation script
- [ ] Signing validation script
- [ ] Notarization validation script
- [ ] Feed validation script
- [ ] Release notes validation script
- [ ] Master validation script

### CI Integration
- [ ] Pre-release validation workflow
- [ ] Post-build validation steps
- [ ] Validation failure handling
- [ ] Validation reporting

### Rollback
- [ ] Define rollback procedures
- [ ] Create rollback script
- [ ] Test rollback process
- [ ] Document rollback steps

## Files to Create/Modify

### New Files
1. `scripts/validate_tests.py` - Test validation
2. `scripts/validate_artifacts.py` - Artifact validation
3. `scripts/validate_signing.py` - Signing validation
4. `scripts/validate_notarization.py` - Notarization validation
5. `scripts/validate_feeds.py` - Feed validation
6. `scripts/validate_release_notes.py` - Release notes validation
7. `scripts/validate_release.py` - Master validation script
8. `scripts/rollback_release.py` - Rollback script
9. `.github/workflows/validate-release.yml` - Validation workflow

### Files to Modify
1. `.github/workflows/build-macos.yml` - Add post-build validation
2. `.github/workflows/build-windows.yml` - Add post-build validation
3. `.github/workflows/release.yml` - Add pre-release validation

## Implementation Dependencies

### Prerequisites
- Step 2.1: Goals and Principles (defines quality requirements)
- Step 2.2: Tooling Choices (uses validation tools)
- Step 2.4: Version Management (validates version)
- Step 2.5: CI Structure (uses workflows)
- Step 2.6: Artifact Structure (validates artifacts)
- Step 2.7: Secrets and Certificates (validates signing)

### Enables
- Step 3: macOS Packaging (validates packaging)
- Step 4: Windows Packaging (validates packaging)
- Step 5: Auto-Update (validates feeds)

## Success Criteria

### Validation
- ✅ All required checks implemented
- ✅ Validation scripts work correctly
- ✅ Validation integrated in CI
- ✅ Validation failures block release

### Rollback
- ✅ Rollback procedures defined
- ✅ Rollback script works
- ✅ Rollback tested
- ✅ Rollback documented

## Next Implementation Steps

After completing Step 2.8:
1. **Step 3**: macOS Packaging (uses validation)
2. **Step 4**: Windows Packaging (uses validation)
3. **Step 5**: Auto-Update (uses validation)

## References

- Main document: `../02_Build_System_and_Release_Pipeline.md`
- Related: Step 2.5 (CI Structure), Step 2.6 (Artifact Structure)
