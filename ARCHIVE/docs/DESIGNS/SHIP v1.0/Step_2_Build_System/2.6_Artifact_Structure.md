# Implementation Step 2.6: Artifact Structure

## Implementation Overview
**What We're Building**: Complete artifact organization system that defines how build artifacts are structured, named, stored, and published. This includes GitHub Release assets, update feed files, release notes, and all supporting files needed for distribution and auto-updates.

## Implementation Tasks

### Task 2.6.1: Define Artifact Naming Conventions

**What to Build**
- Artifact naming standards
- Version embedding in names
- Platform identification
- Architecture identification
- File type identification

**Implementation Details**

**2.6.1.1 Naming Convention Standard**
- **Format**: `{ProductName}-v{Version}-{Platform}-{Architecture}.{Extension}`
- **Components**:
  - ProductName: `CuePoint` (consistent)
  - Version: `1.0.0` (SemVer, no 'v' prefix in filename)
  - Platform: `macos` or `windows`
  - Architecture: `universal`, `arm64`, `x64`, `x86`
  - Extension: `.dmg`, `.exe`, `.msi`, `.zip`
- **Examples**:
  - `CuePoint-v1.0.0-macos-universal.dmg`
  - `CuePoint-v1.0.0-windows-x64-setup.exe`
  - `CuePoint-v1.0.0-windows-x64-portable.zip`
- **Rationale**:
  - Clear identification of product and version
  - Easy to sort and filter
  - Platform and architecture obvious
  - Consistent across all releases

**2.6.1.2 Version in Filename**
- **Format**: `v{MAJOR}.{MINOR}.{PATCH}`
- **Source**: From `SRC/cuepoint/version.py`
- **Embedding**: Extracted during build process
- **Validation**: Must match git tag format
- **Example**: `v1.0.0` → filename contains `1.0.0`

**2.6.1.3 Platform Identification**
- **macOS**: `macos` (lowercase, no hyphen)
- **Windows**: `windows` (lowercase, no hyphen)
- **Future**: `linux` (if needed)
- **Consistency**: Always lowercase, no spaces

**2.6.1.4 Architecture Identification**
- **macOS**:
  - `universal`: Universal binary (Intel + Apple Silicon)
  - `arm64`: Apple Silicon only
  - `x64`: Intel only
- **Windows**:
  - `x64`: 64-bit (default)
  - `x86`: 32-bit (if needed)
- **Default**: Use `universal` for macOS, `x64` for Windows

**2.6.1.5 File Type Identification**
- **macOS**:
  - `.dmg`: Disk image (installer)
  - `.zip`: Archive (alternative)
  - `.pkg`: Package installer (if needed)
- **Windows**:
  - `.exe`: Executable installer
  - `.msi`: MSI installer (if needed)
  - `.zip`: Portable archive
- **Convention**: Use standard extensions, no ambiguity

### Task 2.6.2: Define GitHub Release Asset Structure

**What to Build**
- Release asset organization
- Asset naming
- Asset metadata
- Asset validation

**Implementation Details**

**2.6.2.1 Release Asset Requirements**
- **Minimum Assets per Release**:
  1. macOS DMG: `CuePoint-vX.Y.Z-macos-universal.dmg`
  2. Windows Installer: `CuePoint-vX.Y.Z-windows-x64-setup.exe`
- **Optional Assets**:
  - Windows Portable: `CuePoint-vX.Y.Z-windows-x64-portable.zip`
  - Source Archive: `CuePoint-vX.Y.Z-source.zip`
  - Checksums: `CuePoint-vX.Y.Z-checksums.txt`
- **Asset Limits**: GitHub allows up to 2GB per file, 10GB total per release

**2.6.2.2 Asset Metadata**
- **Name**: Descriptive filename (see naming convention)
- **Label**: User-friendly label (optional)
- **Content Type**: MIME type (auto-detected)
- **Size**: File size in bytes
- **Download Count**: Tracked by GitHub
- **Upload Date**: Timestamp from release

**2.6.2.3 Asset Organization**
- **Primary Assets**: Installers (DMG, EXE)
- **Secondary Assets**: Portable versions, source archives
- **Supporting Assets**: Checksums, signatures, release notes
- **Grouping**: Group by platform or type

**2.6.2.4 Asset Validation**
- **Pre-Upload Validation**:
  - File exists and is readable
  - File size within limits
  - File name matches convention
  - File is signed (if required)
- **Post-Upload Validation**:
  - Asset appears in release
  - Asset is downloadable
  - Asset metadata correct
  - Asset integrity verified

### Task 2.6.3: Define Update Feed Structure

**What to Build**
- Appcast file format (macOS)
- Update feed format (Windows)
- Feed file location
- Feed file naming
- Feed file content

**Implementation Details**

**2.6.3.1 macOS Appcast Structure**
- **Format**: XML (Sparkle format)
- **Location**: `updates/macos/appcast.xml`
- **File Name**: `appcast.xml` (fixed name)
- **Structure**:
  ```xml
  <?xml version="1.0" encoding="utf-8"?>
  <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
    <channel>
      <title>CuePoint Updates</title>
      <link>https://github.com/user/repo</link>
      <description>Latest CuePoint releases</description>
      <item>
        <title>Version 1.0.0</title>
        <pubDate>Mon, 01 Jan 2024 00:00:00 +0000</pubDate>
        <sparkle:version>1.0.0</sparkle:version>
        <sparkle:shortVersionString>1.0.0</sparkle:shortVersionString>
        <enclosure url="https://github.com/user/repo/releases/download/v1.0.0/CuePoint-v1.0.0-macos-universal.dmg"
                   sparkle:version="1.0.0"
                   sparkle:shortVersionString="1.0.0"
                   length="12345678"
                   type="application/octet-stream"
                   sparkle:dsaSignature="..."/>
        <sparkle:releaseNotesLink>https://github.com/user/repo/releases/tag/v1.0.0</sparkle:releaseNotesLink>
      </item>
    </channel>
  </rss>
  ```
- **Required Fields**:
  - `sparkle:version`: Version number
  - `sparkle:shortVersionString`: Display version
  - `url`: Download URL
  - `length`: File size in bytes
  - `type`: MIME type
  - `sparkle:dsaSignature`: DSA signature (or ED25519)
- **Optional Fields**:
  - `sparkle:releaseNotesLink`: Link to release notes
  - `sparkle:minimumSystemVersion`: Minimum macOS version
  - `sparkle:criticalUpdate`: Mark critical updates

**2.6.3.2 Windows Update Feed Structure**
- **Format**: JSON (WinSparkle format)
- **Location**: `updates/windows/appcast.json`
- **File Name**: `appcast.json` (fixed name)
- **Structure**:
  ```json
  {
    "version": "1.0.0",
    "releaseNotes": "https://github.com/user/repo/releases/tag/v1.0.0",
    "pubDate": "2024-01-01T00:00:00Z",
    "downloads": [
      {
        "url": "https://github.com/user/repo/releases/download/v1.0.0/CuePoint-v1.0.0-windows-x64-setup.exe",
        "size": 12345678,
        "signature": "...",
        "type": "installer"
      }
    ]
  }
  ```
- **Required Fields**:
  - `version`: Version number
  - `downloads`: Array of download options
  - `url`: Download URL
  - `size`: File size
  - `signature`: File signature
- **Optional Fields**:
  - `releaseNotes`: Link to release notes
  - `pubDate`: Publication date
  - `type`: Download type (installer, portable)

**2.6.3.3 Feed File Location**
- **Hosting**: GitHub Pages (gh-pages branch)
- **Base URL**: `https://username.github.io/repo/updates/`
- **Directory Structure**:
  ```
  updates/
  ├── macos/
  │   └── appcast.xml
  └── windows/
      └── appcast.json
  ```
- **Accessibility**: Publicly accessible, no authentication

**2.6.3.4 Feed File Naming**
- **macOS**: `appcast.xml` (Sparkle standard)
- **Windows**: `appcast.json` (WinSparkle standard)
- **Consistency**: Fixed names, no versioning
- **Updates**: Files are updated in-place with new releases

**2.6.3.5 Feed File Content Management**
- **Append-Only**: New releases added, old ones kept
- **Version Ordering**: Latest version first
- **History**: Keep last 10-20 releases
- **Cleanup**: Archive old releases periodically

### Task 2.6.4: Define Release Notes Structure

**What to Build**
- Release notes format
- Release notes location
- Release notes content
- Release notes generation

**Implementation Details**

**2.6.4.1 Release Notes Format**
- **Format**: Markdown
- **Location**: `RELEASE_NOTES.md` (root) or `docs/releases/vX.Y.Z.md`
- **Structure**:
  ```markdown
  # CuePoint v1.0.0 Release Notes
  
  **Release Date**: January 1, 2024
  
  ## What's New
  - Feature 1
  - Feature 2
  
  ## Improvements
  - Improvement 1
  - Improvement 2
  
  ## Bug Fixes
  - Fix 1
  - Fix 2
  
  ## Installation
  Download and install from [GitHub Releases](https://github.com/user/repo/releases/tag/v1.0.0)
  
  ## System Requirements
  - macOS 10.15 or later
  - Windows 10 or later
  ```
- **Sections**:
  - Header with version and date
  - What's New (features)
  - Improvements (enhancements)
  - Bug Fixes (fixes)
  - Installation instructions
  - System requirements

**2.6.4.2 Release Notes Location**
- **Primary**: GitHub Release description
- **Secondary**: `RELEASE_NOTES.md` in repository
- **Archive**: `docs/releases/` directory
- **Accessibility**: Publicly readable

**2.6.4.3 Release Notes Content**
- **Version**: Clear version number
- **Date**: Release date
- **Changes**: Categorized changes
- **Installation**: Download and install instructions
- **Requirements**: System requirements
- **Breaking Changes**: Highlighted if any
- **Migration Guide**: If needed

**2.6.4.4 Release Notes Generation**
- **Manual**: Write release notes manually
- **Automated**: Generate from CHANGELOG.md
- **Template**: Use template for consistency
- **Validation**: Validate format before release

### Task 2.6.5: Define Checksum and Signature Files

**What to Build**
- Checksum file format
- Signature file format
- File location
- File generation

**Implementation Details**

**2.6.5.1 Checksum File Format**
- **Format**: Text file with checksums
- **Location**: `CuePoint-vX.Y.Z-checksums.txt` in release
- **Structure**:
  ```
  SHA256 (CuePoint-v1.0.0-macos-universal.dmg) = abc123...
  SHA256 (CuePoint-v1.0.0-windows-x64-setup.exe) = def456...
  MD5 (CuePoint-v1.0.0-macos-universal.dmg) = 789ghi...
  MD5 (CuePoint-v1.0.0-windows-x64-setup.exe) = jkl012...
  ```
- **Algorithms**: SHA256 (primary), MD5 (optional)
- **Format**: Standard checksum format (GNU coreutils style)

**2.6.5.2 Signature File Format**
- **Format**: Detached signatures (PGP/GPG)
- **Location**: `CuePoint-vX.Y.Z-signatures.asc` in release
- **Structure**:
  ```
  -----BEGIN PGP SIGNATURE-----
  ...
  -----END PGP SIGNATURE-----
  ```
- **Purpose**: Verify artifact integrity and authenticity
- **Optional**: Not required for v1.0, can add later

**2.6.5.3 Checksum Generation**
- **Tool**: `shasum` (macOS) or `sha256sum` (Linux)
- **Script**: `scripts/generate_checksums.py`
- **Implementation**:
  ```python
  import hashlib
  from pathlib import Path
  
  def generate_checksums(artifacts):
      """Generate checksums for artifacts"""
      checksums = []
      for artifact in artifacts:
          sha256 = hashlib.sha256()
          with open(artifact, 'rb') as f:
              sha256.update(f.read())
          checksums.append(f"SHA256 ({artifact.name}) = {sha256.hexdigest()}")
      return '\n'.join(checksums)
  ```

**2.6.5.4 Signature Generation**
- **Tool**: `gpg` (GNU Privacy Guard)
- **Script**: `scripts/generate_signatures.py`
- **Implementation**:
  ```bash
  gpg --detach-sign --armor --output signature.asc artifact.dmg
  ```
- **Key Management**: Use GPG key stored in secrets

### Task 2.6.6: Define Artifact Storage and Retention

**What to Build**
- Artifact storage location
- Artifact retention policy
- Artifact archival
- Artifact cleanup

**Implementation Details**

**2.6.6.1 Primary Storage**
- **Location**: GitHub Releases
- **Access**: Public (default) or private
- **Limits**: 2GB per file, 10GB per release
- **Retention**: Indefinite (unless deleted)

**2.6.6.2 Secondary Storage**
- **Location**: GitHub Actions artifacts
- **Access**: Build artifacts (temporary)
- **Retention**: 90 days (default)
- **Purpose**: Intermediate storage during build

**2.6.6.3 Retention Policy**
- **Releases**: Keep all releases indefinitely
- **Pre-releases**: Keep for 6 months, then archive
- **Drafts**: Keep for 1 month, then delete
- **Artifacts**: Keep for 90 days, then delete

**2.6.6.4 Archival Strategy**
- **Old Releases**: Move to archive repository
- **Archive Format**: Compressed archives
- **Archive Location**: Separate repository or external storage
- **Access**: Read-only, for historical reference

**2.6.6.5 Cleanup Process**
- **Automated**: Script to identify old artifacts
- **Manual**: Review and approve cleanup
- **Backup**: Backup before deletion
- **Documentation**: Document what was archived

## Implementation Checklist

### Naming Conventions
- [ ] Define naming convention standard
- [ ] Document naming rules
- [ ] Create naming validation script
- [ ] Test naming in builds

### Release Assets
- [ ] Define asset requirements
- [ ] Create asset validation script
- [ ] Test asset upload
- [ ] Verify asset accessibility

### Update Feeds
- [ ] Define appcast format (macOS)
- [ ] Define update feed format (Windows)
- [ ] Create feed generation scripts
- [ ] Test feed publishing
- [ ] Verify feed accessibility

### Release Notes
- [ ] Define release notes format
- [ ] Create release notes template
- [ ] Create release notes generation script
- [ ] Test release notes in releases

### Checksums and Signatures
- [ ] Create checksum generation script
- [ ] Create signature generation script (optional)
- [ ] Test checksum generation
- [ ] Verify checksum validation

### Storage and Retention
- [ ] Define retention policy
- [ ] Create archival script
- [ ] Create cleanup script
- [ ] Document storage strategy

## Files to Create/Modify

### New Files
1. `scripts/generate_checksums.py` - Checksum generation
2. `scripts/generate_signatures.py` - Signature generation (optional)
3. `scripts/validate_artifacts.py` - Artifact validation
4. `scripts/generate_appcast.py` - Appcast generation (macOS)
5. `scripts/generate_update_feed.py` - Update feed generation (Windows)
6. `scripts/generate_release_notes.py` - Release notes generation
7. `docs/templates/RELEASE_NOTES_TEMPLATE.md` - Release notes template
8. `updates/macos/appcast.xml` - macOS appcast (generated)
9. `updates/windows/appcast.json` - Windows update feed (generated)

### Files to Modify
1. `.github/workflows/release.yml` - Add artifact organization
2. `scripts/create_dmg.sh` - Use naming convention
3. `scripts/installer.nsi` - Use naming convention

## Implementation Dependencies

### Prerequisites
- Step 2.1: Goals and Principles (defines requirements)
- Step 2.2: Tooling Choices (uses build tools)
- Step 2.4: Version Management (uses version)
- Step 2.5: CI Structure (uses workflows)

### Enables
- Step 5: Auto-Update System (uses update feeds)
- Step 3: macOS Packaging (uses artifact structure)
- Step 4: Windows Packaging (uses artifact structure)

## Success Criteria

### Naming
- ✅ All artifacts follow naming convention
- ✅ Names are consistent across releases
- ✅ Names are descriptive and clear

### Release Assets
- ✅ All required assets present
- ✅ Assets are accessible
- ✅ Assets are properly signed
- ✅ Assets metadata correct

### Update Feeds
- ✅ Appcast generated correctly
- ✅ Update feed generated correctly
- ✅ Feeds are accessible
- ✅ Feeds are valid format

### Release Notes
- ✅ Release notes generated
- ✅ Release notes are clear
- ✅ Release notes include all changes
- ✅ Release notes are accessible

### Checksums
- ✅ Checksums generated
- ✅ Checksums are valid
- ✅ Checksums are accessible
- ✅ Checksums can be verified

## Next Implementation Steps

After completing Step 2.6:
1. **Step 2.7**: Secrets and Certificates (uses artifact structure)
2. **Step 2.8**: Release Gating (validates artifacts)
3. **Step 5**: Auto-Update System (uses update feeds)

## Detailed Implementation Guidance

### Naming Convention Implementation

#### Script for Name Generation
```python
# scripts/generate_artifact_name.py
from pathlib import Path
import sys
sys.path.insert(0, str(Path('SRC').resolve()))
from cuepoint.version import __version__

def generate_artifact_name(platform, architecture, file_type, installer_type=None):
    """Generate artifact name following convention"""
    product = "CuePoint"
    version = __version__.replace('v', '')  # Remove 'v' prefix if present
    
    if platform == 'macos':
        ext = '.dmg'
    elif platform == 'windows':
        if installer_type == 'setup':
            ext = '-setup.exe'
        elif installer_type == 'portable':
            ext = '-portable.zip'
        else:
            ext = '.exe'
    else:
        raise ValueError(f"Unknown platform: {platform}")
    
    name = f"{product}-v{version}-{platform}-{architecture}{ext}"
    return name
```

#### Validation Script
```python
# scripts/validate_artifact_names.py
import re
from pathlib import Path

def validate_artifact_name(name):
    """Validate artifact name matches convention"""
    pattern = r'^CuePoint-v\d+\.\d+\.\d+-(macos|windows)-(universal|arm64|x64|x86)(-setup|-portable)?\.(dmg|exe|zip|msi)$'
    return bool(re.match(pattern, name))
```

### Appcast Generation Details

#### Appcast Generation Script
```python
# scripts/generate_appcast.py
import xml.etree.ElementTree as ET
from pathlib import Path
import sys
from datetime import datetime

sys.path.insert(0, str(Path('SRC').resolve()))
from cuepoint.version import __version__

def generate_appcast(dmg_path, release_notes_url, download_url):
    """Generate Sparkle appcast XML"""
    root = ET.Element('rss', version='2.0')
    root.set('xmlns:sparkle', 'http://www.andymatuschak.org/xml-namespaces/sparkle')
    
    channel = ET.SubElement(root, 'channel')
    ET.SubElement(channel, 'title').text = 'CuePoint Updates'
    ET.SubElement(channel, 'link').text = 'https://github.com/user/repo'
    ET.SubElement(channel, 'description').text = 'Latest CuePoint releases'
    
    item = ET.SubElement(channel, 'item')
    ET.SubElement(item, 'title').text = f'Version {__version__}'
    ET.SubElement(item, 'pubDate').text = datetime.now().strftime('%a, %d %b %Y %H:%M:%S +0000')
    
    # Sparkle version info
    version_elem = ET.SubElement(item, 'sparkle:version')
    version_elem.text = __version__
    
    short_version = ET.SubElement(item, 'sparkle:shortVersionString')
    short_version.text = __version__
    
    # Enclosure
    dmg_size = Path(dmg_path).stat().st_size
    enclosure = ET.SubElement(item, 'enclosure')
    enclosure.set('url', download_url)
    enclosure.set('sparkle:version', __version__)
    enclosure.set('sparkle:shortVersionString', __version__)
    enclosure.set('length', str(dmg_size))
    enclosure.set('type', 'application/octet-stream')
    # Add signature if available
    # enclosure.set('sparkle:dsaSignature', signature)
    
    # Release notes
    if release_notes_url:
        notes_link = ET.SubElement(item, 'sparkle:releaseNotesLink')
        notes_link.text = release_notes_url
    
    return ET.tostring(root, encoding='utf-8', xml_declaration=True).decode('utf-8')
```

### Update Feed Generation Details

#### Windows Update Feed Script
```python
# scripts/generate_update_feed.py
import json
from pathlib import Path
import sys
from datetime import datetime

sys.path.insert(0, str(Path('SRC').resolve()))
from cuepoint.version import __version__

def generate_update_feed(exe_path, release_notes_url, download_url):
    """Generate WinSparkle update feed JSON"""
    exe_size = Path(exe_path).stat().st_size
    
    feed = {
        "version": __version__,
        "releaseNotes": release_notes_url,
        "pubDate": datetime.now().isoformat() + "Z",
        "downloads": [
            {
                "url": download_url,
                "size": exe_size,
                "signature": "",  # Add signature if available
                "type": "installer"
            }
        ]
    }
    
    return json.dumps(feed, indent=2)
```

### Release Notes Generation

#### Release Notes Template
```markdown
# CuePoint v{{VERSION}} Release Notes

**Release Date**: {{DATE}}

## What's New
{{NEW_FEATURES}}

## Improvements
{{IMPROVEMENTS}}

## Bug Fixes
{{BUG_FIXES}}

## Installation
Download and install from [GitHub Releases](https://github.com/user/repo/releases/tag/v{{VERSION}})

## System Requirements
- macOS 10.15 or later
- Windows 10 or later
```

#### Release Notes Generation Script
```python
# scripts/generate_release_notes.py
from pathlib import Path
from datetime import datetime
import sys

sys.path.insert(0, str(Path('SRC').resolve()))
from cuepoint.version import __version__

def generate_release_notes(template_path, changelog_path=None):
    """Generate release notes from template and CHANGELOG"""
    template = Path(template_path).read_text()
    
    # Replace placeholders
    notes = template.replace('{{VERSION}}', __version__)
    notes = notes.replace('{{DATE}}', datetime.now().strftime('%B %d, %Y'))
    
    # If CHANGELOG exists, extract relevant section
    if changelog_path and Path(changelog_path).exists():
        changelog = Path(changelog_path).read_text()
        # Extract version section from CHANGELOG
        # ... parsing logic ...
    
    return notes
```

### Checksum Generation Details

#### Checksum Generation Script
```python
# scripts/generate_checksums.py
import hashlib
from pathlib import Path

def generate_checksums(artifacts, algorithms=['sha256', 'md5']):
    """Generate checksums for artifacts"""
    checksums = []
    
    for artifact_path in artifacts:
        artifact = Path(artifact_path)
        if not artifact.exists():
            continue
        
        for algorithm in algorithms:
            hash_obj = hashlib.new(algorithm)
            with open(artifact, 'rb') as f:
                for chunk in iter(lambda: f.read(4096), b''):
                    hash_obj.update(chunk)
            
            checksum = hash_obj.hexdigest()
            checksums.append(f"{algorithm.upper()} ({artifact.name}) = {checksum}")
    
    return '\n'.join(checksums)
```

## References

- Main document: `../02_Build_System_and_Release_Pipeline.md`
- Related: Step 2.5 (CI Structure), Step 5 (Auto-Update)
- Sparkle Documentation: https://sparkle-project.org/documentation/
- WinSparkle Documentation: https://github.com/vslavik/winsparkle
