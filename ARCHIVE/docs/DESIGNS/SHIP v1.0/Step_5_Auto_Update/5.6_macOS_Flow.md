# Implementation Step 5.6: macOS Update Flow (Sparkle Integration)

## Implementation Overview
**What We're Building**: A comprehensive macOS update flow implementation using the Sparkle framework that enables seamless, secure, and user-friendly automatic updates for CuePoint on macOS. This document defines the complete Sparkle integration, configuration, signature management, update process flow, and all aspects of delivering professional auto-updates on macOS that work seamlessly with signed and notarized app bundles.

## Implementation Tasks

### Task 5.6.1: Define Sparkle Framework Integration

**What to Build**
- Sparkle framework integration architecture
- Framework embedding and bundling
- Framework initialization and configuration
- Framework API usage
- Framework lifecycle management

**Implementation Details**

**5.6.1.1 Sparkle Framework Overview**
- **Framework**: Sparkle.framework (Cocoa/Objective-C framework)
- **Purpose**: Industry-standard macOS auto-update framework
- **License**: MIT License (permissive, commercial-friendly)
- **Maintenance**: Actively maintained, widely used
- **Features**:
  - Automatic update checking
  - Update download management
  - EdDSA signature verification
  - Appcast parsing
  - Native macOS UI
  - Seamless installation
  - Automatic app relaunch
- **Version**: Latest stable version (2.x recommended)
- **Source**: https://github.com/sparkle-project/Sparkle
- **Documentation**: https://sparkle-project.org/documentation/

**5.6.1.2 Sparkle Framework Embedding**
- **Embedding Method**: Embed Sparkle.framework in app bundle
- **Location**: `CuePoint.app/Contents/Frameworks/Sparkle.framework`
- **Framework Structure**:
  ```
  Sparkle.framework/
  ├── Sparkle (binary)
  ├── Headers/
  │   └── Sparkle.h
  ├── Resources/
  │   └── (localization, etc.)
  └── Versions/
      └── Current/
          └── (framework contents)
  ```
- **Embedding Process**:
  1. Download Sparkle.framework (or build from source)
  2. Copy to app bundle during build
  3. Sign framework with app signing identity
  4. Verify framework is properly embedded
- **Build Integration**:
  - **PyInstaller**: Add framework to `datas` in spec file
  - **Manual**: Copy framework to app bundle after PyInstaller build
  - **Script**: Automated script to embed framework
- **Code Signing**:
  - **Requirement**: Framework must be signed with same identity as app
  - **Signing**: Sign framework during app signing process
  - **Verification**: Verify framework signature matches app signature
  - **Notarization**: Framework included in notarization submission

**5.6.1.3 Sparkle Framework Initialization**
- **Initialization Location**: Application startup code
- **Initialization Method**: Objective-C or Swift (via Python bindings or native integration)
- **Initialization Code** (Objective-C):
  ```objc
  #import <Sparkle/Sparkle.h>
  
  - (void)applicationDidFinishLaunching:(NSNotification *)notification {
      // Initialize Sparkle updater
      SUUpdater *updater = [SUUpdater sharedUpdater];
      
      // Configure feed URL (can be set in Info.plist or here)
      [updater setFeedURL:[NSURL URLWithString:@"https://stuchain.github.io/CuePoint/updates/macos/stable/appcast.xml"]];
      
      // Configure update check behavior
      [updater setAutomaticallyChecksForUpdates:YES];
      [updater setUpdateCheckInterval:86400]; // Check daily
      
      // Check for updates on startup (optional)
      [updater checkForUpdatesInBackground];
  }
  ```
- **Python Integration Options**:
  - **Option 1**: Python bindings (PyObjC)
    - Use PyObjC to call Sparkle APIs from Python
    - Requires PyObjC installed
    - Native integration
  - **Option 2**: Native bridge
    - Create Objective-C bridge code
    - Expose Sparkle APIs to Python
    - More control, more work
  - **Option 3**: Subprocess calls
    - Call Sparkle command-line tools (if available)
    - Simpler but less integrated
  - **Design Decision**: Use PyObjC for Python integration (Option 1)
- **Configuration Methods**:
  - **Info.plist**: Set `SUFeedURL` in Info.plist (static)
  - **Runtime**: Set feed URL at runtime (dynamic, for channels)
  - **Preferences**: User preferences override defaults

**5.6.1.4 Sparkle API Usage**
- **Main Class**: `SUUpdater` (singleton)
- **Key Methods**:
  - `+[SUUpdater sharedUpdater]`: Get shared updater instance
  - `-[SUUpdater setFeedURL:]`: Set appcast feed URL
  - `-[SUUpdater checkForUpdates:]`: Manual update check (with UI)
  - `-[SUUpdater checkForUpdatesInBackground]`: Background update check (no UI)
  - `-[SUUpdater setAutomaticallyChecksForUpdates:]`: Enable/disable automatic checks
  - `-[SUUpdater setUpdateCheckInterval:]`: Set check interval (seconds)
  - `-[SUUpdater setDelegate:]`: Set delegate for customization
- **Delegate Methods** (SUUpdaterDelegate):
  - `-updater:didFindValidUpdate:`: Called when update found
  - `-updaterDidNotFindUpdate:`: Called when no update
  - `-updater:didFailToCheckForUpdateWithError:`: Called on error
  - `-updater:willInstallUpdate:`: Called before installation
  - `-updater:shouldPostponeRelaunchForUpdate:untilInvoking:`: Customize relaunch
- **Update Check Methods**:
  - **With UI**: `checkForUpdates:` - Shows UI during check
  - **Background**: `checkForUpdatesInBackground` - Silent check, shows UI only if update found
  - **Manual**: User-initiated check via menu

### Task 5.6.2: Define Sparkle Configuration

**What to Build**
- Info.plist configuration
- Runtime configuration
- Feed URL configuration
- Update check behavior configuration
- User preference integration

**Implementation Details**

**5.6.2.1 Info.plist Configuration**
- **Configuration Keys**:
  - **`SUFeedURL`**: Appcast feed URL (string)
    - **Format**: Full HTTPS URL to appcast XML
    - **Example**: `https://stuchain.github.io/CuePoint/updates/macos/stable/appcast.xml`
    - **Required**: Yes (or set at runtime)
    - **Location**: `CuePoint.app/Contents/Info.plist`
  - **`SUEnableAutomaticChecks`**: Enable automatic update checks (boolean)
    - **Default**: `true`
    - **Purpose**: Enable/disable automatic background checks
  - **`SUUpdateCheckInterval`**: Update check interval in seconds (number)
    - **Default**: 86400 (24 hours)
    - **Purpose**: How often to check for updates
  - **`SUAllowsAutomaticUpdates`**: Allow automatic updates without user prompt (boolean)
    - **Default**: `false` (recommended for v1.0)
    - **Purpose**: Enable silent automatic updates (not recommended)
  - **`SUEnableSystemProfiling`**: Enable system profiling (boolean)
    - **Default**: `false`
    - **Purpose**: Send system info to update server (privacy consideration)
  - **`SUPublicEDKey`**: Public EdDSA key for signature verification (string)
    - **Format**: Base64-encoded public key
    - **Required**: Yes (for EdDSA signature verification)
    - **Purpose**: Verify update package signatures
- **Info.plist Location**: `build/Info.plist.template` → processed → `CuePoint.app/Contents/Info.plist`
- **Configuration Processing**: Inject values during build process
- **Template Example**:
  ```xml
  <key>SUFeedURL</key>
  <string>https://stuchain.github.io/CuePoint/updates/macos/stable/appcast.xml</string>
  <key>SUPublicEDKey</key>
  <string>BASE64_ENCODED_PUBLIC_KEY</string>
  <key>SUEnableAutomaticChecks</key>
  <true/>
  <key>SUUpdateCheckInterval</key>
  <integer>86400</integer>
  <key>SUAllowsAutomaticUpdates</key>
  <false/>
  ```

**5.6.2.2 Runtime Configuration**
- **Feed URL Configuration**:
  - **Static**: Set in Info.plist (for stable channel)
  - **Dynamic**: Set at runtime (for channel switching)
  - **Channel Switching**: Change feed URL when user switches channels
  - **Implementation**: Use `-[SUUpdater setFeedURL:]` at runtime
- **Update Check Behavior**:
  - **Automatic Checks**: Enable/disable via `setAutomaticallyChecksForUpdates:`
  - **Check Interval**: Set via `setUpdateCheckInterval:`
  - **User Preferences**: Respect user's check frequency preference
- **Configuration Updates**:
  - **Channel Change**: Update feed URL when channel changes
  - **Preference Change**: Update check behavior when preferences change
  - **Immediate Effect**: Changes take effect immediately

**5.6.2.3 EdDSA Key Management**
- **Key Pair Generation**:
  - **Algorithm**: Ed25519 (EdDSA over Curve25519)
  - **Tool**: `generate_keys` utility (part of Sparkle) or OpenSSL
  - **Command**: `./bin/generate_keys` (from Sparkle distribution)
  - **Output**: 
    - Private key: `dsa_priv.pem` (keep secret, store in GitHub Secrets)
    - Public key: `dsa_pub.pem` (embed in app)
- **Public Key Embedding**:
  - **Location**: `SUPublicEDKey` in Info.plist
  - **Format**: Base64-encoded public key
  - **Processing**: Inject during build process
  - **Verification**: Verify key is present and correct
- **Private Key Storage**:
  - **Location**: GitHub Secrets (never in repository)
  - **Format**: PEM format or Base64-encoded
  - **Usage**: Sign update packages during release
  - **Security**: Never commit, rotate periodically
- **Key Rotation**:
  - **Frequency**: Rotate keys periodically (e.g., annually)
  - **Process**: Generate new keys, update app and feed
  - **Compatibility**: Support both old and new keys during transition

### Task 5.6.3: Define Update Process Flow

**What to Build**
- Complete update process flow
- Update detection flow
- Download and verification flow
- Installation flow
- App relaunch flow
- Error handling flow

**Implementation Details**

**5.6.3.1 Update Detection Flow**
- **Trigger**: App startup, scheduled check, or manual check
- **Process**:
  1. **Check Initiation**:
     - Sparkle checks if check is needed (not too recent)
     - Constructs feed URL (from Info.plist or runtime)
     - Initiates background check
  2. **Feed Fetching**:
     - Fetches appcast XML from feed URL
     - Handles network errors, timeouts
     - Validates HTTPS connection
  3. **Feed Parsing**:
     - Parses RSS 2.0 + Sparkle namespace XML
     - Extracts update items
     - Validates feed structure
  4. **Version Comparison**:
     - Gets current app version from Info.plist
     - Gets latest version from feed
     - Compares versions using semantic versioning
     - Filters pre-release versions (if not on beta channel)
  5. **Update Detection**:
     - If newer version found:
       - Stores update information
       - Shows update dialog (if `checkForUpdates:` used)
       - Or triggers delegate method (if background check)
     - If no update:
       - Updates last check timestamp
       - Silently completes (if background check)
- **User Notification**:
  - **Background Check**: Shows dialog only if update found
  - **Manual Check**: Shows dialog with result (update or "up to date")
  - **Non-Blocking**: Dialog is modal but doesn't block app

**5.6.3.2 Download and Verification Flow**
- **User Action**: User clicks "Install Update" in dialog
- **Download Process**:
  1. **Download Initiation**:
     - Sparkle extracts download URL from appcast
     - Starts download of DMG file
     - Shows download progress
  2. **Download Progress**:
     - Shows progress bar
     - Shows download speed
     - Shows time remaining
     - Can be cancelled by user
  3. **Download Completion**:
     - Download completes
     - Verifies file size matches appcast
     - Proceeds to verification
- **Signature Verification**:
  1. **EdDSA Verification**:
     - Extracts EdDSA signature from appcast
     - Reads public key from Info.plist
     - Verifies signature against downloaded DMG
     - Fails if signature invalid
  2. **Notarization Check** (if applicable):
     - Checks DMG notarization status
     - Verifies notarization ticket
     - Fails if not notarized (if required)
  3. **Verification Success**:
     - Proceeds to installation
  4. **Verification Failure**:
     - Shows error dialog
     - Allows retry or cancellation
     - Deletes downloaded file

**5.6.3.3 Installation Flow**
- **Pre-Installation**:
  1. **App Quit**:
     - Sparkle requests app to quit
     - App saves state (if needed)
     - App quits gracefully
  2. **DMG Mounting**:
     - Sparkle mounts downloaded DMG
     - Verifies DMG contents
     - Locates app bundle in DMG
  3. **Backup** (optional):
     - Backs up current app bundle (optional)
     - Stores backup location
- **Installation Process**:
  1. **App Replacement**:
     - Removes old app bundle from Applications
     - Copies new app bundle from DMG to Applications
     - Sets proper permissions
  2. **Verification**:
     - Verifies new app bundle is valid
     - Verifies new app bundle is signed
     - Verifies new app bundle is notarized (if applicable)
  3. **Cleanup**:
     - Unmounts DMG
     - Deletes downloaded DMG
     - Cleans up temporary files
- **Post-Installation**:
  1. **App Relaunch**:
     - Sparkle launches new app bundle
     - App starts with new version
  2. **State Restoration**:
     - App restores previous state (if saved)
     - App shows "Update successful" message (optional)
  3. **Verification**:
     - App verifies it's running new version
     - App verifies functionality works

**5.6.3.4 Error Handling Flow**
- **Network Errors**:
  - **Detection**: Network timeout, DNS failure, connection refused
  - **Handling**: Show error dialog, allow retry
  - **Recovery**: Retry with exponential backoff
- **Feed Errors**:
  - **Detection**: Invalid XML, missing fields, parsing errors
  - **Handling**: Show error dialog, log error
  - **Recovery**: Retry feed fetch
- **Download Errors**:
  - **Detection**: Download failure, partial download, checksum mismatch
  - **Handling**: Show error dialog, allow retry
  - **Recovery**: Retry download, resume if supported
- **Verification Errors**:
  - **Detection**: Invalid signature, expired certificate, notarization failure
  - **Handling**: Show security error, prevent installation
  - **Recovery**: Cannot recover (security issue), user must download manually
- **Installation Errors**:
  - **Detection**: Installation failure, permission errors, disk space errors
  - **Handling**: Show error dialog, allow retry
  - **Recovery**: Retry installation, restore backup if available

### Task 5.6.4: Define Signature and Security

**What to Build**
- EdDSA signature generation
- Signature verification process
- Appcast signing (optional)
- Security best practices
- Certificate management

**Implementation Details**

**5.6.4.1 EdDSA Signature Generation**
- **Algorithm**: Ed25519 (EdDSA over Curve25519)
- **Purpose**: Cryptographically verify update package authenticity
- **Generation Process**:
  1. **Key Generation** (one-time):
     - Use Sparkle's `generate_keys` utility
     - Generates Ed25519 key pair
     - Saves private key securely
     - Embeds public key in app
  2. **Package Signing** (per release):
     - Read DMG file
     - Calculate SHA-256 hash of DMG
     - Sign hash with EdDSA private key
     - Encode signature as Base64
     - Add to appcast as `sparkle:edSignature`
- **Signing Tool**: `sign_update` utility (part of Sparkle)
  - **Command**: `./bin/sign_update dmg_path private_key_path`
  - **Output**: Base64-encoded signature
  - **Integration**: Call from CI/CD during release
- **Signature Format**: Base64-encoded EdDSA signature
- **Signature Location**: `sparkle:edSignature` attribute in appcast `<enclosure>` element

**5.6.4.2 Signature Verification**
- **Verification Process** (automatic by Sparkle):
  1. **Signature Extraction**:
     - Extract `sparkle:edSignature` from appcast
     - Decode Base64 signature
  2. **Public Key Retrieval**:
     - Read `SUPublicEDKey` from Info.plist
     - Decode Base64 public key
  3. **Package Verification**:
     - Calculate SHA-256 hash of downloaded DMG
     - Verify signature against hash using public key
     - Fail if signature invalid
  4. **Verification Success**:
     - Proceed to installation
  5. **Verification Failure**:
     - Show security error
     - Prevent installation
     - Delete downloaded file
- **Security Guarantees**:
  - **Authenticity**: Update is from legitimate source
  - **Integrity**: Update package not tampered with
  - **Non-Repudiation**: Cannot deny update source

**5.6.4.3 Appcast Signing** (Optional, Recommended)
- **Purpose**: Additional security layer for feed integrity
- **Method**: Sign entire appcast XML with EdDSA
- **Process**:
  1. Generate appcast XML
  2. Sign XML with EdDSA private key
  3. Add signature to appcast (as attribute or separate file)
  4. Sparkle verifies appcast signature before parsing
- **Benefits**:
  - Prevents feed tampering
  - Ensures feed authenticity
  - Additional security layer
- **Implementation**: Optional for v1.0, recommended for production

### Task 5.6.5: Define Update UI Customization

**What to Build**
- Update dialog customization
- Delegate methods for UI customization
- Progress display customization
- Error message customization
- Branding integration

**Implementation Details**

**5.6.5.1 Update Dialog Customization**
- **Default UI**: Sparkle provides native macOS update dialog
- **Customization Options**:
  - **Delegate Methods**: Customize behavior via SUUpdaterDelegate
  - **UI Override**: Override default UI (advanced, not recommended)
  - **Branding**: App icon, colors, styling (limited)
- **Default Dialog Content**:
  - App icon
  - "Update Available" title
  - Version information (current → new)
  - Release notes (from appcast)
  - "Install Update" button
  - "Remind me later" button
  - "Skip this version" button
- **Customization via Delegate**:
  - `-updater:didFindValidUpdate:`: Customize update found behavior
  - `-updater:willInstallUpdate:`: Customize installation behavior
  - `-updater:shouldPostponeRelaunchForUpdate:untilInvoking:`: Customize relaunch timing

**5.6.5.2 Progress Display**
- **Download Progress**: Sparkle shows native macOS progress dialog
- **Progress Information**:
  - Progress bar
  - Download speed
  - Time remaining
  - File size
- **Customization**: Limited customization (native macOS appearance)
- **User Control**: Can cancel download

### Task 5.6.6: Define Integration with App Bundle

**What to Build**
- App bundle integration requirements
- Bundle ID consistency
- Signing identity consistency
- Notarization compatibility
- User data preservation

**Implementation Details**

**5.6.6.1 Bundle ID Consistency**
- **Requirement**: Bundle ID must never change
- **Bundle ID**: `com.stuchain.cuepoint`
- **Consistency**: Must be identical across all versions
- **Validation**: Automated validation in CI
- **Impact**: Changing bundle ID breaks updates, creates new app identity

**5.6.6.2 Signing Identity Consistency**
- **Requirement**: Signing identity must be consistent
- **Identity**: `Developer ID Application: StuChain (TEAM_ID)`
- **Consistency**: Must be identical across all versions
- **Validation**: Automated validation in CI
- **Impact**: Inconsistent identity breaks update trust, causes security warnings

**5.6.6.3 Notarization Compatibility**
- **Requirement**: App must be notarized for Gatekeeper compatibility
- **Notarization**: Required for distribution outside App Store
- **Update Compatibility**: Updates work with notarized apps
- **DMG Notarization**: Update DMG must also be notarized
- **Verification**: Sparkle verifies notarization (if applicable)

**5.6.6.4 User Data Preservation**
- **Data Locations** (preserved during updates):
  - **Application Support**: `~/Library/Application Support/CuePoint/`
  - **Preferences**: `~/Library/Preferences/com.stuchain.cuepoint.plist`
  - **Caches**: `~/Library/Caches/com.stuchain.cuepoint/`
  - **Documents**: `~/Documents/CuePoint/` (user exports)
- **Preservation Strategy**:
  - App bundle is replaced, but user data directories are separate
  - User data is never touched during update
  - App reads from same data locations after update
- **Data Migration** (if needed):
  - Detect old data format
  - Migrate to new format on first launch after update
  - Backup old data before migration

### Task 5.6.7: Define Sparkle Integration Testing

**What to Build**
- Sparkle integration testing procedures
- Update flow testing
- Signature verification testing
- Error scenario testing
- Compatibility testing

**Implementation Details**

**5.6.7.1 Integration Testing**
- **Test Scenarios**:
  - Update check with update available
  - Update check with no update
  - Update download and installation
  - Signature verification
  - Error handling
- **Test Environment**:
  - macOS test VMs
  - Various macOS versions
  - Different network conditions
- **Test Validation**:
  - Update succeeds
  - Data preserved
  - App launches
  - Functionality works

**5.6.7.2 Signature Testing**
- **Test Scenarios**:
  - Valid signature verification
  - Invalid signature rejection
  - Expired certificate handling
  - Key mismatch handling
- **Test Methods**:
  - Test with valid signatures
  - Test with invalid signatures
  - Test with expired certificates
  - Test with wrong keys

### Task 5.6.8: Define Sparkle Troubleshooting

**What to Build**
- Common issues and solutions
- Troubleshooting procedures
- Diagnostic tools
- Support procedures
- Documentation

**Implementation Details**

**5.6.8.1 Common Issues**
- **Issue**: Update check fails
  - **Causes**: Network error, feed inaccessible, parsing error
  - **Solutions**: Check network, verify feed URL, check feed format
- **Issue**: Signature verification fails
  - **Causes**: Invalid signature, expired certificate, key mismatch
  - **Solutions**: Regenerate signature, renew certificate, verify keys
- **Issue**: Update installation fails
  - **Causes**: Permission error, disk space, locked files
  - **Solutions**: Check permissions, free disk space, close locked files

**5.6.8.2 Diagnostic Tools**
- **Sparkle Logs**: Check Sparkle logs for errors
  - **Location**: `~/Library/Logs/SparkleUpdateLog.log` or Console.app
  - **Content**: Update check results, errors, warnings
  - **Access**: Via Console.app or log file access
- **System Logs**: Check system logs for issues
  - **Location**: Console.app, system.log
  - **Content**: System events, application events
  - **Filtering**: Filter by application name, process ID
- **Feed Validation**: Validate feed structure and content
  - **Tool**: `scripts/validate_feeds.py`
  - **Checks**: XML structure, required fields, URLs, signatures
  - **Output**: Validation report with errors and warnings
- **Signature Verification**: Verify signatures manually
  - **Tool**: Sparkle's `sign_update` utility or OpenSSL
  - **Command**: `./bin/sign_update --verify dmg_path public_key`
  - **Output**: Signature verification result
  - **Purpose**: Troubleshoot signature issues

**5.6.8.3 Support Procedures**
- **Issue Triage**:
  - **Categorize**: Network, feed, download, installation, signature
  - **Prioritize**: Critical, high, medium, low
  - **Assign**: Assign to appropriate team member
- **Resolution Steps**:
  1. **Reproduce**: Reproduce issue in test environment
  2. **Diagnose**: Use diagnostic tools to identify root cause
  3. **Fix**: Implement fix or workaround
  4. **Test**: Test fix thoroughly
  5. **Deploy**: Deploy fix to users
- **Documentation**: Document common issues and solutions

### Task 5.6.9: Define Sparkle Advanced Configuration

**What to Build**
- Advanced Sparkle configuration options
- Custom delegate implementation
- UI customization options
- Performance tuning
- Advanced features

**Implementation Details**

**5.6.9.1 Advanced Configuration Options**
- **Update Check Interval**: Fine-tune check frequency
- **Automatic Updates**: Configure automatic update behavior (v1.1+)
- **System Profiling**: Enable/disable system profiling
- **Delta Updates**: Configure delta update support (future)
- **Custom UI**: Customize update UI via delegate

**5.6.9.2 Delegate Implementation**
- **Purpose**: Customize Sparkle behavior
- **Key Methods**:
  - `updater:didFindValidUpdate:`: Customize update found behavior
  - `updater:willInstallUpdate:`: Customize installation behavior
  - `updater:shouldPostponeRelaunchForUpdate:untilInvoking:`: Customize relaunch
- **Use Cases**:
  - Custom update UI
  - Custom installation flow
  - Custom relaunch timing
  - Custom error handling
- **Implementation**: Implement SUUpdaterDelegate protocol

**5.6.9.3 Performance Tuning**
- **Update Check Optimization**: Minimize check frequency, cache results
- **Download Optimization**: Use efficient download mechanisms
- **Installation Optimization**: Optimize installation process
- **Resource Usage**: Minimize memory and CPU usage

### Task 5.6.10: Define Sparkle Integration Code Examples

**What to Build**
- Complete integration code examples
- Python integration examples
- Objective-C bridge examples
- Configuration examples
- Error handling examples

**Implementation Details**

**5.6.10.1 Python Integration via PyObjC**
```python
#!/usr/bin/env python3
"""Sparkle integration via PyObjC"""

from AppKit import NSObject
from Foundation import NSURL
import objc

# Import Sparkle
try:
    from Sparkle import SUUpdater, SUUpdaterDelegate
except ImportError:
    print("Warning: Sparkle framework not available")
    SUUpdater = None

class SparkleUpdaterDelegate(NSObject):
    """Sparkle updater delegate"""
    
    def updater_didFindValidUpdate_(self, updater, item):
        """Called when update found"""
        print(f"Update found: {item.versionString()}")
    
    def updaterDidNotFindUpdate_(self, updater):
        """Called when no update"""
        print("No update available")
    
    def updater_didFailToCheckForUpdateWithError_(self, updater, error):
        """Called on error"""
        print(f"Update check error: {error}")

def initialize_sparkle(feed_url=None):
    """Initialize Sparkle"""
    if not SUUpdater:
        return None
    
    updater = SUUpdater.sharedUpdater()
    
    # Set feed URL
    if feed_url:
        updater.setFeedURL_(NSURL.URLWithString_(feed_url))
    
    # Set delegate
    delegate = SparkleUpdaterDelegate.alloc().init()
    updater.setDelegate_(delegate)
    
    # Configure
    updater.setAutomaticallyChecksForUpdates_(True)
    updater.setUpdateCheckInterval_(86400)  # Daily
    
    return updater

def check_for_updates(updater, show_ui=True):
    """Check for updates"""
    if not updater:
        return False
    
    if show_ui:
        updater.checkForUpdates_(None)
    else:
        updater.checkForUpdatesInBackground()
    
    return True
```

## Implementation Summary

### Sparkle Integration
- ✅ Framework embedding and bundling
- ✅ Framework initialization and configuration
- ✅ API usage and delegate methods
- ✅ Lifecycle management
- ✅ Python integration approach

### Configuration
- ✅ Info.plist configuration
- ✅ Runtime configuration
- ✅ Feed URL management
- ✅ EdDSA key management
- ✅ Channel switching

### Update Process
- ✅ Update detection flow
- ✅ Download and verification flow
- ✅ Installation flow
- ✅ Error handling flow
- ✅ App relaunch flow

### Security
- ✅ EdDSA signature generation
- ✅ Signature verification
- ✅ Appcast signing (optional)
- ✅ Security best practices
- ✅ Certificate management

### Integration
- ✅ App bundle integration
- ✅ Bundle ID consistency
- ✅ Signing identity consistency
- ✅ Notarization compatibility
- ✅ User data preservation

### Testing and Troubleshooting
- ✅ Integration testing procedures
- ✅ Signature testing
- ✅ Common issues documentation
- ✅ Diagnostic tools
- ✅ Support procedures

## Files to Create/Modify

### New Files
1. `SRC/cuepoint/update/sparkle_integration.py` - Sparkle integration wrapper
2. `scripts/embed_sparkle.py` - Script to embed Sparkle framework
3. `scripts/generate_eddsa_keys.py` - EdDSA key generation script
4. `scripts/sign_update_macos.py` - Update package signing script
5. `scripts/test_sparkle_integration.py` - Sparkle integration testing

### Files to Modify
1. `build/Info.plist.template` - Add Sparkle configuration keys
2. `build/pyinstaller.spec` - Add Sparkle framework to datas
3. Application initialization - Initialize Sparkle
4. `DOCS/TROUBLESHOOTING/Sparkle_Issues.md` - Troubleshooting documentation

## Implementation Dependencies

### Prerequisites
- Step 2: Build System (provides versioning)
- Step 3: macOS Packaging (provides signed app bundle)
- Step 5.4: Update Metadata (provides appcast structure)

### Framework Dependencies
- Sparkle.framework (latest stable)
- PyObjC (for Python integration)
- Network access
- HTTPS support

## Next Implementation Steps

After completing Step 5.6:
1. **Step 5.7**: Windows Flow (implements WinSparkle integration)
2. **Step 5.8**: Security Model (implements security requirements)
3. **Step 5.9**: Release Pipeline (implements CI/CD integration)

## References

- Main document: `../05_Auto_Update_System.md`
- Sparkle Documentation: https://sparkle-project.org/documentation/
- Sparkle GitHub: https://github.com/sparkle-project/Sparkle
- EdDSA Signatures: https://sparkle-project.org/documentation/signing-updates/
- PyObjC: https://pyobjc.readthedocs.io/
