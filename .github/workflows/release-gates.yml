name: Release Gates

on:
  push:
    branches: [main, v1]
  pull_request:
    branches: [main, v1]
  workflow_dispatch:

jobs:
  test-gates:
    name: Test Gates
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run unit tests
        run: |
          pytest SRC/tests/unit/ -v --cov=SRC/cuepoint --cov-report=xml
        continue-on-error: false
      
      - name: Run integration tests
        run: |
          pytest SRC/tests/integration/ -v
        continue-on-error: false
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          minimum_coverage: 80
      
      - name: Check test coverage
        run: |
          coverage report --fail-under=80
        continue-on-error: false
  
  code-quality-gates:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Validate update appcasts (if present)
        shell: bash
        run: |
          MACOS_APPCAST="updates/macos/stable/appcast.xml"
          WINDOWS_APPCAST="updates/windows/stable/appcast.xml"
          
          args=()
          if [ -f "$MACOS_APPCAST" ]; then
            args+=(--macos "$MACOS_APPCAST")
          fi
          if [ -f "$WINDOWS_APPCAST" ]; then
            args+=(--windows "$WINDOWS_APPCAST")
          fi
          
          if [ ${#args[@]} -eq 0 ]; then
            echo "No update appcasts found in repo; skipping validate_updates.py"
            exit 0
          fi
          
          python scripts/validate_updates.py "${args[@]}"
      
      - name: Run linter
        run: |
          ruff check SRC/ || echo "Linting issues found"
        continue-on-error: false
      
      - name: Run type checker
        run: |
          mypy SRC/cuepoint || echo "Type checking issues found"
        continue-on-error: false
      
      - name: Check code formatting
        run: |
          ruff format --check SRC/ || echo "Formatting issues found"
        continue-on-error: false
      
      - name: Check file sizes
        run: |
          python scripts/check_file_sizes.py
        continue-on-error: false

      - name: Run release readiness check
        run: |
          python scripts/release_readiness.py
        continue-on-error: false

      - name: Check performance (if metrics available)
        run: |
          python scripts/check_performance.py
        continue-on-error: true
  
  build-gates:
    name: Build Gates
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Build application
        run: |
          python build.py || echo "Build script not found - skipping"
        continue-on-error: true
      
      - name: Verify build artifacts
        run: |
          python scripts/verify_artifacts.py || echo "No artifacts to verify"
        continue-on-error: true
      
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-${{ matrix.os }}
          path: dist/
          retention-days: 7
          if-no-files-found: ignore

