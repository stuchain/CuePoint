name: Build Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-build.txt
          pip install pyinstaller

      - name: Generate third-party licenses file
        run: |
          python scripts/generate_licenses.py --output THIRD_PARTY_LICENSES.txt
      
      - name: Install NSIS
        run: |
          choco install nsis -y
          # Refresh PATH to include NSIS
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          # Verify NSIS installation
          $nsisPath = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"
          if (Test-Path $nsisPath) {
            Write-Host "NSIS found at: $nsisPath"
          } else {
            Write-Host "NSIS not found at expected path, checking PATH..."
            $makensis = Get-Command makensis -ErrorAction SilentlyContinue
            if ($makensis) {
              Write-Host "makensis found at: $($makensis.Path)"
            } else {
              Write-Error "makensis not found in PATH"
            }
          }
      
      - name: Set build info
        run: python scripts/set_build_info.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ID: ${{ github.run_id }}
      
      - name: Generate version info
        run: python scripts/generate_version_info.py
      
      - name: Validate version
        run: python scripts/validate_version.py
      
      - name: Build with PyInstaller
        run: |
          python scripts/build_pyinstaller.py
      
      - name: Import certificate
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          WINDOWS_CERT_PFX: ${{ secrets.WINDOWS_CERT_PFX }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          if (-not $env:WINDOWS_CERT_PFX -or -not $env:WINDOWS_CERT_PASSWORD) {
            Write-Host "Skipping certificate import: secrets not available"
            exit 0
          }
          $certBytes = [System.Convert]::FromBase64String($env:WINDOWS_CERT_PFX)
          $certPath = "cert.pfx"
          [System.IO.File]::WriteAllBytes($certPath, $certBytes)
          Write-Host "Certificate imported to: $certPath"
      
      - name: Sign executable
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          WINDOWS_CERT_PFX: ${{ secrets.WINDOWS_CERT_PFX }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          if (-not $env:WINDOWS_CERT_PFX -or -not $env:WINDOWS_CERT_PASSWORD) {
            Write-Host "Skipping executable signing: secrets not available"
            exit 0
          }
          $certPath = "cert.pfx"
          signtool sign /f $certPath /p "$env:WINDOWS_CERT_PASSWORD" /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 dist/CuePoint.exe
          signtool verify /pa /v dist/CuePoint.exe
      
      - name: Build installer
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Verify PyInstaller build completed successfully
          $exeFound = $false
          if (Test-Path "dist\CuePoint.exe") {
              Write-Host "Found CuePoint.exe in dist/ (onefile mode)"
              $exeFound = $true
          } elseif (Test-Path "dist\CuePoint\CuePoint.exe") {
              Write-Host "Found CuePoint.exe in dist/CuePoint/ (onedir mode)"
              $exeFound = $true
          }
          
          if (-not $exeFound) {
              Write-Error "CuePoint.exe not found in dist/ or dist/CuePoint/"
              Write-Host "Contents of dist/:"
              Get-ChildItem dist\ -ErrorAction SilentlyContinue | Format-Table Name, Length
              exit 1
          }
          
          $version = python -c "import sys; sys.path.insert(0, 'SRC'); from cuepoint.version import __version__; print(__version__)"
          # Try to find makensis in common locations or PATH
          $makensis = $null
          $possiblePaths = @(
            "${env:ProgramFiles(x86)}\NSIS\makensis.exe",
            "${env:ProgramFiles}\NSIS\makensis.exe",
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $makensis = $path
              Write-Host "Found makensis at: $path"
              break
            }
          }
          if (-not $makensis) {
            $makensisCmd = Get-Command makensis -ErrorAction SilentlyContinue
            if ($makensisCmd) {
              $makensis = $makensisCmd.Path
              Write-Host "Found makensis in PATH at: $makensis"
            }
          }
          if (-not $makensis) {
            Write-Error "makensis not found. Please ensure NSIS is installed."
            exit 1
          }
          & $makensis /DVERSION=$version scripts/installer.nsi
      
      - name: Sign installer
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          WINDOWS_CERT_PFX: ${{ secrets.WINDOWS_CERT_PFX }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          if (-not $env:WINDOWS_CERT_PFX -or -not $env:WINDOWS_CERT_PASSWORD) {
            Write-Host "Skipping installer signing: secrets not available"
            exit 0
          }
          $certPath = "cert.pfx"
          $installer = Get-ChildItem dist\CuePoint-v*-setup.exe | Select-Object -First 1
          signtool sign /f $certPath /p "$env:WINDOWS_CERT_PASSWORD" /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 "$installer"
          signtool verify /pa /v "$installer"
      
      - name: Verify version embedding
        run: python scripts/verify_version_embedding.py
      
      - name: Verify installer exists before upload
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          $installerCount = (Get-ChildItem dist\*-setup.exe -ErrorAction SilentlyContinue).Count
          if ($installerCount -eq 0) {
            Write-Error "No installer files found in dist/"
            Get-ChildItem dist\ -ErrorAction SilentlyContinue | Format-Table
            exit 1
          }
          Write-Host "Found $installerCount installer file(s):"
          Get-ChildItem dist\*-setup.exe | Format-Table Name, Length
      
      - name: Upload artifact
        if: startsWith(github.ref, 'refs/tags/v')
        id: upload_installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*-setup.exe
          retention-days: 30
          if-no-files-found: error
      
      - name: Verify artifact upload
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          if ("${{ steps.upload_installer.outcome }}" -ne "success") {
            Write-Error "Artifact upload failed"
            exit 1
          }
          Write-Host "Artifact uploaded successfully"
