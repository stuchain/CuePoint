name: Build macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          echo "=== DEBUG: Installing dependencies ==="
          echo "Python version:"
          python --version
          echo "Pip version:"
          python -m pip --version
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          
          echo "Installing build requirements from requirements-build.txt..."
          echo "This includes all runtime dependencies needed by the GUI app:"
          echo "  - PySide6 (GUI framework)"
          echo "  - requests, aiohttp (HTTP)"
          echo "  - beautifulsoup4 (HTML parsing)"
          echo "  - ddgs (DuckDuckGo search)"
          echo "  - rapidfuzz (fuzzy matching)"
          echo "  - python-dateutil (date parsing)"
          echo "  - pyyaml (YAML config)"
          echo "  - tqdm (progress bars)"
          echo "  - requests-cache (HTTP caching)"
          echo "  - playwright (browser automation)"
          echo "  - selenium (alternative browser automation)"
          echo "  - openpyxl (Excel export)"
          
          pip install -r requirements-build.txt
          
          echo "Installing PyInstaller (build tool)..."
          pip install pyinstaller
          
          echo "Installing Playwright browsers (for testing, not bundled)..."
          python -m playwright install chromium
          
          echo "Verifying installed packages match requirements.txt runtime dependencies..."
          echo "Core packages:"
          pip list | grep -E "PySide6|requests|aiohttp|beautifulsoup4|ddgs|rapidfuzz|dateutil|pyyaml|tqdm|requests-cache|playwright|selenium|openpyxl|pyinstaller"
          
          echo "Checking for missing dependencies..."
          required=("PySide6" "requests" "aiohttp" "beautifulsoup4" "ddgs" "rapidfuzz" "python-dateutil" "pyyaml" "tqdm" "requests-cache" "playwright" "selenium" "openpyxl")
          installed=$(pip list --format=json | python -c "import sys, json; packages = [p['name'].lower() for p in json.load(sys.stdin)]; print(' '.join(packages))")
          missing=()
          for pkg in "${required[@]}"; do
              if ! echo "$installed" | grep -qi "^${pkg,,}$"; then
                  missing+=("$pkg")
              fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
              echo "⚠️  Warning: Missing packages: ${missing[*]}"
          else
              echo "✅ All required runtime dependencies are installed"
          fi

      - name: Generate third-party licenses file
        run: |
          python scripts/generate_licenses.py --output THIRD_PARTY_LICENSES.txt
      
      - name: Set build info
        run: python scripts/set_build_info.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ID: ${{ github.run_id }}
      
      - name: Sync version from git tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "Syncing version.py from git tag: ${{ github.ref_name }}"
          python scripts/sync_version.py --tag ${{ github.ref_name }}
        continue-on-error: false
      
      - name: Process Info.plist
        run: python scripts/process_info_plist.py
      
      - name: Validate version
        run: python scripts/validate_version.py
      
      - name: Build with PyInstaller
        run: |
          python scripts/build_pyinstaller.py
      
      - name: Import signing certificate
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_SIGNING_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}
        run: |
          if [ -z "$MACOS_CERT_P12" ] || [ -z "$MACOS_CERT_PASSWORD" ]; then
            echo "Skipping certificate import: secrets not available"
            exit 0
          fi
          # Create keychain
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          echo "$MACOS_CERT_P12" | base64 --decode > cert.p12
          security import cert.p12 -k build.keychain -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          
          # Clean up certificate file
          rm -f cert.p12
      
      - name: Sign app
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          if [ -z "$APPLE_DEVELOPER_ID" ]; then
            echo "Skipping app signing: APPLE_DEVELOPER_ID not available"
            exit 0
          fi
          bash scripts/sign_macos.sh dist/CuePoint.app
      
      - name: Create DMG
        if: startsWith(github.ref, 'refs/tags/v')
        id: create_dmg
        run: |
          echo "=== DEBUG: Creating DMG ==="
          echo "Current directory: $(pwd)"
          echo "Checking for existing DMG files..."
          ls -la dist/*.dmg 2>/dev/null || echo "No existing DMG files found"
          
          echo "Checking for mounted volumes..."
          hdiutil info | grep -A 5 "CuePoint" || echo "No CuePoint volumes mounted"
          
          echo "Cleaning up any existing mounts..."
          # Unmount any existing CuePoint volumes
          for vol in $(hdiutil info | grep -i "cuepoint" | awk '{print $1}' || true); do
            echo "Unmounting volume: $vol"
            hdiutil detach "$vol" -force 2>/dev/null || true
          done
          sleep 2
          
          VERSION=$(python -c "import sys; sys.path.insert(0, 'SRC'); from cuepoint.version import __version__; print(__version__)")
          echo "Version: $VERSION"
          echo "Running: bash scripts/create_dmg.sh \"$VERSION\""
          bash scripts/create_dmg.sh "$VERSION"
          
          # Verify DMG was created
          echo "Verifying DMG was created..."
          DMG_FILE=$(ls dist/CuePoint-v*.dmg 2>/dev/null | head -1)
          if [ -z "$DMG_FILE" ]; then
            echo "Error: DMG file not found after creation"
            echo "Contents of dist/:"
            ls -la dist/ || true
            exit 1
          fi
          echo "DMG created: $DMG_FILE"
          echo "DMG size: $(ls -lh "$DMG_FILE" | awk '{print $5}')"
          echo "dmg_file=$DMG_FILE" >> $GITHUB_OUTPUT
      
      - name: Notarize DMG
        if: startsWith(github.ref, 'refs/tags/v') && steps.create_dmg.outcome == 'success'
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_NOTARYTOOL_ISSUER_ID: ${{ secrets.APPLE_NOTARYTOOL_ISSUER_ID }}
          APPLE_NOTARYTOOL_KEY_ID: ${{ secrets.APPLE_NOTARYTOOL_KEY_ID }}
          APPLE_NOTARYTOOL_KEY: ${{ secrets.APPLE_NOTARYTOOL_KEY }}
        run: |
          if [ -z "$APPLE_NOTARYTOOL_ISSUER_ID" ] || [ -z "$APPLE_NOTARYTOOL_KEY_ID" ] || [ -z "$APPLE_NOTARYTOOL_KEY" ]; then
            echo "Skipping notarization: secrets not available"
            exit 0
          fi
          DMG_FILE=$(ls dist/CuePoint-v*.dmg | head -1)
          bash scripts/notarize_macos.sh "$DMG_FILE"
      
      - name: Verify version embedding
        run: python scripts/verify_version_embedding.py
      
      - name: Verify DMG exists before upload
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          DMG_COUNT=$(ls dist/*.dmg 2>/dev/null | wc -l | tr -d ' ')
          if [ "$DMG_COUNT" -eq 0 ]; then
            echo "Error: No DMG files found in dist/"
            ls -la dist/ || true
            exit 1
          fi
          echo "Found $DMG_COUNT DMG file(s):"
          ls -lh dist/*.dmg
      
      - name: Upload artifact
        if: startsWith(github.ref, 'refs/tags/v')
        id: upload_dmg
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg
          retention-days: 30
          if-no-files-found: error
      
      - name: Verify artifact upload
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          if [ "${{ steps.upload_dmg.outcome }}" != "success" ]; then
            echo "Error: Artifact upload failed"
            exit 1
          fi
          echo "Artifact uploaded successfully"
